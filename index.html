<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Haunted Quiz Manor</title>
  <meta name="theme-color" content="#07070a" />
  <style>
  :root{
    --panel: rgba(20,20,28,.65);
    --border: rgba(255,255,255,.12);
    --text:#fff;
    --muted:rgba(255,255,255,.8);
    --accent:#f97316;
    --bg:#0a0a12;
  }

  html, body{
    height:100%;
    width:100%;
    margin:0;
    background:var(--bg);
    color:var(--text);
    font-family:system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Arial;
    overflow:hidden; /* kein Doppel-Scrollen */
  }

  /* Vollbild-Hintergrund sichtbar machen */
  #bg-img{
    position:fixed;
    inset:0;
    width:100%;
    height:100%;
    object-fit:cover;
    filter:blur(6px) brightness(.95) saturate(1.05);
    transform:scale(1.02);
    z-index:0;
    opacity:0;
    transition:opacity .6s ease;
  }

  /* Scrollbarer Inhaltsbereich */
  .stage{
    position:relative;
    z-index:1;
    height:100%;
    overflow-y:auto;
    -webkit-overflow-scrolling:touch;
    scroll-behavior:smooth;
  }

  /* Overlays nur als leichte Vignette hinter dem Inhalt */
  .stage::before{
    content:"";
    position:fixed;
    inset:0;
    background: radial-gradient(160% 80% at 50% 8%, rgba(0,0,0,.10), rgba(0,0,0,.28));
    opacity:.85;
    z-index:1;
    pointer-events:none;
  }
  .stage::after{
    content:"";
    position:fixed;
    inset:0;
    background:
      radial-gradient(80% 50% at 50% 12%, rgba(0,0,0,.06), transparent),
      radial-gradient(60% 40% at 50% 100%, rgba(0,0,0,.05), transparent),
      linear-gradient(180deg, rgba(0,0,0,.12), rgba(0,0,0,.22));
    opacity:.9;
    z-index:1;
    pointer-events:none;
  }

  /* dezente Körnung, ebenfalls hinter dem Inhalt */
  .grime{
    position:fixed;
    inset:0;
    z-index:2;
    pointer-events:none;
    background-image:
      radial-gradient(1px 1px at 20% 30%, rgba(255,255,255,.05), transparent),
      radial-gradient(1px 1px at 80% 60%, rgba(0,0,0,.2), transparent),
      radial-gradient(2px 1px at 60% 10%, rgba(255,255,255,.03), transparent),
      repeating-linear-gradient(0deg, rgba(0,0,0,.05) 0 2px, transparent 2px 4px);
    opacity:.45;
  }

  /* Inhalt oben starten und immer sichtbar bleiben */
  .wrap{
    box-sizing:border-box;
    max-width:1040px;
    margin:0 auto;
    padding:24px 16px 72px; /* unten etwas Luft */
    position:relative;
    z-index:10;
    min-height:100%;
  }

  .title{ font-size:30px; font-weight:900; margin:0 0 6px; letter-spacing:.5px; text-shadow:0 2px 20px rgba(255,120,0,.18); }
  .subtitle{ color:var(--muted); margin:0 0 8px; }

  /* eine saubere, einmalige Panel-Definition ohne Schleier */
  .panel{
    position:relative;
    z-index:11;
    width:100%;
    max-width:100%;
    background: rgba(22,22,28,.92);
    border: 1px solid rgba(255,255,255,.10);
    border-radius:20px;
    box-shadow: inset 0 1px 0 rgba(255,255,255,.04), 0 18px 36px rgba(0,0,0,.35);
    overflow:visible;
    padding:20px;
  }

  .btn{ padding:16px 18px; min-height:64px; border-radius:14px; font-weight:750; background:rgba(255,255,255,.08); color:#fff; border:1px solid var(--border); cursor:pointer; transition: transform .06s ease, background .2s; }
  .btn:hover{ background:rgba(255,255,255,.12); }
  .btn:active{ transform: scale(.98); }
  .btn.primary{ background:linear-gradient(180deg, rgba(249,115,22,.95), rgba(204,64,0,.95)); border:0; box-shadow:0 10px 24px rgba(249,115,22,.25); }

  .row{ display:flex; gap:12px; }
  .grow{ flex:1 1 auto; }
  .grid{ display:grid; gap:14px; }
  .answers{ grid-template-columns: repeat(2, minmax(220px, 1fr)); }

  .hdr{ display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
  .hdr .badge{ font-size:.85rem; color:var(--muted); }
  input{ width:100%; border-radius:12px; border:1px solid var(--border); background:rgba(255,255,255,.08); color:#fff; padding:12px 14px; outline:none; }
  .mono{ font-variant-numeric: tabular-nums; }
  .err{ position:fixed; left:12px; right:12px; bottom:12px; padding:10px; border-radius:12px; background:rgba(220,38,38,.15); border:1px solid rgba(220,38,38,.45); color:#fff; z-index:9999; }
  .spacer{ height:10px; }

  /* Handy-Optimierung */
  @media (max-width:700px){
    .title{ font-size:22px; }
    .subtitle{ font-size:.95rem; }
    .btn{ min-height:52px; font-size:.95rem; padding:12px 14px; }
    .grid.answers{ grid-template-columns: 1fr; }
    .wrap{ padding:20px 12px 96px; }
  }
</style>


  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore-compat.js"></script>
</head>
<body>
  <img id="bg-img" alt="Hintergrund" />
  <div class="stage">
    <div class="grime"></div>
    <div id="app" class="wrap"></div>
  </div>

<script>
"use strict";

// Fehlerbox
window.addEventListener('error', function(e){
  var b=document.createElement('div');
  b.className='err';
  b.textContent='Scriptfehler: '+(e.message||'unbekannt');
  document.body.appendChild(b);
});

// Assets
var ASSETS = {
  bgCandidates: [
    'kkk.jpeg','kkk.jpg','./kkk.jpeg','./kkk.jpg',
    'https://marketplace.canva.com/EAGz_OLUfWA/1/0/1600w/canva-fondo-virtual-halloween-creativo-negro-y-naranja-vvmDlJ4ve0c.jpg'
  ],
  puzzleCandidates: ['sq.jpeg','sq.jpg','./sq.jpeg','./sq.jpg']
};

// Hintergrund robust laden
(function() {
  const bg = document.getElementById('bg-img');
  const tried = [];
  function showErr(msg){
    const d=document.createElement('div'); d.className='err'; d.textContent=msg; document.body.appendChild(d);
  }
  function next(){
  if(tried.length>=ASSETS.bgCandidates.length){
    showErr('Kein Hintergrund gefunden. Prüfe Dateiname und Ordner.');
    return;
  }
  const url = ASSETS.bgCandidates[tried.length];
  tried.push(url);
  bg.onload = function(){ bg.style.opacity = 1; };
  bg.onerror = function(){ setTimeout(next,0); };
  // nur bei http/https cache-busten
  bg.src = /^https?:/i.test(url) ? (url+'?v='+Date.now()) : url;
}

  next();
})();

// Geräte ID
function uuid(){
  return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,function(c){
    return (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16);
  });
}
var DID_KEY='hqm_device_id';
var DEVICE_ID=localStorage.getItem(DID_KEY);
if(!DEVICE_ID){ DEVICE_ID=uuid(); localStorage.setItem(DID_KEY, DEVICE_ID); }

// Helfer
var $=function(q,el){return (el||document).querySelector(q)};
var $$=function(q,el){return Array.from((el||document).querySelectorAll(q))};
function tfmt(ms){ var s=Math.max(0,Math.round(ms/1000)); var m=Math.floor(s/60); var ss=String(s%60).padStart(2,'0'); return m+':'+ss; }

// State
var State={ player:null, start:0, end:0, score:0, i:0, rooms:[], settings:{q:30, mini:60}, audio:null };

// Local Leaderboard
var LKEY='hqm_lb_v7';
function lbGet(){ try{return JSON.parse(localStorage.getItem(LKEY)||'[]')}catch(e){return []} }
function lbSave(e){
  var a=lbGet();
  a.push(e);
  a.sort(function(x,y){return (y.score-x.score)||(x.time-y.time)});
  localStorage.setItem(LKEY, JSON.stringify(a.slice(0,100)));
}

// Firebase
var FIREBASE_CONFIG={ apiKey: "AIzaSyCB9fyO8mS1pgSZFYJVjcTXGHk9hGQmpU4", authDomain: "geburt-ded5c.firebaseapp.com", projectId: "geburt-ded5c" };
var FB_READY=false; var FB_DB=null; var FB_LAST_ERR='';
function fbInit(){
  try{
    firebase.initializeApp(FIREBASE_CONFIG);
    FB_DB=firebase.firestore();
    firebase.auth().signInAnonymously().then(function(){
      FB_READY=true; updateFbBadge();
    }).catch(function(err){
      FB_LAST_ERR=err&&err.message||'auth'; FB_READY=false; updateFbBadge();
    });
  }catch(e){
    FB_LAST_ERR=e&&e.message||'init'; FB_READY=false; updateFbBadge();
  }
}
function updateFbBadge(){
  var el=document.getElementById('fbStatus');
  if(!el) return;
  if(FB_READY){ el.textContent='Online Sync aktiv'; el.style.color='#c7f9cc'; }
  else { el.textContent='Online Sync aus'+(FB_LAST_ERR?(' · '+FB_LAST_ERR):''); el.style.color='#ffd6a5'; }
}
async function saveOnline(entry){
  if(!FB_READY||!FB_DB) return;
  try{
    await FB_DB.collection('hqm_scores').add({
      name:String(entry.name||'').slice(0,24),
      score:entry.score||0,
      timeMs:entry.time||0,
      startISO:entry.startISO,
      endISO:entry.endISO,
      deviceId:entry.deviceId||'',
      created: firebase.firestore.FieldValue.serverTimestamp()
    });
  }catch(e){
    FB_LAST_ERR=e&&e.message||'write'; updateFbBadge();
  }
}

// Inhalt
var CONTENT=[
  {id:'q1',type:'mcq',title:'Serie und Vorbilder',q:'Aktuell läuft auf Netflix die Serie Monster. Welche ikonische Horrorfigur basiert auf Ed Gein',t:30,opt:['Michael Myers','Jason Voorhees','Leatherface','Freddy Krueger'],ok:2},
  {id:'q2',type:'mcq',title:'iPhone 17 Farben',q:'Welches der aktuellen iPhone 17 Pro Modelle verfärbt sich laut Berichten und verliert seine Farbe',t:30,opt:['Orange','Blau','Silber','Schwarz'],ok:0},
  {id:'q3',type:'mcq',title:'Hier kommt Alex',q:'Auf welchem Film von Stanley Kubrick basiert der Hit der Toten Hosen',t:30,opt:['The Shining','Uhrwerk Orange','Barry Lyndon','Full Metal Jacket'],ok:1},
  {id:'q4',type:'mcq',title:'Found Footage',q:'Welcher Film gilt als Wegbereiter des Found Footage Horrorgenres',t:30,opt:['Paranormal Activity','REC','Cloverfield','The Blair Witch Project'],ok:3},
  // Minispiel 1
  {id:'m1',type:'slide',title:'Zerbrochenes Bild',q:'Schiebe die Teile, bis das Motiv korrekt ist',t:95,size:3},
  
  {id:'q5',type:'mcq',title:'Buchvorlage',q:'Welcher dieser Filme hat keine Buchvorlage',t:30,opt:['Halloween (1978)','Der Exorzist (1973)','Carrie (1976)','Shining (1980)'],ok:0},
  {id:'q6',type:'mcq',title:'Hexenprozesse',q:'Welche amerikanische Stadt ist für die meisten Hinrichtungen während der Hexenverfolgung bekannt',t:30,opt:['Boston','Fairfield','Salem','Hartford'],ok:2},
  {id:'q7',type:'mcq',title:'Son of Sam',q:'1976 wütete Sam in New York. Welches angebliche Wesen trieb ihn laut eigener Aussage an',t:30,opt:['Ein Dämon im Spiegel','Ein sprechender Hund des Nachbarn','Eine Stimme aus dem Radio','Ein toter Verwandter'],ok:1},
  {id:'q8',type:'mcq',title:'Serienmörder',q:'Wer war der Kannibale von Milwaukee',t:30,opt:['Jeffrey Dahmer','John Wayne Gacy','Richard Chase','Albert Fish'],ok:0},
  // Minispiel 2
  {id:'m2',type:'memory',title:'Verfluchte Karten',q:'Decke Paare auf. So wenig Fehlversuche wie möglich',pairs:8,t:60},
  
  {id:'q9',type:'mcq',title:'Phobien',q:'Was ist der lateinische Begriff für die Angst vor Spinnen',t:30,opt:['Anthophobie','Astraphobie','Arachnophobie','Siderodromophobie'],ok:2},
  {id:'q10',type:'mcq',title:'Schlafparalyse',q:'Was passiert bei Sleep Paralysis',t:30,opt:['Man verlässt den Körper für kurze Zeit','Man wacht auf, kann sich nicht bewegen und sieht Gestalten','Man hat lebhafte Tagträume im Halbschlaf','Man hört Stimmen ohne etwas zu sehen'],ok:1},
  {id:'q11',type:'mcq',title:'Mexiko Fest',q:'Wie heißt das Fest in Mexiko, bei dem die Toten geehrt werden',t:30,opt:['Día de los Muertos','Día muerto','Muerto de trabajo','Muerto de aburrimiento'],ok:0},
  {id:'q12',type:'mcq',title:'Ghost Hunters',q:'In welcher Gemeinde im Kanton Aargau findest du die Ghost Hunters',t:30,opt:['Pratteln','Stein','Rheinfelden','Safenwil'],ok:3},
  // Minispiel 3
  {id:'m8',type:'layout',title:'Der Spukhaus-Grundriss',q:'Finde die Symbole basierend auf den Zahlen-Hinweisen.',t:120,size:4,symbols:['👻','🕯️','🕳️']},
  
  {id:'q13',type:'mcq',title:'Klaustrophobie',q:'Bei der Klaustrophobie handelt es sich um die Angst vor',t:30,opt:['Angst vor dem Weihnachtsmann','Menschen mit dem Namen Klaus','Angst vor dem Alleinsein','Angst vor Enge und engen Räumen'],ok:3},
  {id:'q14',type:'mcq',title:'Forschung',q:'Wie nennt man die wissenschaftliche Erforschung angeblich paranormaler Phänomene',t:30,opt:['Kryptozoologie','Parapsychologie','Thanatologie','Esoterik'],ok:1},
  {id:'q15',type:'mcq',title:'Creepypasta',q:'Welche Figur entstand aus einem Photoshop Wettbewerb und wurde Symbol moderner Internet Legenden',t:30,opt:['Jeff the Killer','The Rake','Slender Man','BEN Drowned'],ok:2},
  // Neue Fragen (q16, q17, q18)
  {id:'q16',type:'mcq',title:'Regie-Klassiker',q:'Wer ist der Regisseur des Kultfilms *The Exorcist* (1973), der als einer der besten Horrorfilme aller Zeiten gilt?',t:30,opt:['John Carpenter','Wes Craven','William Friedkin','Dario Argento'],ok:2},
  // Minispiel 4
  {id:'m9',type:'spot',title:'Fluch der ungleichen Karten',q:'Finde das Symbol, das sich leicht von den anderen unterscheidet. Schnelligkeit zählt!',t:45,gridSize:6,baseIcon:'💀',diffIcon:'☠️',maxRounds:10},
  
  {id:'q17',type:'mcq',title:'Paranormale Phänomene',q:'Welches Element ist typisch für die Geistererscheinungen im Film *Poltergeist* (1982)?',t:30,opt:['Ein alter Spiegel','Das Telefon klingelt unaufhörlich','Fernseh-Störsignal/Statik','Ein singendes Spielzeug'],ok:2},
  {id:'q18',type:'mcq',title:'Conjuring Universum',q:'Wie heißt die Puppe in der *Conjuring* Universum, die auf einer echten Stoffpuppe basiert, welche angeblich besessen ist?',t:30,opt:['Chucky','Annabelle','Billy','Fiona'],ok:1}
];

// Views
function header(title){
  return '<div class="hdr"><span class="badge">Frage '+(State.i+1)+' von '+State.rooms.length+'</span><span class="badge mono">Punkte '+State.score+'</span></div><h2 class="title">'+title+'</h2>';
}
function viewIntro(){
  return '<h1 class="title">Haunted Quiz Manor</h1><p class="subtitle">Achtzehn Fragen und vier Minispiele. Unheimliche Stimmung. Punkte und Zeit entscheiden.</p><div class="spacer"></div><div class="panel"><label class="subtitle" for="name">Name für das Leaderboard</label><input id="name" placeholder="Nur vollständige Namen werden zur Wertung aufgenommen" /><div class="spacer"></div><div class="row"><button class="btn primary grow" id="start">Start</button><button class="btn" id="lb">Leaderboard</button></div><div class="row" style="justify-content:space-between;margin-top:8px"><div id="fbStatus" class="subtitle" style="font-size:.8rem">Online Sync aus</div><div class="subtitle" style="font-size:.8rem">Sound startet nach Start</div></div></div>';
}
function mountIntro(){
  $('#start').onclick=function(){
    State.player=($('#name').value||'').trim()||'Unbekannt';
    State.rooms=CONTENT.slice();
    State.i=0; State.score=0; State.start=Date.now();
    startAmbience();
    go();
  };
  $('#lb').onclick=function(){ render(viewLB()); mountLB(); };
  updateFbBadge();
}
function viewLB(){
  return '<h2 class="title">Leaderboard</h2>'+
    '<div class="panel" id="lbPanel"><div class="subtitle">Lade Einträge…</div></div>'+
    '<div class="spacer"></div><button class="btn" id="back">Zurück</button>';
}

function mountLB(){
  document.getElementById('back').onclick=function(){
    render(viewIntro());
    mountIntro();
  };

  if (FB_READY && FB_DB){
    FB_DB.collection('hqm_scores')
      .orderBy('score', 'desc')
      .limit(50)
      .onSnapshot(function(snap){
        var rows = [];
        snap.forEach(function(doc){ rows.push(doc.data()); });
        rows.sort(function(a,b){
          return (b.score - a.score) || ((a.timeMs||0) - (b.timeMs||0));
        });
        renderLBList(rows);
      }, function(err){
        renderLBList(lbGet());
      });
  } else {
    renderLBList(lbGet());
  }
}

function renderLBList(list){
  var el = document.getElementById('lbPanel');
  if(!el) return;
  if(!list || !list.length){
    el.innerHTML = '<div class="subtitle">Noch keine Einträge</div>';
    return;
  }
  var html = list.map(function(x,i){
    var name = x.name || 'Unbekannt';
    var score = x.score || 0;
    var t = x.timeMs || x.time || 0;
    return '<div class="row" style="justify-content:space-between;border-bottom:1px solid var(--border);padding:6px 0">'+
      '<b>'+(i+1)+'.</b><span>'+name+'</span><span class="mono">'+score+'</span><span class="mono">'+tfmt(t)+'</span></div>';
  }).join('');
  el.innerHTML = html;
}




function go(){
  if(State.i>=State.rooms.length){
    State.end=Date.now();
    render(viewResult());
    mountResult();
    return;
  }
  var r=State.rooms[State.i];
  if(r.type==='mcq'){ render(viewMCQ(r)); mountMCQ(r); return; }
  if(r.type==='slide'){ render(viewSlide(r)); mountSlide(r); return; }
  if(r.type==='memory'){ render(viewMemory(r)); mountMemory(r); return; }
  if(r.type==='layout'){ render(viewLayout(r)); mountLayout(r); return; }
  if(r.type==='spot'){ render(viewSpot(r)); mountSpot(r); return; }
}

function viewMCQ(r){
  var t=r.t||State.settings.q;
  var opts=r.opt.map(function(o,i){ return '<button class="btn" data-i="'+i+'">'+o+'</button>'; }).join('');
  return header(r.title)+
    '<p class="subtitle">'+r.q+'</p>'+
    '<div class="panel" style="display:flex;justify-content:space-between;align-items:center"><span class="subtitle" style="font-size:.95rem">Wähle eine Antwort</span><span id="tt" class="mono">'+t+'</span></div>'+
    '<div class="grid answers" id="opts">'+opts+'</div>';
}
function mountMCQ(r){
  var t=r.t||State.settings.q;
  var tid=setInterval(function(){
    t--; var el=$('#tt'); if(el) el.textContent=t; if(t<=0){ clearInterval(tid); wrong(); }
  },1000);
  $$('#opts .btn').forEach(function(b){
    b.onclick=function(){
      clearInterval(tid);
      var i=Number(b.getAttribute('data-i'));
      if(i===r.ok){ State.score+=120; pulseScore(); } else { State.score-=15; }
      State.i++; go();
    };
  });
  function wrong(){ State.score-=20; State.i++; go(); }
}

/* Schiebepuzzle mit korrekter Click-Skalierung und +15s */
function viewSlide(r){
  var t = (r.t || State.settings.mini) + 15;
  r._timeBoost = 15;
  return header(r.title) +
    '<p class="subtitle">'+r.q+'</p>' +
    '<div class="panel" style="max-width:520px;margin:0 auto;">' + // MAX WIDTH FIX
      '<canvas id="cv" style="width:100%;max-width:520px;height:auto;border-radius:14px"></canvas>' +
      '<div class="row" style="justify-content:space-between;margin-top:8px">' +
        '<span class="subtitle" style="font-size:.9rem">Schiebe Teile neben die Lücke</span>' +
        '<span id="tt" class="mono">'+t+'</span>' +
      '</div>' +
    '</div>';
}
function mountSlide(r){
  var size=r.size||3;
  var cv=$('#cv');
  var cx=cv.getContext('2d');
  var DPR=Math.max(1, window.devicePixelRatio||1);
  var cssSize=420, W=Math.round(cssSize*DPR);
  cv.width=W; cv.height=W;
  cv.style.width='100%'; cv.style.maxWidth=cssSize+'px'; cv.style.height='auto';

  var img=new Image();
  var board=[], empty=size*size-1;
  var t=(r.t||State.settings.mini)+(r._timeBoost||0);
  var tid=null;

  function useSVG(){ img.onload=init; img.src='data:image/svg+xml;utf8,'+encodeURIComponent(svgPumpkin()); }
  function loadPuzzle(){
    var candidates=[]; if(r.img) candidates.push(r.img);
    candidates=candidates.concat(ASSETS.puzzleCandidates);
    var i=0; function tryNext(){
      if(i>=candidates.length){ useSVG(); return; }
      var url=candidates[i++]; img.onload=init; img.onerror=tryNext; img.src=url+'?v='+Date.now();
    } tryNext();
  }
  loadPuzzle();

  function init(){
    for(var i=0;i<size*size;i++) board[i]=i;
    for(var k=0;k<220;k++){ var n=neigh(empty); var pick=n[Math.floor(Math.random()*n.length)]; swap(pick,empty); empty=pick; }
    draw();
    cv.addEventListener('pointerup', click);
    tid=setInterval(function(){ t--; var el=$('#tt'); if(el) el.textContent=t; if(t<=0){ clearInterval(tid); fail(); } },1000);
  }
  function neigh(idx){ var x=idx%size, y=Math.floor(idx/size), a=[]; if(x>0)a.push(idx-1); if(x<size-1)a.push(idx+1); if(y>0)a.push(idx-size); if(y<size-1)a.push(idx+size); return a; }
  function swap(a,b){ var tmp=board[a]; board[a]=board[b]; board[b]=tmp; }
  function draw(){
    var w=cv.width, h=cv.height, tw=Math.floor(w/size), th=Math.floor(h/size);
    var iw=img.width, ih=img.height, sx0=0, sy0=0, sqSize=0;
    if(iw>ih){ sqSize=ih; sx0=Math.floor((iw-ih)/2); } else { sqSize=iw; sy0=Math.floor((ih-iw)/2); }
    var sw=Math.floor(sqSize/size), sh=sw;
    cx.fillStyle='#0b0b10'; cx.fillRect(0,0,w,h);
    for(var i=0;i<board.length;i++){
      var col=board[i]%size, row=Math.floor(board[i]/size);
      var sx=sx0+col*sw, sy=sy0+row*sh;
      var dx=(i%size)*tw, dy=Math.floor(i/size)*th;
      if(i===empty){ cx.fillStyle='#111319'; cx.fillRect(dx,dy,tw,th); continue; }
      cx.drawImage(img, sx, sy, sw, sh, dx, dy, tw-1, th-1);
    }
  }
  function click(ev){
    var rect=cv.getBoundingClientRect();
    var x=(ev.clientX-rect.left)*(cv.width/rect.width);
    var y=(ev.clientY-rect.top)*(cv.height/rect.height);
    var tw=Math.floor(cv.width/size), th=Math.floor(cv.height/size);
    var col=Math.floor(x/tw), row=Math.floor(y/th), idx=row*size+col;
    if(neigh(empty).includes(idx)){ swap(idx,empty); empty=idx; draw(); check(); }
  }
  function check(){ 
    for(var i=0;i<board.length;i++){ 
      if(board[i]!==i) return; 
    } 
    clearInterval(tid); 
    State.score+=160; 
    pulseScore(); 
    State.i++; 
    go(); // Bug Fix: transition now relies fully on go()
  }
  function fail(){ State.score-=25; State.i++; go(); }
  function svgPumpkin(){ return `<svg xmlns='http://www.w3.org/2000/svg' width='420' height='420'><defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'><stop offset='0%' stop-color='#2a2a44'/><stop offset='100%' stop-color='#0a0a12'/></linearGradient></defs><rect width='100%' height='100%' fill='url(#g)'/><g fill='white' opacity='0.9'><circle cx='140' cy='150' r='14'/><circle cx='300' cy='170' r='14'/><path d='M90 320 C 180 350, 240 350, 330 320' stroke='white' stroke-width='3' fill='none' /><text x='50%' y='50%' text-anchor='middle' fill='white' font-size='40' font-family='Georgia'>🎃</text></g></svg>`; }
}

/* Memory Minigame */
function viewMemory(r){
  var t=r.t||60;
  return header(r.title)+
    '<p class="subtitle">'+r.q+'</p>'+
    '<div class="panel" style="max-width:520px;margin:0 auto;">'+ // MAX WIDTH FIX
      '<div class="row" style="justify-content:space-between;margin-bottom:8px">'+
        '<span class="subtitle">Zeit</span><span id="tt" class="mono">'+t+'</span>'+
      '</div>'+
      '<div id="mem" class="grid" style="grid-template-columns:repeat(4,1fr); gap:10px"></div>'+
    '</div>';
}
function mountMemory(r){
  var icons=['🎃','👻','🕯️','🕷️','🦇','💀','🧪','🕸️'];
  var pairs=r.pairs||8;
  var pool=icons.slice(0,pairs);
  var deck=pool.concat(pool).map(function(v,i){ return {id:i,val:v,open:false,done:false}; });
  for(var i=deck.length-1;i>0;i--){ var j=Math.floor(Math.random()*(i+1)); var t=deck[i]; deck[i]=deck[j]; deck[j]=t; }

  var el=document.getElementById('mem');
  var tleft=r.t||60;
  var tid=setInterval(function(){ tleft--; var tt=document.getElementById('tt'); if(tt) tt.textContent=tleft; if(tleft<=0){ clearInterval(tid); fail(); } },1000);
  var sel=[]; draw();

  function draw(){
    el.innerHTML=deck.map(function(c){
      var face=c.open||c.done?c.val:'▦';
      var op=c.done?'opacity:.75':'';
      return '<button class="btn" data-id="'+c.id+'" style="min-height:72px;font-size:28px;'+op+'">'+face+'</button>';
    }).join('');
    Array.from(el.querySelectorAll('button')).forEach(function(b){
      b.onclick=function(){ onFlip(Number(b.getAttribute('data-id'))); };
    });
  }
  function onFlip(id){
    var c=deck.find(function(x){return x.id===id}); if(!c||c.done||c.open) return;
    c.open=true; sel.push(c); draw();
    if(sel.length===2){
      var a=sel[0], b=sel[1];
      if(a.val===b.val){
        a.done=b.done=true; State.score+=20; pulseScore(); sel=[];
        if(deck.every(function(x){return x.done;})){ clearInterval(tid); State.score+=60; State.i++; go(); }
      }else{
        State.score-=5;
        setTimeout(function(){ a.open=b.open=false; sel=[]; draw(); },550);
      }
    }
  }
  function fail(){ State.score-=25; State.i++; go(); }
}


/* NEU: IDEE 8 - Spukhaus-Grundriss (Layout Deduction) */
function viewLayout(r){
  var t=r.t||State.settings.mini;
  var size=r.size||4;
  var gridColumns = '40px repeat('+size+', 1fr)'; // 40px for row hints
  return header(r.title)+
    '<p class="subtitle">'+r.q+'</p>'+
    '<div class="panel" style="max-width:520px;margin:0 auto;">'+ // MAX WIDTH FIX
      '<div class="row" style="justify-content:space-between;margin-bottom:8px">'+
        '<span class="subtitle">Klicke zum Wechsel: 👻 ↔️ 🕯️ ↔️ 🕳️</span><span id="tt" class="mono">'+t+'</span>'+
      '</div>'+
      '<div id="layout-grid-wrap" style="max-width:480px;margin:0 auto;padding-top:4px;">'+ // INNER MAX WIDTH
        // Top Hints (Header for cols)
        '<div id="colHints" style="display:grid;grid-template-columns:'+gridColumns+';height:40px;margin-bottom:4px;font-size:.8rem;color:var(--muted);text-align:center;"></div>'+
        // Main Area
        '<div id="layoutGrid" style="display:grid;grid-template-columns:'+gridColumns+';gap:2px;border:1px solid var(--border)">'+
          // Grid cells will be here
        '</div>'+
      '</div>'+
    '</div>';
}
function mountLayout(r){
  var size=r.size||4;
  var symbols=r.symbols||['👻','🕯️','🕳️'];
  var boardSize=size*size;
  var board=Array(boardSize).fill(0); // 0=empty, 1=sym1, 2=sym2, 3=sym3
  var target=Array(boardSize).fill(0);
  var tleft=r.t||120;
  var tid=null;
  
  var gridEl=$('#layoutGrid');
  var colHintsEl=$('#colHints');
  
  // 1. Muster generieren (lösbares Muster)
  function initTarget(){
    for(var i=0;i<boardSize;i++){
      target[i]=Math.floor(Math.random()*(symbols.length+1)); 
    }
  }
  
  // 2. Hinweise berechnen
  function calculateHints(){
    var hints={row:[],col:[]};
    for(var i=0;i<size;i++){
      var rowHint={}, colHint={};
      for(var j=0;j<size;j++){
        var rowIdx=i*size+j;
        var colIdx=j*size+i;

        // Row hints
        if(target[rowIdx]!==0){
          var sym=symbols[target[rowIdx]-1];
          rowHint[sym]=(rowHint[sym]||0)+1;
        }

        // Col hints
        if(target[colIdx]!==0){
          var sym=symbols[target[colIdx]-1];
          colHint[sym]=(colHint[sym]||0)+1;
        }
      }
      hints.row.push(rowHint);
      hints.col.push(colHint);
    }
    return hints;
  }
  
  // 3. Zeichnen der Hinweise und des Grids
  function draw(){
    // Hints
    var hints=calculateHints();
    var colHintHtml='<div style="grid-column:1;grid-row:1;font-size:12px"></div>';
    colHintsEl.style.gridTemplateColumns='40px repeat('+size+', 1fr)';
    for(var c=0;c<size;c++){
      var cHints=hints.col[c];
      var hintStr=symbols.map(s=>cHints[s]?'<div style="font-size:10px;line-height:10px">'+s+cHints[s]+'</div>':'').join('');
      colHintHtml+='<div style="grid-column:'+(c+2)+';grid-row:1;display:flex;flex-direction:column;justify-content:flex-end;align-items:center;min-height:40px">'+hintStr+'</div>';
    }
    colHintsEl.innerHTML=colHintHtml;


    // Grid
    var gridHtml='';
    for(var r=0;r<size;r++){
      // Row Hint
      var rHints=hints.row[r];
      var hintStr=symbols.map(s=>rHints[s]?'<span style="font-size:10px">'+s+rHints[s]+'</span>':'').join(' ');
      gridHtml+='<div style="grid-column:1;grid-row:'+(r+1)+';display:flex;align-items:center;justify-content:flex-end;padding-right:4px;font-size:.8rem;color:var(--muted)">'+hintStr+'</div>';

      // Cells
      for(var c=0;c<size;c++){
        var i=r*size+c;
        var currentSym=board[i]===0?'':symbols[board[i]-1];
        var bg=board[i]===0?'rgba(255,255,255,.05)':(board[i]===1?'rgba(249,115,22,.2)':(board[i]===2?'rgba(200,200,255,.2)':'rgba(100,255,100,.2)'));
        var color = board[i]===1?'#f97316':(board[i]===2?'#c8c8ff':'#64ff64');
        gridHtml+='<button class="btn" data-id="'+i+'" style="grid-column:'+(c+2)+';grid-row:'+(r+1)+';min-height:40px;padding:0;font-size:24px;background:'+bg+';color:'+color+'">'+currentSym+'</button>';
      }
    }
    gridEl.innerHTML=gridHtml;
    $$('#layoutGrid .btn').forEach(b=>b.onclick=()=>onClick(Number(b.getAttribute('data-id'))));
  }
  
  // 4. Klick-Logik
  function onClick(id){
    board[id]=(board[id]+1)%(symbols.length+1); // Cycle 0 -> 1 -> 2 -> 3 -> 0
    draw();
    checkWin();
  }
  
  // 5. Win-Check
  function checkWin(){
    for(var i=0;i<boardSize;i++){
      if(board[i]!==target[i]) return;
    }
    clearInterval(tid); 
    State.score+=250; 
    State.score+=(tleft*5); // Zeitbonus
    pulseScore(); 
    State.i++; 
    go();
  }
  
  // 6. Init
  initTarget();
  draw();
  tid=setInterval(function(){ 
    tleft--; var el=$('#tt'); 
    if(el) el.textContent=tleft; 
    if(tleft<=0){ clearInterval(tid); fail(); } 
  },1000);

  function fail(){ State.score-=35; State.i++; go(); }
}


/* NEU: IDEE 9 - Fluch der ungleichen Karten (Spot the Odd One Out) */
function viewSpot(r){
  var t=r.t||State.settings.mini;
  return header(r.title)+
    '<p class="subtitle">'+r.q+'</p>'+
    '<div class="panel" style="max-width:520px;margin:0 auto;">'+ // MAX WIDTH FIX
      '<div class="row" style="justify-content:space-between;margin-bottom:8px">'+
        '<span class="subtitle">Runde: <span id="roundCount">1</span> / '+r.maxRounds+'</span><span id="tt" class="mono">'+t+'</span>'+
      '</div>'+
      '<div id="spotGrid" style="display:grid; max-width:480px; margin:0 auto; gap:2px; border:1px solid var(--border)"></div>'+ // INNER MAX WIDTH
    '</div>';
}
function mountSpot(r){
  var size=r.gridSize||6;
  var base=r.baseIcon||'💀';
  var diff=r.diffIcon||'☠️';
  var maxRounds=r.maxRounds||10;
  var currentRound=1;
  var tleft=r.t||45;
  var tid=null;
  var boardSize=size*size;
  var targetId=-1;
  var gridEl=$('#spotGrid');
  
  function initRound(){
    targetId=Math.floor(Math.random()*boardSize);
    gridEl.style.gridTemplateColumns='repeat('+size+', 1fr)';
    
    var html='';
    for(var i=0;i<boardSize;i++){
      var icon=i===targetId?diff:base;
      var isTarget=i===targetId?'data-target="1"':'';
      var bg='rgba(255,255,255,.05)';
      var color = i===targetId?'var(--accent)':'#fff';
      html+='<button class="btn" data-id="'+i+'" '+isTarget+' style="min-height:50px;padding:0;font-size:24px;background:'+bg+';color:'+color+'">'+icon+'</button>';
    }
    gridEl.innerHTML=html;
    $$('#spotGrid .btn').forEach(b=>b.onclick=()=>onClick(b));
    $('#roundCount').textContent=currentRound;
  }

  function onClick(button){
    if(button.getAttribute('data-target')==='1'){
      State.score+=20;
      pulseScore();
      
      currentRound++;
      if(currentRound>maxRounds){
        clearInterval(tid);
        State.score+=(tleft*10); // Großer Bonus für Zeit
        State.i++; go();
        return;
      }
      initRound();
    }else{
      State.score-=5;
      pulseScore();
      tleft=Math.max(0, tleft-3); // Zeitstrafe für falschen Klick
      var tt=$('#tt'); if(tt) tt.textContent=tleft; 
    }
  }

  // Init & Timer
  initRound();
  tid=setInterval(function(){ 
    tleft--; var el=$('#tt'); 
    if(el) el.textContent=tleft; 
    if(tleft<=0){ clearInterval(tid); fail(); } 
  },1000);

  function fail(){ State.score-=20; State.i++; go(); }
}


function viewResult(){
  return '<h2 class="title">Auswertung</h2>'+
    '<div class="panel">'+
    '<div class="row" style="justify-content:space-between"><span>Spieler</span><b>'+State.player+'</b></div>'+
    '<div class="row" style="justify-content:space-between"><span>Gerät</span><b class="mono">'+DEVICE_ID.slice(0,8)+'</b></div>'+
    '<div class="row" style="justify-content:space-between"><span>Punkte</span><b class="mono">'+State.score+'</b></div>'+
    '<div class="row" style="justify-content:space-between"><span>Start</span><b class="mono">'+new Date(State.start).toLocaleString('de-DE')+'</b></div>'+
    '<div class="row" style="justify-content:space-between"><span>Ende</span><b class="mono">'+new Date(State.end).toLocaleString('de-DE')+'</b></div>'+
    '</div>'+
    '<div class="spacer"></div>'+
    '<div class="row"><button class="btn primary grow" id="again">Nochmal</button><button class="btn" id="toLB">Leaderboard</button></div>';
}
function mountResult(){
  var entry = {
  name: State.player,
  score: State.score,
  time: State.end - State.start,   // lokal weiter nutzbar
  timeMs: State.end - State.start, // für Firestore Sortierung
  startISO: new Date(State.start).toISOString(),
  endISO: new Date(State.end).toISOString(),
  deviceId: DEVICE_ID,
  date: new Date().toLocaleString('de-DE')
};
lbSave(entry);
saveOnline(entry);
  $('#again').onclick=function(){ render(viewIntro()); mountIntro(); };
  $('#toLB').onclick=function(){ render(viewLB()); mountLB(); };
}

// Render und Effekte
function render(html){ $('#app').innerHTML=html; }
function pulseScore(){
  var el=document.querySelector('.hdr .mono');
  if(!el) return;
  el.style.transform='scale(1.06)';
  el.style.transition='transform .15s';
  setTimeout(function(){ el.style.transform='scale(1)'; },140);
}

// Ambience
// Ambience
function startAmbience(){
  try{
    var audio = new Audio('ambient.mp3'); // deine Datei im gleichen Ordner
    audio.loop = true;
    audio.volume = 0.3; // Lautstärke
    audio.play();
    State.audio = audio;
  }catch(e){
    console.error('Audio konnte nicht geladen werden:', e);
  }
}

// Boot
render(viewIntro());
mountIntro();
fbInit();
</script>
</body>
</html>
