<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>GAB Adventskalender Premium</title>
<meta name="theme-color" content="#0b0f17"/>
<style>
  :root{
    --bg:url('assets/bg.jpg');
    --glass: rgba(255,255,255,.10);
    --glass-strong: rgba(255,255,255,.22);
    --border: rgba(255,255,255,.18);
    --text:#fff; --muted:#e3e9f7; --gold:#ffd76a;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0; font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:var(--text); background:#0b0f17; display:flex; flex-direction:column; min-height:100vh; overflow-x:hidden}
  
  .bgimg{position:fixed; inset:0; background:#0b0f17 radial-gradient(circle at 50% 0%, #1a253a, #0b0f17); background-image:var(--bg); background-position:center; background-size:cover; filter:blur(2px)}
  
  header{backdrop-filter:blur(10px); background:linear-gradient(180deg, rgba(12,18,28,.85), rgba(12,18,28,.4)); border-bottom:1px solid var(--border); position:sticky; top:0; z-index:10}
  .bar{display:flex; align-items:center; gap:12px; padding:12px 20px}
  
  /* Logo mit Interaktion */
  .logo{width:48px; height:48px; border-radius:14px; position:relative; cursor:pointer; background:conic-gradient(from 0deg, rgba(255,77,90,.45), rgba(255,215,106,.45), rgba(93,216,255,.45), rgba(53,224,122,.45), rgba(255,77,90,.45)); box-shadow:0 0 30px rgba(255,215,106,.25) inset, 0 0 40px rgba(93,216,255,.18) inset; transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);}
  .logo:active{transform: scale(0.9) rotate(-10deg);}
  .logo:hover{transform: scale(1.05);}
  .logo:after{content:"üéÑ"; position:absolute; inset:0; display:grid; place-items:center; font-size:22px}
  
  h1{font-size:22px; letter-spacing:.5px; margin:0} .spacer{flex:1}
  
  .btn{cursor:pointer; border:1px solid var(--border); background:var(--glass); color:var(--text); padding:8px 14px; border-radius:10px; transition:.2s; font-weight:600; font-size: 14px; display: inline-flex; align-items: center; gap: 6px;}
  .btn:hover{background:var(--glass-strong); transform:translateY(-1px)}
  .btn.gold{border-color:rgba(255,215,106,.5); box-shadow:0 0 20px rgba(255,215,106,.25) inset; color: var(--gold)}
  .btn-icon-only{padding: 8px; border-radius: 50%; width: 36px; height: 36px; justify-content: center;}

  .wrap{width:100%; max-width:1200px; margin:0 auto; padding:20px; flex:1 0 auto; position:relative; z-index:3}
  .panel{background:var(--glass); border:1px solid var(--border); border-radius:18px; padding:20px; box-shadow:0 8px 32px rgba(0,0,0,.25); margin-bottom: 20px;}
  
  .auth{max-width:680px; margin:40px auto; text-align:left} .row{display:flex; gap:10px; flex-wrap:wrap}
  .input{flex:1; min-width:220px; padding:12px 14px; border-radius:12px; border:1px solid var(--border); background:rgba(255,255,255,.05); color:#fff}
  label{display:block; margin:8px 0 6px 2px; color:var(--gold); font-weight:600}
  .hint{color:var(--muted); font-size:13px}
  
  /* --- Progress Bar --- */
  .progress-container { margin-bottom: 20px; }
  .progress-labels { display:flex; justify-content:space-between; font-size:13px; color:var(--muted); margin-bottom:6px; }
  .progress-track { height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden; position: relative; }
  .progress-fill { height: 100%; background: linear-gradient(90deg, #5de07a, #35e07a); width: 0%; transition: width 1s cubic-bezier(0.22, 1, 0.36, 1); box-shadow: 0 0 10px rgba(93, 224, 122, 0.5); }

  /* --- Grid Layout (Klassisch & Sauber) --- */
  .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; }
  @media (min-width: 500px) { .grid { grid-template-columns: repeat(3, 1fr); } }
  @media (min-width: 768px) { .grid { grid-template-columns: repeat(4, 1fr); } }
  @media (min-width: 1100px) { .grid { grid-template-columns: repeat(6, 1fr); } }
  
  .door{
    position:relative; height:120px; border-radius:16px; overflow:hidden; cursor:pointer; border:2px solid transparent; 
    background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.03)),
                radial-gradient(circle at 50% 0%, rgba(255,255,255,0.1), transparent 70%);
    display:flex; align-items:center; justify-content:center; 
    font-weight:900; font-size:26px; color:var(--text); text-shadow:0 2px 10px rgba(0,0,0,.35); 
    transition: transform 0.2s, box-shadow 0.2s;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
  }
  
  .door:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.3); }
  .door:active { transform: scale(0.98); }
  
  /* Gesperrt */
  .door.locked{opacity:.6; cursor:not-allowed; border-color:rgba(255,255,255,.04); background: rgba(255,255,255,0.03);}
  
  /* Ge√∂ffnet */
  .door.opened{
    border-color:rgba(93,216,255,.4); 
    background: rgba(0,0,0,0.3); /* Etwas dunkler, damit man sieht "erledigt" */
    box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
  }
  
  .door .badge{position:absolute; top:8px; right:8px; background:rgba(255,215,106,.25); border:1px solid var(--border); padding:2px 8px; border-radius:10px; font-size:11px}
  .door .emoji{position:absolute; left:10px; top:8px; font-size: 18px; opacity: 0.8} 
  .door .num{position:relative; z-index:2; font-size: 32px;}
  
  /* Bild Thumbnail auf ge√∂ffneter T√ºr (optional, dezent im Hintergrund) */
  .door.opened img.thumb{
    position:absolute; inset:0; width:100%; height:100%; object-fit:cover; 
    filter: brightness(0.4) grayscale(0.4); /* Abgedunkelt, Fokus auf Modal */
    z-index: 0; opacity: 0.6;
  }
  .door.opened .num { opacity: 0.5; } /* Nummer tritt in den Hintergrund */

  /* Tag 24 Special */
  .door.day-24 {
    border: 1px solid rgba(255, 215, 106, 0.6);
    background: linear-gradient(135deg, rgba(255, 215, 106, 0.15), rgba(255, 215, 106, 0.02));
  }
  .door.day-24 .num { color: var(--gold); }

  @keyframes shake { 0%, 100% {transform:translateX(0)} 25%{transform:translateX(-4px) rotate(-2deg)} 75%{transform:translateX(4px) rotate(2deg)} }
  .door.shake { animation: shake 0.4s ease-in-out; }

  .footer{padding:20px; text-align:center; color:var(--muted); border-top:1px solid var(--border); font-size: 14px;}
  
  /* Modal */
  .modal-backdrop{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(5,8,12,.85); z-index:50; backdrop-filter: blur(5px);}
  .modal{width:min(720px, 92vw); background:rgba(20,24,35,.95); border:1px solid var(--border); border-radius:24px; overflow:hidden; box-shadow:0 25px 80px rgba(0,0,0,.6); transform: scale(0.95); transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.2s; opacity: 0;}
  .modal.active { transform: scale(1); opacity: 1; }
  .modal .head{display:flex; align-items:center; gap:12px; padding:16px 20px; border-bottom:1px solid var(--border); background: rgba(255,255,255,0.03)} 
  .modal .body{padding:24px}
  
  .reward{display:flex; gap:20px; align-items:flex-start}
  .reward .icon{width:80px; height:80px; border-radius:20px; display:grid; place-items:center; font-size:40px; background:linear-gradient(135deg, rgba(93,216,255,.2), rgba(255,215,106,.2)); border:1px solid var(--border); flex-shrink: 0; box-shadow: 0 10px 30px rgba(0,0,0,0.2)}
  
  .voucher{margin-top:16px; padding:16px; border:1px dashed var(--gold); border-radius:16px; background:rgba(255,215,106,.08)}
  .voucher .line{display:flex; gap:10px; align-items:center; margin-top:8px} .voucher .label{width:120px; color:var(--muted); font-size: 14px;}
  
  .print-area{display:none}
  @media print{ header,.wrap,.footer{display:none} .print-area{display:block; padding:28px; font-family:Inter, Arial, sans-serif} .print-card{border:2px dashed #333; border-radius:12px; padding:20px} }
  
  .toast{position:fixed; bottom:24px; right:24px; background:rgba(25,32,48,.95); color:#fff; border:1px solid var(--border); padding:14px 18px; border-radius:14px; box-shadow:0 10px 40px rgba(0,0,0,.4); opacity:0; transform:translateY(10px); transition:.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 100; display: flex; align-items: center; gap: 10px;}
  .toast.show{opacity:1; transform:translateY(0)}
  
  /* Santa Animation */
  #santa{ position:fixed; top:15%; left:-200px; font-size:60px; pointer-events:none; z-index:5; filter:drop-shadow(0 10px 20px rgba(0,0,0,0.5)); opacity: 0.9; transition: transform 0.2s; }
  @keyframes flySanta {
    0% { left: -200px; transform: translateY(0) rotate(5deg); }
    25% { transform: translateY(20px) rotate(0deg); }
    50% { transform: translateY(-20px) rotate(-5deg); }
    75% { transform: translateY(10px) rotate(2deg); }
    100% { left: 110vw; transform: translateY(0) rotate(5deg); }
  }

  /* Countdown */
  #countdownOverlay{
    position:fixed; inset:0; display:none; z-index:40;
    background:rgba(5,8,12,.7); backdrop-filter: blur(8px);
    align-items:center; justify-content:center; text-align:center; padding:24px;
  }
  #countdownOverlay .box{ max-width:820px; margin:auto; color:#fff }
  #countdownOverlay .timer{ font-weight:800; font-size:clamp(32px, 7vw, 64px); letter-spacing:-1px; background: linear-gradient(to bottom, #fff, #aaa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 10px; }
  
  table{width:100%; border-collapse:collapse} th,td{padding:12px; border-bottom:1px solid var(--border)} th{text-align:left; color:var(--gold)}
</style>
</head>
<body>
  <div class="bgimg" aria-hidden="true"></div>
  <canvas id="fx" aria-hidden="true" style="position:fixed; inset:0; width:100%; height:100%; pointer-events:none; z-index:1"></canvas>
  <div id="santa">üéÖüõ∑üí®</div>
  <canvas id="confetti" aria-hidden="true" style="position:fixed; inset:0; width:100%; height:100%; pointer-events:none; z-index:60"></canvas>

  <header>
    <div class="bar">
      <div class="logo" id="appLogo" aria-hidden="true"></div>
      <h1>GAB Adventskalender</h1>
      <div class="spacer"></div>
      
      <!-- New: Mute Button -->
      <button class="btn btn-icon-only" id="btn-mute" title="Sound an/aus" style="margin-right:8px">üîä</button>
      
      <div id="userBox" class="muted" style="font-size:14px; margin-right:10px"></div>
      <button class="btn" id="btn-signout" style="display:none">Abmelden</button>
      <button class="btn" id="btn-how">Info</button>
    </div>
  </header>

  <div class="wrap">
    <!-- Auth -->
    <div class="panel auth" id="authPanel">
      <h2 style="margin:4px 0 14px 0">Anmelden oder registrieren</h2>
      <div class="hint">Im DEMO-Modus bleiben Daten lokal.</div>
      <div class="row" style="margin-top:14px">
        <div style="flex:1; min-width:260px">
          <label for="name">Anzeigename</label>
          <input id="name" class="input" placeholder="Z. B. Max Mustermann" autocomplete="name"/>
          <label for="email">E-Mail</label>
          <input id="email" class="input" placeholder="name@firma.de" autocomplete="email"/>
          <label for="pw">Passwort</label>
          <input id="pw" class="input" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="new-password"/>
        </div>
      </div>
      <div class="row" style="margin-top:16px">
        <button type="button" class="btn gold" id="btn-register">Registrieren</button>
        <button type="button" class="btn" id="btn-login">Anmelden</button>
      </div>
      <div id="authMsg" class="hint" style="margin-top:10px; color:#ff6b6b"></div>
    </div>

    <!-- Kalender -->
    <div class="panel" id="kalPanel" style="display:none">
      <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:14px">
        <div>
          <h2 style="margin:0 0 4px 0; font-size:20px">Dein Kalender</h2>
          <div class="muted" style="font-size:14px">Willkommen, <strong id="who" style="color:#fff">‚Äì</strong></div>
        </div>
        <div id="devWarning" style="display:none; font-size:12px; color:var(--gold); border:1px solid var(--gold); padding:4px 8px; border-radius:6px">‚ö†Ô∏è Sim-Mode</div>
      </div>

      <!-- Progress Bar -->
      <div class="progress-container">
        <div class="progress-labels">
          <span>Fortschritt</span>
          <span id="progressText">0 / 24</span>
        </div>
        <div class="progress-track">
          <div class="progress-fill" id="progressFill"></div>
        </div>
      </div>

      <div class="grid" id="grid"></div>
    </div>

    <!-- Admin √úbersicht -->
    <div class="panel" id="boardPanel" style="display:none; margin-top:16px">
      <h3>√úbersicht Team</h3>
      <div id="board"></div>
      <div id="adminTools" style="margin-top:16px; display:none; border-top:1px solid var(--border); padding-top:16px">
        <h4 style="margin:0 0 10px 0">Voucher Terminal</h4>
        <div class="row" style="align-items:center">
          <input id="admCode" class="input" placeholder="Code eingeben..." style="min-width:260px"/>
          <button class="btn" id="btnVerify">Pr√ºfen</button>
          <button class="btn gold" id="btnRedeem">Einl√∂sen</button>
        </div>
        <div id="admMsg" class="hint" style="margin-top:8px"></div>
      </div>
    </div>
  </div>

  <div class="footer">¬© 2025 GAB Neumann GmbH | Interner Spa√ükalender</div>

  <!-- Modal -->
  <div class="modal-backdrop" id="backdrop">
    <div class="modal" id="modalBox">
      <div class="head"><strong id="modalTitle">T√ºrchen</strong><div class="spacer"></div><button class="btn" id="closeModal">‚úï</button></div>
      <div class="body" id="modalBody"></div>
    </div>
  </div>

  <!-- Countdown -->
  <div id="countdownOverlay" aria-hidden="true">
    <div class="box">
      <div class="timer" id="cdTimer">--:--:--</div>
      <div class="msg" id="cdText">Warten auf den Start...</div>
    </div>
  </div>

  <div class="print-area" id="printArea"></div>
  <div class="toast" id="toast"></div>

  <script type="module">
  /* ===== Config ===== */
  const IS_DEMO = location.protocol === 'file:';
  const DOOR_IMAGES = true; 
  const urlParams = new URLSearchParams(window.location.search);
  const simDateParam = urlParams.get('sim_date');

  const CONFIG = {
    bgImage:'assets/bg.jpg',
    sfx:{ open:['assets/sfx/open.mp3'], win:['assets/sfx/win.mp3'], click:['assets/sfx/click.mp3'], hoho:['assets/sfx/hoho.mp3'] }, 
    probabilities:{ mealVoucher:0.0025, snackVoucher:0.10 }, 
    year:2025, startMonth:12, days:24
  };
  document.documentElement.style.setProperty('--bg', `url('${CONFIG.bgImage}')`);

  /* ===== Global Audio State ===== */
  let isMuted = localStorage.getItem('gab_muted') === 'true';
  const btnMute = document.getElementById('btn-mute');
  function updateMuteUI(){
    btnMute.textContent = isMuted ? 'üîá' : 'üîä';
    btnMute.style.opacity = isMuted ? '0.5' : '1';
  }
  updateMuteUI();
  btnMute.onclick = () => {
    isMuted = !isMuted;
    localStorage.setItem('gab_muted', isMuted);
    updateMuteUI();
  };
  function playSFX(k){ 
    if(isMuted) return;
    const s=CONFIG.sfx[k]; 
    if(s) new Audio(s[0]).play().catch(()=>{}); 
  }

  /* ===== Santa Animation Logic ===== */
  function triggerSanta(){
    const el = document.getElementById('santa');
    if(el.style.animationName === 'flySanta') return; // already flying
    el.style.animation = 'flySanta 6s linear forwards';
    // Easter egg chance: play hohoho
    if(Math.random() > 0.5) setTimeout(()=>playSFX('hoho'), 500);
    setTimeout(() => { el.style.animation = ''; }, 6500); // reset
  }
  // Randomly trigger santa every 45-120 seconds
  setInterval(() => {
    if(Math.random() > 0.3) triggerSanta();
  }, 1000 * (45 + Math.random()*75));

  /* ===== Logic Helpers ===== */
  function getCurrentDate() {
    if (simDateParam) {
      const sim = new Date(simDateParam);
      if (!isNaN(sim.getTime())) {
        const now = new Date();
        sim.setHours(now.getHours(), now.getMinutes());
        return sim;
      }
    }
    return new Date();
  }
  if(simDateParam) {
     document.getElementById('devWarning').style.display = 'block';
  }

  /* ===== Easter Egg ===== */
  document.getElementById('appLogo').onclick = () => {
    playSFX('win'); 
    triggerSanta();
    CONFETTI.burst(window.innerWidth/2, window.innerHeight/2);
    _toast('üéÑ Ho Ho Ho! üéÑ');
  };

  /* ===== Messages Pool ===== */
  const MESSAGES = [
    {type:'quote', text:'Motivation des Tages: Auch diesen Arbeitstag darfst du mit deinen Kollegen hier verbringen!'},
    {type:'joke', text:'Was ist das Lieblingsgetr√§nk von Programmierern? ‚Äì Java.'},
    {type:'fact', text:'Oktopusse haben drei Herzen und blaues Blut.'},
    {type:'link', text:'https://neal.fun/size-of-space/', label:'üöÄ Size of Space', desc:'Vergleiche interaktiv Gr√∂√üen ‚Äì vom Menschen bis zur Galaxie.'},
    {type:'fact', text:'In Island gibt es keine heimischen Moskitos.'},
    {type:'joke', text:'Treffen sich zwei Schneeflocken. Sagt die eine: "Komm, wir gehen rodeln."'},
    {type:'link', text:'https://quickdraw.withgoogle.com/', label:'üé® Quick Draw', desc:'Kann eine KI deine Kritzeleien erkennen?'},
    {type:'fact', text:'Schnee ist eigentlich gar nicht wei√ü, sondern transparent.'},
    {type:'quote', text:'Mach es wie der Weihnachtsmann: Sei einfach mal nicht da.'}
  ];

  /* ===== Countdown Logic ===== */
  function getCountdownTarget(){
    if (urlParams.has('cd')) return new Date(Date.now() + parseInt(urlParams.get('cd')) * 1000);
    return new Date(CONFIG.year, CONFIG.startMonth - 1, 1, 0, 0, 0);
  }
  function startCountdownOverlay(){
    const overlay = document.getElementById('countdownOverlay');
    const cdTimer = document.getElementById('cdTimer');
    const cdText = document.getElementById('cdText');
    if(!overlay) return;
    const target = getCountdownTarget();
    
    function render(){
      const now = getCurrentDate();
      if (now >= target){
        overlay.style.display = 'none'; return;
      }
      const diff = target - now;
      const d = Math.floor(diff/86400000);
      const h = Math.floor((diff%86400000)/3600000);
      const m = Math.floor((diff%3600000)/60000);
      const s = Math.floor((diff%60000)/1000);
      
      cdTimer.textContent = `${d} Tage ${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
      cdText.innerHTML = `Bald geht es los!`;
      overlay.style.display = 'flex';
    }
    render();
    setInterval(render, 1000);
  }
  startCountdownOverlay();

  /* ===== Visual Effects ===== */
  const FX = (()=>{ const cvs=document.getElementById('fx'); const ctx=cvs.getContext('2d',{alpha:true});
    let w=0,h=0,flakes=[],run=true;
    function resize(){ w=cvs.width=window.innerWidth; h=cvs.height=window.innerHeight; flakes=new Array(100).fill(0).map(()=>({x:Math.random()*w,y:Math.random()*h,r:Math.random()*3+1,s:Math.random()*1+0.5})) }
    function loop(){ 
      if(!run) return;
      ctx.clearRect(0,0,w,h); ctx.fillStyle='#fff'; ctx.beginPath();
      for(const f of flakes){ f.y+=f.s; if(f.y>h)f.y=-5; ctx.moveTo(f.x,f.y); ctx.arc(f.x,f.y,f.r,0,Math.PI*2); }
      ctx.fill(); requestAnimationFrame(loop);
    }
    window.onresize=resize; resize(); loop();
    return { toggle:()=>{ run=!run; if(run) loop(); } };
  })();
  // Snow toggle via clicking bg (easter egg-ish) or via API. Let's keep it running by default.

  const CONFETTI = (()=>{
    const cvs = document.getElementById('confetti'); const ctx = cvs.getContext('2d');
    let p = []; let w,h;
    const resize = () => { w=cvs.width=window.innerWidth; h=cvs.height=window.innerHeight; };
    window.onresize=resize; resize();
    const colors = ['#f00','#0f0','#00f','#ff0','#0ff','#f0f'];
    function loop(){
      if(!p.length)return; ctx.clearRect(0,0,w,h);
      p=p.filter(x=>x.l>0);
      p.forEach(x=>{ x.x+=x.vx; x.y+=x.vy; x.vy+=0.5; x.l--; ctx.fillStyle=x.c; ctx.fillRect(x.x,x.y,6,6); });
      requestAnimationFrame(loop);
    }
    return { burst:(x,y)=>{ for(let i=0;i<40;i++) p.push({x,y,vx:(Math.random()-.5)*20,vy:(Math.random()-1)*20,c:colors[Math.floor(Math.random()*colors.length)],l:100}); loop(); } }
  })();

  /* ===== Core App Logic ===== */
  const svc = IS_DEMO ? await makeDemoService() : await makeLiveService();
  let state = { opened:{}, rewards:{} };

  /* UI Refs */
  const grid = document.getElementById('grid');
  
  svc.onAuth(async user => {
    if(user){
      document.getElementById('authPanel').style.display='none';
      document.getElementById('kalPanel').style.display='block';
      document.getElementById('userBox').textContent = user.name;
      document.getElementById('who').textContent = user.name;
      document.getElementById('btn-signout').style.display='block';
      
      await svc.onUserDoc(user.uid, data => {
        state = data || { opened:{}, rewards:{} };
        renderGrid(user);
      });

      if(await svc.isAdmin(user.uid)){
        document.getElementById('boardPanel').style.display='block';
        document.getElementById('adminTools').style.display='block';
        svc.onAllUsers(renderBoard);
      }
    } else {
      document.getElementById('authPanel').style.display='block';
      document.getElementById('kalPanel').style.display='none';
      document.getElementById('boardPanel').style.display='none';
      document.getElementById('btn-signout').style.display='none';
    }
  });

  document.getElementById('btn-signout').onclick = () => svc.logout();
  document.getElementById('btn-login').onclick = async () => {
    try { await svc.login(document.getElementById('email').value, document.getElementById('pw').value); }
    catch(e){ document.getElementById('authMsg').textContent = e.message; }
  };
  document.getElementById('btn-register').onclick = async () => {
    try { await svc.register(document.getElementById('name').value, document.getElementById('email').value, document.getElementById('pw').value); }
    catch(e){ document.getElementById('authMsg').textContent = e.message; }
  };

  /* ===== Grid Rendering (Classic Style, No 3D) ===== */
  let lastJSON = '';
  function renderGrid(user){
    const json = JSON.stringify(state.opened);
    if(json === lastJSON && grid.hasChildNodes()) return;
    lastJSON = json;
    
    grid.innerHTML = '';
    const today = getCurrentDate();
    const curDay = today.getDate();
    const curMonth = today.getMonth()+1;
    const order = getDoorOrder(CONFIG.year);

    // Progress Bar update
    const openedCount = Object.keys(state.opened).length;
    const pct = Math.min(100, (openedCount / CONFIG.days) * 100);
    document.getElementById('progressFill').style.width = `${pct}%`;
    document.getElementById('progressText').textContent = `${openedCount} / ${CONFIG.days}`;

    for(let i=0; i<CONFIG.days; i++){
      const n = order[i];
      const isOpened = !!state.opened[n];
      const isLocked = (curMonth < CONFIG.startMonth) || (curMonth === CONFIG.startMonth && n > curDay);
      
      // Classic Door Element
      const btn = document.createElement('button');
      btn.className = `door ${isOpened ? 'opened' : ''} ${isLocked ? 'locked' : ''} ${n===24 ? 'day-24' : ''}`;
      
      const em = n===24 ? 'üåü' : (n%6===0?'üéÅ':n%5===0?'üç™':n%4===0?'üïØÔ∏è':n%3===0?'‚ùÑÔ∏è':'üéÑ');
      btn.innerHTML = `<div class="emoji">${em}</div><div class="num">${n}</div>`;
      
      // Optional: Add Badge if opened
      if(isOpened){
         // Falls du Bilder auf der T√ºr willst:
         if(DOOR_IMAGES){
             const img = document.createElement('img');
             img.className = 'thumb';
             img.src = `assets/doors/${String(n).padStart(2,'0')}.jpg`;
             img.onerror = () => { img.style.display='none'; };
             btn.appendChild(img);
         }
         const badge = document.createElement('div'); badge.className='badge'; badge.textContent='offen';
         btn.appendChild(badge);
      }

      // Interaction Logic
      btn.onclick = (e) => {
        if(isOpened){
           // Bereits offen: Zeige Inhalt (Sofort)
           showReward(n, state.rewards[n], user);
        } else {
           if(isLocked){
             btn.classList.add('shake');
             setTimeout(()=>btn.classList.remove('shake'), 500);
             playSFX('click');
             _toast(`Tag ${n} ist noch nicht dran!`);
           } else {
             // √ñffnen!
             const rect = btn.getBoundingClientRect();
             // AUTOMATISCH √∂ffnen, kein zweiter Klick
             openDoor(user, n, rect.left+rect.width/2, rect.top+rect.height/2).then(r => {
                 // Modal wird von openDoor aufgerufen
             });
           }
        }
      };

      grid.appendChild(btn);
    }
  }

  /* ===== Opening Logic ===== */
  async function openDoor(user, day, x, y){
    CONFETTI.burst(x,y);
    const seed = hash(`${user.uid}|${CONFIG.year}|${day}`);
    const rng = mul32(seed);
    const roll = rng();
    
    let reward;
    // Zuerst Reward bestimmen
    if(roll < CONFIG.probabilities.mealVoucher){
        const nonce = randHex(8);
        try {
          const sig = await svc.signVoucher({day, type:'meal', nonce});
          reward = { kind:'voucher', payload:{title:'Gratis Mittag', type:'meal', code:sig.code, ...sig} };
          playSFX('win');
        } catch(e) { return _toast('Fehler beim Laden'); }
    } else {
        const msg = getMessageFor(user, day);
        reward = { kind:'message', payload:msg };
        playSFX('open');
    }

    // Speichern
    const opened = {...state.opened, [day]:true};
    const rewards = {...state.rewards, [day]:reward};
    await svc.setUserDoc(user.uid, { opened, rewards });
    
    // SOFORT Modal anzeigen, damit es nicht "leer" wirkt
    showReward(day, reward, user);
  }

  function showReward(day, reward, user){
    if(!reward) return;
    document.getElementById('modalTitle').textContent = `Inhalt T√ºrchen ${day}`;
    let h = '';
    
    // Optional: Gro√ües Bild im Modal anzeigen
    const hero = DOOR_IMAGES ? `<div style="position:relative; height:180px; border-radius:12px; overflow:hidden; margin-bottom:16px; border:1px solid var(--border); box-shadow:0 5px 15px rgba(0,0,0,0.3)"><img src="assets/doors/${String(day).padStart(2,'0')}.jpg" alt="Bild" style="position:absolute; inset:0; width:100%; height:100%; object-fit:cover" onerror="this.parentElement.style.display='none'"/></div>` : '';

    if(reward.kind === 'voucher'){
      const v = reward.payload;
      h = `${hero}<div class="reward">
            <div class="icon">üéüÔ∏è</div>
            <div style="flex:1">
              <h3 style="margin:0 0 4px 0">${v.title}</h3>
              <div class="muted">Herzlichen Gl√ºckwunsch!</div>
              <div class="voucher">
                <div class="line"><span class="label">Code:</span> <code>${v.code}</code></div>
                <div class="line"><span class="label">F√ºr:</span> <strong>${user.name}</strong></div>
              </div>
              <div style="margin-top:12px; display:flex; gap:8px">
                 <button class="btn" onclick="window.print()">Drucken</button>
                 <button class="btn" onclick="copyToClip('${v.code}', 'Code')">Code kopieren</button>
              </div>
            </div>
           </div>`;
    } else {
       const m = reward.payload;
       const icon = m.type==='joke'?'ü§£':(m.type==='fact'?'üí°':'‚ú®');
       const shareText = `${m.type==='joke'?'ü§£ Witz':(m.type==='fact'?'üí° Fakt':'‚ú® Spruch')} des Tages:\n\n${m.text}\n\n(Aus dem GAB Adventskalender)`;
       
       h = `${hero}<div class="reward">
             <div class="icon">${icon}</div>
             <div style="flex:1">
               <h3 style="margin:0 0 8px 0">Botschaft des Tages</h3>
               <div style="font-size:16px; line-height:1.5">${m.type==='link' ? `<a href="${m.text}" target="_blank" style="color:#6cf">${m.label}</a><br><small>${m.desc}</small>` : m.text}</div>
               ${m.type !== 'link' ? `<button class="btn" style="margin-top:12px" onclick="copyToClip(\`${shareText.replace(/"/g, '&quot;')}\`, 'Spruch')">üìã Kopieren f√ºr Chat</button>` : ''}
             </div>
            </div>`;
    }
    document.getElementById('modalBody').innerHTML = h;
    openModal();
  }

  window.copyToClip = (txt, label) => {
    navigator.clipboard.writeText(txt).then(() => _toast(`${label} kopiert!`));
  };

  /* ===== Modal & Toast ===== */
  function openModal(){ 
    const b=document.getElementById('backdrop'); const m=document.getElementById('modalBox');
    b.style.display='flex'; setTimeout(()=>m.classList.add('active'),10);
  }
  document.getElementById('closeModal').onclick = () => {
    const b=document.getElementById('backdrop'); const m=document.getElementById('modalBox');
    m.classList.remove('active'); setTimeout(()=>b.style.display='none',300);
  };
  window._toast = (msg) => {
    const t = document.getElementById('toast'); t.innerHTML = `<span>üîî</span> ${msg}`;
    t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 2500);
  };

  /* ===== Admin Board ===== */
  function renderBoard(users){
    let h = '<table><thead><tr><th>Name</th><th>Fortschritt</th></tr></thead><tbody>';
    users.forEach(u => {
      const c = Object.keys(u.opened||{}).length;
      h += `<tr><td>${u.name||'Unbekannt'}</td><td><div style="display:flex;align-items:center;gap:8px"><div style="flex:1;height:6px;background:#333;border-radius:3px;overflow:hidden"><div style="width:${(c/24)*100}%;background:#5de07a;height:100%"></div></div> ${c}</div></td></tr>`;
    });
    h += '</tbody></table>';
    document.getElementById('board').innerHTML = h;
  }

  /* ===== Helpers ===== */
  function getDoorOrder(y){
    const arr=Array.from({length:24},(_,i)=>i+1);
    let s=hash(String(y));
    for(let i=arr.length-1;i>0;i--){ s=(s*9301+49297)%233280; const j=(s%(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; }
    return arr;
  }
  function getMessageFor(u,d){
    return MESSAGES[(d + hash(u.uid)) % MESSAGES.length];
  }
  function randHex(n){ return Math.random().toString(16).slice(2, 2+n).toUpperCase(); }
  function hash(s){ let h=0; for(let i=0;i<s.length;i++) h=((h<<5)-h)+s.charCodeAt(i)|0; return h>>>0; }
  function mul32(a){ return function(){ let t=a+=0x6D2B79F5; t=Math.imul(t^t>>>15,t|1); t^=t+Math.imul(t^t>>>7,t|61); return ((t^t>>>14)>>>0)/4294967296 } }
  
  /* ===== Demo Service (Mock) ===== */
  async function makeDemoService(){
    const store = { 
      get:(k)=>JSON.parse(localStorage.getItem('adv_v2_'+k)||'null'),
      set:(k,v)=>localStorage.setItem('adv_v2_'+k, JSON.stringify(v))
    };
    let cbs = [];
    return {
      register: async(n,e,p)=>{ 
        const uid='u'+hash(e); store.set('u_'+uid, {name:n,email:e}); 
        store.set('sess', {uid,name:n}); cbs.forEach(f=>f({uid,name:n})); return true; 
      },
      login: async(e,p)=>{ 
        const uid='u'+hash(e); if(!store.get('u_'+uid)) throw new Error('User unbekannt');
        store.set('sess', {uid,name:store.get('u_'+uid).name}); cbs.forEach(f=>f({uid,name:store.get('u_'+uid).name})); return true;
      },
      logout: async()=>{ store.set('sess', null); cbs.forEach(f=>f(null)); },
      onAuth: (fn)=>{ cbs.push(fn); fn(store.get('sess')); },
      onUserDoc: async(uid, fn)=>{ 
        const fire=()=>fn(store.get('data_'+uid)); fire(); 
        setInterval(fire, 1000);
      },
      setUserDoc: async(uid, d)=>{ const old=store.get('data_'+uid)||{}; store.set('data_'+uid, {...old, ...d}); },
      isAdmin: async()=>true, // Everyone is admin in demo
      onAllUsers: async(fn)=>{ 
        fn([{name:'Max', opened:{1:true,2:true}}, {name:'Lisa', opened:{1:true}}]);
      },
      signVoucher: async({day,type,nonce})=>{ return {code:`DEMO-${type}-${day}-${nonce}`, token:'xxx'}; }
    };
  }

  /* ===== Live Service (Stub) ===== */
  async function makeLiveService(){
     return makeDemoService(); // Fallback
  }

  </script>
</body>
</html>
