<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Malia Besuchsplaner</title>
  <meta name="color-scheme" content="light" />
  <meta name="theme-color" content="#ffd6e7" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase Compat -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <!-- Firebase Konfiguration -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCB9fyO8mS1pgSZFYJVjcTXGHk9hGQmpU4",
      authDomain: "geburt-ded5c.firebaseapp.com",
      projectId: "geburt-ded5c",
      storageBucket: "geburt-ded5c.firebasestorage.app",
      messagingSenderId: "528584992005",
      appId: "1:528584992005:web:14dea3f914a432e317c36c",
      measurementId: "G-SX8G2KPVL8"
    };
  </script>

  <style>
    html, body { height: 100%; }
    body.modal-open { overflow: hidden; }
    dialog { z-index: 60; }
    dialog::backdrop { background: rgba(0,0,0,.35); }
    .glass { background: rgba(255,255,255,.65); backdrop-filter: blur(10px) saturate(135%); }
    .pill { background: rgba(15,23,42,.06); }
    .slot { transition: transform .05s, box-shadow .2s, background .2s, border-color .2s; }
    .slot:active { transform: scale(.98); }
    .no-scrollbar::-webkit-scrollbar{ display:none; }
    .no-scrollbar{ -ms-overflow-style:none; scrollbar-width:none; }

    .slot-booked {
      border-color: rgba(255,122,162,.5) !important;
      background: linear-gradient(135deg, rgba(255,245,248,.9), rgba(255,225,236,.9)) !important;
      box-shadow: 0 10px 26px rgba(255,122,162,.25);
    }
    .slot-blocked {
      filter: grayscale(0.25);
      background: rgba(148,163,184,.15) !important;
      border-color: rgba(148,163,184,.35) !important;
      opacity: .85;
    }

    #centerToast {
      position: fixed;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -40%) scale(.98);
      opacity: 0;
      background: linear-gradient(135deg, rgba(255,255,255,.98), rgba(255,240,246,.98));
      border: 1px solid rgba(255,255,255,.9);
      border-radius: 20px;
      padding: 20px 24px;
      font-weight: 800;
      letter-spacing: .2px;
      box-shadow: 0 20px 60px rgba(255,122,162,.35), 0 8px 24px rgba(0,0,0,.18);
      z-index: 90;
      pointer-events: none;
      transition: opacity .25s ease, transform .25s ease;
    }
    #centerToast.show { opacity: 1; transform: translate(-50%, -50%) scale(1); }

    #fx { position: fixed; inset: 0; pointer-events: none; z-index: 70; }

    #swipeHint { position: fixed; inset: 0; pointer-events: none; z-index: 55; }
    .edge {
      position: absolute; top: 50%; width: 56px; height: 56px; margin-top: -28px;
      display: grid; place-items: center; color: rgba(244,63,94,.85);
      background: radial-gradient(closest-side, rgba(255,255,255,.95), rgba(255,255,255,.0));
      border-radius: 999px; transform: scale(.96); opacity: 0;
      transition: opacity .35s ease, transform .35s ease;
      filter: drop-shadow(0 10px 22px rgba(0,0,0,.18));
    }
    #swipeHint.show .edge { opacity: 1; transform: scale(1); }
    .edge-left { left: 8px; }
    .edge-right { right: 8px; }
    .dots {
      position: absolute; bottom: 16px; left: 50%; transform: translateX(-50%);
      display: flex; gap: 8px; background: rgba(255,255,255,.75); backdrop-filter: blur(6px);
      padding: 6px 10px; border-radius: 999px; border: 1px solid rgba(255,255,255,.9);
      box-shadow: 0 10px 24px rgba(0,0,0,.12);
    }
    .dot { width: 8px; height: 8px; border-radius: 999px; background: rgba(244,63,94,.25); transition: transform .2s, background .2s; }
    .dot.active { transform: scale(1.35); background: rgba(244,63,94,.9); }
  </style>
</head>
<body class="min-h-full bg-gradient-to-br from-rose-50 via-pink-50 to-fuchsia-50 text-slate-900">

  <header class="sticky top-0 z-40 border-b border-white/60 glass">
    <div class="max-w-3xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-10 w-10 rounded-2xl flex items-center justify-center text-lg"
             style="background: linear-gradient(135deg,#ffd6e7,#ffc3da); box-shadow: inset 0 1px 0 rgba(255,255,255,.8), 0 8px 24px rgba(255,122,162,.28);">üíó</div>
        <div>
          <h1 class="m-0 text-xl font-extrabold tracking-tight">Malia Kalender</h1>
          <p id="syncInfo" class="text-xs text-slate-700">Cloud Sync wird aufgebaut</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="btnLogin" class="px-3 py-1.5 rounded-xl text-sm bg-pink-600 text-white hover:bg-pink-700">Admin Bereich</button>
        <button id="btnLogout" class="px-3 py-1.5 rounded-xl text-sm bg-slate-200 text-slate-800 hover:bg-slate-300 hidden">Logout</button>
      </div>
    </div>

    <div class="max-w-3xl mx-auto px-3 pb-2">
      <div id="dayStrip" class="flex overflow-x-auto gap-2 no-scrollbar"></div>
    </div>

    <div id="daysCta" class="max-w-3xl mx-auto px-3 pb-3 hidden">
      <button id="btnOpenDays" class="px-3 py-1.5 rounded-xl bg-rose-500 text-white hover:bg-rose-600">Tage festlegen</button>
    </div>

    <div id="adminPanel" class="max-w-3xl mx-auto px-3 pb-3 hidden">
      <div class="glass rounded-2xl border border-white/60 shadow-lg p-3">
        <div class="flex flex-wrap items-center gap-2">
          <button id="btnDaysSetup" class="px-3 py-1.5 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700 hidden">Tage festlegen</button>
          <button id="btnDaysEdit" class="px-3 py-1.5 rounded-xl bg-amber-600 text-white hover:bg-amber-700 hidden">Tage bearbeiten</button>
          <span class="hidden sm:inline text-sm text-slate-700">Zeiten</span>
          <input id="hourStart" type="number" min="0" max="23" class="px-3 py-1.5 rounded-xl border border-slate-300 w-20" />
          <input id="hourEnd" type="number" min="1" max="24" class="px-3 py-1.5 rounded-xl border border-slate-300 w-20" />
          <button id="btnBlockToggle" class="px-3 py-1.5 rounded-xl bg-rose-500 text-white hover:bg-rose-600">Blockmodus</button>
          <button id="btnClearDay" class="px-3 py-1.5 rounded-xl bg-rose-600 text-white hover:bg-rose-700">Tag leeren</button>
          <span id="uidOut" class="text-xs text-slate-500 ml-1">keine UID</span>
          <button id="btnCopyUID" class="px-2 py-1 text-xs rounded-lg bg-slate-200 hover:bg-slate-300 hidden">UID kopieren</button>
        </div>
      </div>
    </div>
  </header>

  <section id="setupNotice" class="max-w-3xl mx-auto glass rounded-2xl border border-white/60 shadow p-4 mt-3 hidden">
    <p class="text-sm text-slate-700">Bitte Admin legt f√ºnf Tage fest</p>
  </section>

  <main id="appMain" class="max-w-3xl mx-auto px-3 pb-12 pt-3 select-none">
    <ul id="timeline" class="space-y-3"></ul>
    <p id="emptyMsg" class="mt-6 text-center text-sm text-slate-600 hidden">Noch keine Tage gew√§hlt</p>
  </main>

  <div id="centerToast">Danke f√ºr deinen Eintrag</div>
  <canvas id="fx"></canvas>

  <div id="swipeHint" aria-hidden="true">
    <div class="edge edge-left">‚Äπ</div>
    <div class="edge edge-right">‚Ä∫</div>
    <div class="dots" id="pageDots"></div>
  </div>

  <dialog id="dlgBook" class="rounded-2xl p-0 w-full max-w-md">
    <div class="p-4 border-b bg-rose-50 rounded-t-2xl">
      <h2 class="font-semibold">Slot buchen</h2>
      <p id="dlgBookWhen" class="text-sm text-slate-600"></p>
    </div>
    <div class="p-4 space-y-3">
      <label class="block">
        <span class="text-sm">Name</span>
        <input id="inName" required class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300" placeholder="Dein Name">
      </label>

      <div class="text-sm text-slate-700">
        Aufenthalt 30 Min. Die Stunde wird reserviert
      </div>

      <label class="block">
        <span class="text-sm">Notiz optional</span>
        <textarea id="inNote" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300" rows="2" placeholder="Kurze Notiz"></textarea>
      </label>
    </div>
    <div class="p-4 border-t flex justify-end gap-2">
      <button type="button" class="px-3 py-2 rounded-xl pill" id="btnCancelBooking">Abbrechen</button>
      <button type="button" id="btnConfirmBooking" class="px-3 py-2 rounded-xl bg-pink-600 text-white">Buchen</button>
    </div>
  </dialog>

  <dialog id="dlgBlock" class="rounded-2xl p-0 w-full max-w-md">
    <div class="p-4 border-b bg-rose-50 rounded-t-2xl">
      <h2 class="font-semibold">Zeitraum blocken</h2>
      <p id="dlgBlockWhen" class="text-sm text-slate-600"></p>
    </div>
    <div class="p-4 space-y-3">
      <label class="block"><span class="text-sm">Grund</span><input id="inBlockReason" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300" placeholder="Blockiert"></label>
      <label class="block"><span class="text-sm">Dauer</span>
        <select id="inBlockDuration" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300">
          <option value="1">1 Stunde</option><option value="2">2 Stunden</option>
        </select>
      </label>
    </div>
    <div class="p-4 border-t flex justify-end gap-2">
      <button type="button" class="px-3 py-2 rounded-xl pill" id="btnCancelBlock">Abbrechen</button>
      <button type="button" id="btnConfirmBlock" class="px-3 py-2 rounded-xl bg-amber-600 text-white">Block setzen</button>
    </div>
  </dialog>

  <dialog id="dlgLogin" class="rounded-2xl p-0 w-full max-w-sm">
    <div class="p-4 border-b bg-rose-50 rounded-t-2xl">
      <h2 class="font-semibold">Admin Bereich</h2>
      <p class="text-sm text-slate-600">Nur f√ºr Verwaltung</p>
    </div>
    <div class="p-4 space-y-3">
      <label class="block"><span class="text-sm">Admin PIN</span><input id="inPin" type="password" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300" placeholder="Admin PIN"></label>
    </div>
    <div class="p-4 border-t flex justify-end gap-2">
      <button type="button" class="px-3 py-2 rounded-xl pill" id="btnCancelLogin">Abbrechen</button>
      <button type="button" id="btnLoginConfirm" class="px-3 py-2 rounded-xl bg-emerald-600 text-white">Login</button>
    </div>
  </dialog>

  <dialog id="dlgDays" class="rounded-2xl p-0 w-full max-w-lg">
    <div class="p-4 border-b bg-rose-50 rounded-t-2xl">
      <h2 class="font-semibold">F√ºnf Tage festlegen</h2>
      <p class="text-sm text-slate-600">Bitte f√ºnf einzelne Tage w√§hlen</p>
    </div>
    <div class="p-4 grid grid-cols-1 sm:grid-cols-2 gap-3">
      <label class="block"><span class="text-sm">Tag 1</span><input id="d1" type="date" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300"></label>
      <label class="block"><span class="text-sm">Tag 2</span><input id="d2" type="date" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300"></label>
      <label class="block"><span class="text-sm">Tag 3</span><input id="d3" type="date" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300"></label>
      <label class="block"><span class="text-sm">Tag 4</span><input id="d4" type="date" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300"></label>
      <label class="block sm:col-span-2"><span class="text-sm">Tag 5</span><input id="d5" type="date" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300"></label>
    </div>
    <div class="px-4 pb-2">
      <button id="btnFillNext5" class="px-3 py-1.5 rounded-xl bg-slate-200 hover:bg-slate-300 text-sm">N√§chste f√ºnf Tage automatisch f√ºllen</button>
    </div>
    <div class="p-4 border-t flex justify-end gap-2">
      <button type="button" class="px-3 py-2 rounded-xl pill" id="btnCancelDays">Abbrechen</button>
      <button type="button" id="btnSaveDays" class="px-3 py-2 rounded-xl bg-emerald-600 text-white">Speichern</button>
    </div>
  </dialog>

  <script>
    const ADMIN_PIN = '1597';
    const DEFAULT_HOUR_START = 9;
    const DEFAULT_HOUR_END = 20;

    const qs = s => document.querySelector(s);
    const fmt = new Intl.DateTimeFormat('de-DE', { weekday: 'short', day: '2-digit', month: '2-digit' });
    const pad2 = n => String(n).padStart(2,'0');
    const hourLabel = h => pad2(h) + ':00';
    const clampHour = h => Number.isNaN(h) ? DEFAULT_HOUR_START : Math.max(0, Math.min(24, h));
    const toISO = d => new Date(d.getTime() - d.getTimezoneOffset()*60000).toISOString().slice(0,10);
    const makeDateFromISO = iso => { const [y,m,d] = iso.split('-').map(Number); return new Date(y, m-1, d); };
    const escapeHTML = s => String(s).replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]||c));
    const tsToDate = v => v && typeof v.toDate === 'function' ? v.toDate() : (v instanceof Date ? v : null);

    function setSync(msg, err=false){ const el=qs('#syncInfo'); if(!el) return; el.textContent=msg; el.style.color = err ? '#b91c1c' : ''; }

    function openDialog(d){ try{ d.showModal(); } catch{ d.setAttribute('open',''); document.body.classList.add('modal-open'); } }
    function closeDialog(d){ try{ d.close(); } catch{ d.removeAttribute('open'); document.body.classList.remove('modal-open'); } }
    (function(){ const t=document.createElement('dialog'); const ok=!!window.HTMLDialogElement && typeof t.showModal==='function';
      if(ok) return; const m={show(){this.setAttribute('open','');},showModal(){this.setAttribute('open','');document.body.classList.add('modal-open');},close(){this.removeAttribute('open');document.body.classList.remove('modal-open');}};
      document.querySelectorAll('dialog').forEach(d=>Object.assign(d,m));
      new MutationObserver(()=>{document.querySelectorAll('dialog').forEach(d=>{if(!('showModal'in d))Object.assign(d,m);});}).observe(document.documentElement,{childList:true,subtree:true});
    })();

    let state = {
      admin:false,
      hourStart: DEFAULT_HOUR_START,
      hourEnd: DEFAULT_HOUR_END,
      days: [],
      bookings: {},
      selectedDayIndex: 0,
      usingCloud: false,
      blockMode: false,
      lastSettingsChangeAt: null
    };
    const LS_KEY_BOOK='malia_bookings_v7';
    const LS_KEY_SETTINGS='malia_settings_v7';
    const LS_KEY_DAYS='malia_days_v7';
    const LS_KEY_ADMIN='malia_admin_v4';
    const LS_KEY_HINT='malia_swipe_hint_seen_v1';
    let pendingOpenDays = false;

    function loadLocal(){
      try{
        const b=JSON.parse(localStorage.getItem(LS_KEY_BOOK)||'{}');
        const s=JSON.parse(localStorage.getItem(LS_KEY_SETTINGS)||'{}');
        const d=JSON.parse(localStorage.getItem(LS_KEY_DAYS)||'[]');
        state.bookings=b;
        if(Number.isInteger(s.hourStart)) state.hourStart=s.hourStart;
        if(Number.isInteger(s.hourEnd)) state.hourEnd=s.hourEnd;
        if(Number.isInteger(s.selectedDayIndex)) state.selectedDayIndex=s.selectedDayIndex;
        if(Array.isArray(d)) state.days=d;
        if(localStorage.getItem(LS_KEY_ADMIN)==='1') state.admin=true;
        if(s.lastSettingsChangeAt) state.lastSettingsChangeAt = new Date(s.lastSettingsChangeAt);
      }catch{}
    }
    function saveLocal(){
      localStorage.setItem(LS_KEY_BOOK, JSON.stringify(state.bookings));
      localStorage.setItem(LS_KEY_SETTINGS, JSON.stringify({
        hourStart:state.hourStart,
        hourEnd:state.hourEnd,
        selectedDayIndex:state.selectedDayIndex,
        lastSettingsChangeAt: state.lastSettingsChangeAt ? state.lastSettingsChangeAt.toISOString() : null
      }));
      localStorage.setItem(LS_KEY_DAYS, JSON.stringify(state.days));
      localStorage.setItem(LS_KEY_ADMIN, state.admin?'1':'0');
    }

    let fb={app:null,db:null,auth:null,unsub:null};
    async function initFirebaseCompat(){
      try{
        if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        fb.app=firebase.app(); fb.db=firebase.firestore(); fb.auth=firebase.auth();
        fb.auth.onAuthStateChanged(()=>updateUIDOutput());
        await fb.auth.signInAnonymously();
        state.usingCloud=true; setSync('Cloud Sync aktiv. Daten werden geteilt');
        subscribeSettingsCompat(); subscribeCloudCompat();
      }catch(e){ console.error(e); state.usingCloud=false; setSync('Cloud Anmeldung fehlgeschlagen. Pr√ºfe Anonymous Auth und Domain', true); }
    }
    function subscribeSettingsCompat(){
      if(!state.usingCloud) return;
      const ref=fb.db.collection('settings').doc('config');
      ref.onSnapshot(snap=>{
        if(!snap.exists) return;
        const cfg=snap.data();
        const remoteAt = tsToDate(cfg.updatedAt);
        if(state.lastSettingsChangeAt && remoteAt && remoteAt <= state.lastSettingsChangeAt) return;

        let changed=false;
        if(Array.isArray(cfg.days) && JSON.stringify(cfg.days)!==JSON.stringify(state.days)){ state.days=cfg.days; state.selectedDayIndex=0; changed=true; }
        if(Number.isInteger(cfg.hourStart) && cfg.hourStart!==state.hourStart){ state.hourStart=cfg.hourStart; changed=true; }
        if(Number.isInteger(cfg.hourEnd) && cfg.hourEnd!==state.hourEnd){ state.hourEnd=cfg.hourEnd; changed=true; }
        if(changed){ saveLocal(); renderShell(); subscribeCloudCompat(); }
      }, err=> setSync('Cloud Abo Fehler: '+err.message, true));
    }
    function syncSettingsCompat(){
      if(!state.usingCloud) return Promise.resolve();
      const now = new Date();
      state.lastSettingsChangeAt = now;
      saveLocal();
      return fb.db.collection('settings').doc('config').set({
        days: state.days, hourStart: state.hourStart, hourEnd: state.hourEnd,
        updatedAt: now, updatedBy: fb.auth?.currentUser?.uid || null
      }, {merge:true}).catch(e=>{
        console.error(e);
        setSync('Cloud Einstellungen konnten nicht gespeichert werden. Nutze lokalen Modus', true);
        state.usingCloud=false;
        fb.unsub?.();
      });
    }
    function subscribeCloudCompat(){
      if(!state.days.length || !state.usingCloud) return;
      const q=fb.db.collection('bookings').where('dateISO','in',state.days);
      fb.unsub?.();
      fb.unsub=q.onSnapshot(snap=>{
        state.days.forEach(iso=> state.bookings[iso]=[]);
        snap.forEach(doc=>{ const it={...doc.data(), id:doc.id}; if(state.days.includes(it.dateISO)){ state.bookings[it.dateISO]??=[]; state.bookings[it.dateISO].push(it); }});
        renderShell(); saveLocal();
      }, err=> setSync('Cloud Abo Fehler: '+err.message, true));
    }
    async function cloudAddCompat(item){
      if(!state.usingCloud){ addLocal(item); return; }
      try{ await fb.db.collection('bookings').add({...item, createdAt:new Date(), createdBy: fb.auth?.currentUser?.uid || null}); }
      catch(e){ console.error(e); setSync('Cloud Schreiben fehlgeschlagen. Lokal gespeichert', true); addLocal(item); }
    }
    async function cloudDeleteCompat(item){
      if(!state.usingCloud){ deleteLocal(item); return; }
      try{ if(item.id) await fb.db.collection('bookings').doc(item.id).delete(); }
      catch(e){ console.error(e); setSync('Cloud L√∂schen fehlgeschlagen', true); }
    }

    function setAdmin(on){
      state.admin=!!on; saveLocal();
      qs('#btnLogin')?.classList.toggle('hidden', state.admin);
      qs('#btnLogout')?.classList.toggle('hidden', !state.admin);
      qs('#adminPanel')?.classList.toggle('hidden', !state.admin);
      qs('#btnDaysSetup').classList.toggle('hidden', !state.admin || state.days.length===5);
      qs('#btnDaysEdit').classList.toggle('hidden', !state.admin || state.days.length!==5);
      updateUIDOutput();
      renderShell();
    }
    function doLogin(pin){
      if(pin!==ADMIN_PIN){ alert('Falsche PIN'); return; }
      setAdmin(true);
      closeDialog(qs('#dlgLogin'));
      if (pendingOpenDays || state.days.length!==5) { pendingOpenDays = false; openDaysDialog(); }
    }
    function updateUIDOutput(){
      const el=qs('#uidOut'); const btn=qs('#btnCopyUID'); const uid=fb?.auth?.currentUser?.uid || '';
      if(!el) return; if(state.admin && uid){ el.textContent='UID '+uid; btn?.classList.remove('hidden'); } else { el.textContent='keine UID'; btn?.classList.add('hidden'); }
    }

    function renderShell(){
      renderDayStrip();
      renderTimeline();
      renderDots();
      qs('#hourStart').value = state.hourStart;
      qs('#hourEnd').value = state.hourEnd;
      const hasDays = state.days.length===5;
      qs('#emptyMsg').classList.toggle('hidden', hasDays);
      qs('#setupNotice').classList.toggle('hidden', hasDays);
      qs('#daysCta').classList.toggle('hidden', hasDays);
      showSwipeHintIfNeeded();
    }

    function renderDayStrip(){
      const wrap=qs('#dayStrip'); wrap.innerHTML='';
      if(!state.days.length){ wrap.innerHTML='<span class="text-xs text-slate-600 px-2 py-1">Bitte Tage festlegen</span>'; return; }
      state.days.forEach((iso,i)=>{
        const d=makeDateFromISO(iso);
        const b=document.createElement('button');
        b.className = 'px-3 py-2 rounded-full text-sm font-semibold transition ' + (i===state.selectedDayIndex ? 'bg-white shadow' : 'pill');
        b.textContent=fmt.format(d);
        b.addEventListener('click', ()=>{ setDayIndex(i); });
        wrap.appendChild(b);
      });
    }

    function setDayIndex(i){
      const max = state.days.length - 1;
      const next = Math.max(0, Math.min(max, i));
      if (next === state.selectedDayIndex) return;
      state.selectedDayIndex = next;
      saveLocal();
      renderDayStrip();
      renderTimeline();
      renderDots();
    }

    function slotInfo(dateISO, hour){
      const items=state.bookings[dateISO]||[];
      const start=items.find(x=> x.hour===hour && x.kind!=='free');
      if(start) return {kind:start.kind, item:start};
      const prev=items.find(x=> x.hour===hour-1 && x.duration===2);
      if(prev) return {kind:prev.kind, item:prev};
      return {kind:'free'};
    }
    function isSlotFree(dateISO, hour){ return slotInfo(dateISO, hour).kind==='free'; }

    function renderTimeline(){
      const list=qs('#timeline'); list.innerHTML='';
      if(state.days.length!==5){ return; }
      const iso=state.days[state.selectedDayIndex];
      for(let h=state.hourStart; h<state.hourEnd; h++){
        const info=slotInfo(iso, h);
        const li=document.createElement('li');
        const btn=document.createElement('button');
        btn.className='slot w-full glass border border-white/60 rounded-2xl px-4 py-3 text-left';
        btn.dataset.date=iso; btn.dataset.hour=String(h);
        if(info.kind==='visit') btn.classList.add('slot-booked');
        if(info.kind==='block') btn.classList.add('slot-blocked');

        const left=`<div class="text-sm font-semibold">${hourLabel(h)}</div>`;
        let right='';
        if(info.kind==='free'){
          right = `<div class="inline-flex items-center gap-2 text-emerald-700"><span class="w-2 h-2 rounded-full bg-emerald-500"></span>Frei</div>`;
          bindSlotInteractions(btn, iso, h);
        }else if(info.kind==='visit'){
          const it=info.item;
          const labelDur = it.stayMin ? `${it.stayMin} Min` : (it.duration===2 ? '2h' : '1h');
          right = `<div class="flex flex-col"><div class="font-semibold text-emerald-800">Besuch ${escapeHTML(it.name)}</div><div class="text-xs text-slate-600">${labelDur}${it.note?' ¬∑ '+escapeHTML(it.note):''}</div></div>`;
          if(state.admin) btn.addEventListener('click', ()=>{ if(confirm('Buchung l√∂schen')) cloudDeleteCompat(it); });
        }else{
          const it=info.item;
          right = `<div class="flex flex-col"><div class="font-semibold text-slate-700">Blockiert</div><div class="text-xs text-slate-600">${escapeHTML(it.note||'Blockiert')}</div></div>`;
          if(state.admin) btn.addEventListener('click', ()=>{ if(confirm('Block aufheben')) cloudDeleteCompat(it); });
        }
        btn.innerHTML = `<div class="flex items-center justify-between">${left}<div class="ml-3"></div></div>`;
        btn.querySelector('.ml-3').innerHTML=right;
        li.appendChild(btn); list.appendChild(li);
      }
    }

    function bindSlotInteractions(btn, iso, hour){
      btn.addEventListener('click', ()=>{
        if(state.admin && state.blockMode){ quickBlock(iso, hour); return; }
        onFreeClick(iso, hour);
      });
      let pressTimer;
      const startPress = () => { if(!state.admin) return; pressTimer = setTimeout(()=> quickBlock(iso, hour), 500); };
      const cancelPress = () => { clearTimeout(pressTimer); };
      btn.addEventListener('touchstart', startPress, {passive:true});
      btn.addEventListener('touchend', cancelPress);
      btn.addEventListener('touchmove', cancelPress);
      btn.addEventListener('mousedown', startPress);
      btn.addEventListener('mouseleave', cancelPress);
      btn.addEventListener('mouseup', cancelPress);
    }

    function quickBlock(dateISO, hour){
      if(!isSlotFree(dateISO, hour)){ alert('Slot ist belegt'); return; }
      cloudAddCompat({kind:'block', note:'Blockiert', dateISO, hour, duration:1});
    }

    function onFreeClick(dateISO, hour){
      state._selected = {dateISO, hour};
      qs('#dlgBookWhen').textContent = humanWhen(dateISO,hour);
      qs('#inName').value=''; qs('#inNote').value='';
      openDialog(qs('#dlgBook'));
    }
    function humanWhen(dateISO, hour){ const d=makeDateFromISO(dateISO); return `${fmt.format(d)} ¬∑ ${hourLabel(hour)}`; }

    async function onConfirmBooking(){
      const sel=state._selected; if(!sel) return;
      const name=qs('#inName').value.trim();
      const note=qs('#inNote').value.trim();
      const stayMin = 30;        // gew√ºnschte Aufenthaltsdauer
      const duration = 1;        // blockierte Rasterdauer in Stunden
      if(!name){ alert('Bitte Name eintragen'); return; }
      if(!isSlotFree(sel.dateISO, sel.hour)){ alert('Slot ist nicht mehr frei'); return; }
      await cloudAddCompat({kind:'visit', name, note, stayMin, dateISO: sel.dateISO, hour: sel.hour, duration});
      closeDialog(qs('#dlgBook'));
      celebrate();
    }

    async function onConfirmBlock(){
      const sel = state._selected;
      if(!sel){ alert('Kein Slot gew√§hlt'); closeDialog(qs('#dlgBlock')); return; }
      const note = qs('#inBlockReason').value.trim() || 'Blockiert';
      const duration = Number(qs('#inBlockDuration').value) || 1;
      if(!isSlotFree(sel.dateISO, sel.hour)){ alert('Slot ist belegt'); return; }
      if(duration===2){
        if(sel.hour+1>=state.hourEnd){ alert('Zweite Stunde liegt au√üerhalb'); return; }
        if(!isSlotFree(sel.dateISO, sel.hour+1)){ alert('Die zweite Stunde ist belegt'); return; }
      }
      await cloudAddCompat({kind:'block', note, dateISO: sel.dateISO, hour: sel.hour, duration});
      closeDialog(qs('#dlgBlock'));
    }

    function clearCurrentDay(){
      if(!state.days.length) return;
      const iso=state.days[state.selectedDayIndex];
      const items=(state.bookings[iso]||[]).slice();
      if(!items.length){ alert('Keine Eintr√§ge'); return; }
      if(!confirm('Alle Eintr√§ge dieses Tages l√∂schen')) return;
      items.forEach(it=> cloudDeleteCompat(it));
    }

    function openDaysDialog(){
      const ids=['d1','d2','d3','d4','d5']; const vals=state.days.slice(0,5);
      ids.forEach((id,i)=> qs('#'+id).value = vals[i] || '');
      openDialog(qs('#dlgDays'));
    }
    async function saveDaysFromDialog(){
      const ids=['d1','d2','d3','d4','d5'];
      const arr=ids.map(id=> qs('#'+id).value).filter(Boolean);
      if(arr.length!==5){ alert('Bitte genau f√ºnf Tage w√§hlen'); return; }
      if(new Set(arr).size!==5){ alert('Tage d√ºrfen sich nicht wiederholen'); return; }
      state.days=arr; state.selectedDayIndex=0;
      state.lastSettingsChangeAt = new Date();
      saveLocal();
      renderShell();
      try { await syncSettingsCompat(); subscribeCloudCompat(); } catch {}
      closeDialog(qs('#dlgDays'));
    }
    function fillNext5(){
      const today = new Date();
      const ids=['d1','d2','d3','d4','d5'];
      for(let i=0;i<5;i++){
        const d = new Date(today); d.setDate(today.getDate()+i);
        qs('#'+ids[i]).value = toISO(d);
      }
    }

    function addLocal(item){ state.bookings[item.dateISO]??=[]; state.bookings[item.dateISO].push({...item, id:Math.random().toString(36).slice(2)}); saveLocal(); renderTimeline(); }
    function deleteLocal(item){ const arr=state.bookings[item.dateISO]||[]; const i=arr.findIndex(x=>x.id===item.id); if(i>=0) arr.splice(i,1); saveLocal(); renderTimeline(); }

    function centerToast(msg='Danke f√ºr deinen Eintrag', ms=1600){
      const t=qs('#centerToast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=> t.classList.remove('show'), ms);
    }
    function celebrate(){ centerToast(); if(window.matchMedia('(max-width: 767px)').matches){ startFireworks(1200); if(navigator.vibrate) navigator.vibrate(40); } }
    function startFireworks(durationMs=1500){
      const cv=qs('#fx'); const ctx=cv.getContext('2d'); const DPR=Math.max(1, window.devicePixelRatio||1);
      function resize(){ cv.width=innerWidth*DPR; cv.height=innerHeight*DPR; } resize();
      let parts=[]; const colors=['#ff7aa2','#ff9fb9','#ffd6e7','#ffffff'];
      function burst(x,y){ for(let i=0;i<22;i++){ const a=Math.random()*Math.PI*2; const s=1.5+Math.random()*2.2; parts.push({x,y,vx:Math.cos(a)*s,vy:Math.sin(a)*s-1.2,life:1,color:colors[(Math.random()*colors.length)|0]}); } }
      for(let i=0;i<3;i++){ setTimeout(()=> burst((0.2+0.6*Math.random())*cv.width,(0.25+0.35*Math.random())*cv.height), i*260); }
      const start=performance.now(); (function loop(t){
        ctx.clearRect(0,0,cv.width,cv.height);
        parts.forEach(p=>{ p.vy+=0.05; p.x+=p.vx*DPR*2; p.y+=p.vy*DPR*2; p.life-=0.015+Math.random()*0.01; ctx.globalAlpha=Math.max(0,p.life); ctx.fillStyle=p.color; ctx.beginPath(); ctx.arc(p.x,p.y,2.2*DPR,0,Math.PI*2); ctx.fill(); });
        parts=parts.filter(p=>p.life>0 && p.y<cv.height+8*DPR);
        if(t-start<durationMs || parts.length) requestAnimationFrame(loop); else ctx.clearRect(0,0,cv.width,cv.height);
      })(start);
      window.addEventListener('resize', resize, { once:true });
    }

    function initSwipe(){
      const el = qs('#appMain');
      let sx=0, sy=0, st=0;
      el.addEventListener('touchstart', e=>{
        const t=e.changedTouches[0]; sx=t.clientX; sy=t.clientY; st=Date.now();
      }, {passive:true});
      el.addEventListener('touchend', e=>{
        const t=e.changedTouches[0]; const dx=t.clientX-sx; const dy=t.clientY-sy; const dt=Date.now()-st;
        const ax=Math.abs(dx), ay=Math.abs(dy);
        if(ax>60 && ay<50 && dt<700){
          if(dx<0) setDayIndex(state.selectedDayIndex+1);
          else setDayIndex(state.selectedDayIndex-1);
          hideSwipeHint();
        }
      });
      window.addEventListener('keydown', e=>{
        if(e.key==='ArrowRight') { setDayIndex(state.selectedDayIndex+1); hideSwipeHint(); }
        if(e.key==='ArrowLeft') { setDayIndex(state.selectedDayIndex-1); hideSwipeHint(); }
      });
    }
    function renderDots(){
      const dots = qs('#pageDots'); dots.innerHTML='';
      const n = state.days.length===5 ? 5 : 0;
      for(let i=0;i<n;i++){
        const d=document.createElement('span');
        d.className='dot'+(i===state.selectedDayIndex?' active':'');
        dots.appendChild(d);
      }
    }
    function showSwipeHintIfNeeded(){
      const seen = localStorage.getItem(LS_KEY_HINT)==='1';
      const hint = qs('#swipeHint');
      if(!hint) return;
      if(seen || state.days.length!==5) { hint.classList.remove('show'); return; }
      hint.classList.add('show');
      setTimeout(()=> hint.classList.remove('show'), 2200);
    }
    function hideSwipeHint(){ localStorage.setItem(LS_KEY_HINT,'1'); qs('#swipeHint')?.classList.remove('show'); }

    function initUI(){
      qs('#btnLogin')?.addEventListener('click', ()=> openDialog(qs('#dlgLogin')));
      qs('#btnCancelLogin')?.addEventListener('click', ()=> closeDialog(qs('#dlgLogin')));
      qs('#btnLoginConfirm')?.addEventListener('click', ()=> doLogin(qs('#inPin').value.trim()));
      qs('#inPin')?.addEventListener('keydown', e=>{ if(e.key==='Enter') doLogin(e.target.value.trim()); });
      qs('#btnLogout')?.addEventListener('click', ()=> setAdmin(false));

      qs('#btnOpenDays')?.addEventListener('click', ()=>{
        if(state.admin) openDaysDialog();
        else { pendingOpenDays = true; openDialog(qs('#dlgLogin')); }
      });

      qs('#hourStart').addEventListener('change', e=>{ state.hourStart=clampHour(Number(e.target.value)); saveLocal(); syncSettingsCompat(); renderTimeline(); });
      qs('#hourEnd').addEventListener('change', e=>{ state.hourEnd=clampHour(Number(e.target.value)); saveLocal(); syncSettingsCompat(); renderTimeline(); });

      qs('#btnBlockToggle').addEventListener('click', ()=>{
        state.blockMode = !state.blockMode;
        qs('#btnBlockToggle').classList.toggle('bg-rose-700', state.blockMode);
        qs('#btnBlockToggle').textContent = state.blockMode ? 'Blockmodus aktiv' : 'Blockmodus';
      });
      qs('#btnCancelBlock').addEventListener('click', ()=> closeDialog(qs('#dlgBlock')));
      qs('#btnConfirmBlock').addEventListener('click', onConfirmBlock);
      qs('#btnClearDay').addEventListener('click', clearCurrentDay);
      qs('#btnCopyUID')?.addEventListener('click', ()=>{
        const uid=fb?.auth?.currentUser?.uid || ''; if(!uid){ alert('Keine UID'); return; } navigator.clipboard?.writeText(uid); alert('UID kopiert');
      });

      qs('#btnCancelBooking').addEventListener('click', ()=> closeDialog(qs('#dlgBook')));
      qs('#btnConfirmBooking').addEventListener('click', onConfirmBooking);

      qs('#btnDaysSetup').addEventListener('click', openDaysDialog);
      qs('#btnDaysEdit').addEventListener('click', openDaysDialog);
      qs('#btnCancelDays').addEventListener('click', ()=> closeDialog(qs('#dlgDays')));
      qs('#btnSaveDays').addEventListener('click', saveDaysFromDialog);
      qs('#btnFillNext5').addEventListener('click', fillNext5);

      const url=new URL(location.href); const p=url.searchParams.get('days');
      if(p){ const arr=p.split(',').map(s=>s.trim()).filter(Boolean); if(arr.length===5){ state.days=arr; saveLocal(); } }

      initSwipe();
    }

    window.addEventListener('DOMContentLoaded', ()=>{
      loadLocal(); initUI(); renderShell(); if(state.admin) setAdmin(true);
      initFirebaseCompat();
    });
  </script>
</body>
</html>
