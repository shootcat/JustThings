<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>GAB Adventskalender Premium</title>
<meta name="theme-color" content="#0b0f17"/>
<style>
  :root{
    --bg:url('assets/bg.jpg');
    --glass: rgba(255,255,255,.10);
    --glass-strong: rgba(255,255,255,.22);
    --border: rgba(255,255,255,.18);
    --text:#fff; --muted:#e3e9f7; --gold:#ffd76a;
    /* Terminal Colors */
    --term-green: #5de07a;
    --term-glow: rgba(93, 224, 122, 0.6);
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0; font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:var(--text); background:#0b0f17; display:flex; flex-direction:column; min-height:100vh; overflow-x:hidden}
  
  .bgimg{position:fixed; inset:0; background:#0b0f17 radial-gradient(circle at 50% 0%, #1a253a, #0b0f17); background-image:var(--bg); background-position:center; background-size:cover; filter:blur(2px)}
  
  header{backdrop-filter:blur(10px); background:linear-gradient(180deg, rgba(12,18,28,.85), rgba(12,18,28,.4)); border-bottom:1px solid var(--border); position:sticky; top:0; z-index:10}
  .bar{display:flex; align-items:center; gap:12px; padding:12px 20px}
  
  /* Logo mit Interaktion */
  .logo{width:48px; height:48px; border-radius:14px; position:relative; cursor:pointer; background:conic-gradient(from 0deg, rgba(255,77,90,.45), rgba(255,215,106,.45), rgba(93,216,255,.45), rgba(53,224,122,.45), rgba(255,77,90,.45)); box-shadow:0 0 30px rgba(255,215,106,.25) inset, 0 0 40px rgba(93,216,255,.18) inset; transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);}
  .logo:active{transform: scale(0.9) rotate(-10deg);}
  .logo:hover{transform: scale(1.05);}
  .logo:after{content:"üéÑ"; position:absolute; inset:0; display:grid; place-items:center; font-size:22px}
  
  h1{font-size:22px; letter-spacing:.5px; margin:0} .spacer{flex:1}
  
  .btn{cursor:pointer; border:1px solid var(--border); background:var(--glass); color:var(--text); padding:8px 14px; border-radius:10px; transition:.2s; font-weight:600; font-size: 14px; display: inline-flex; align-items: center; gap: 6px;}
  .btn:hover{background:var(--glass-strong); transform:translateY(-1px)}
  .btn.gold{border-color:rgba(255,215,106,.5); box-shadow:0 0 20px rgba(255,215,106,.25) inset; color: var(--gold)}
  .btn-icon-only{padding: 8px; border-radius: 50%; width: 36px; height: 36px; justify-content: center;}

  .wrap{width:100%; max-width:1200px; margin:0 auto; padding:20px; flex:1 0 auto; position:relative; z-index:3}
  .panel{background:var(--glass); border:1px solid var(--border); border-radius:18px; padding:20px; box-shadow:0 8px 32px rgba(0,0,0,.25); margin-bottom: 20px;}
  
  .auth{max-width:680px; margin:40px auto; text-align:left} .row{display:flex; gap:10px; flex-wrap:wrap}
  .input{flex:1; min-width:220px; padding:12px 14px; border-radius:12px; border:1px solid var(--border); background:rgba(255,255,255,.05); color:#fff}
  label{display:block; margin:8px 0 6px 2px; color:var(--gold); font-weight:600}
  .hint{color:var(--muted); font-size:13px}
  
  /* --- Progress Bar --- */
  .progress-container { margin-bottom: 20px; }
  .progress-labels { display:flex; justify-content:space-between; font-size:13px; color:var(--muted); margin-bottom:6px; }
  .progress-track { height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden; position: relative; }
  .progress-fill { height: 100%; background: linear-gradient(90deg, #5de07a, #35e07a); width: 0%; transition: width 1s cubic-bezier(0.22, 1, 0.36, 1); box-shadow: 0 0 10px rgba(93, 224, 122, 0.5); }

  /* --- Grid Layout --- */
  .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; }
  @media (min-width: 500px) { .grid { grid-template-columns: repeat(3, 1fr); } }
  @media (min-width: 768px) { .grid { grid-template-columns: repeat(4, 1fr); } }
  @media (min-width: 1100px) { .grid { grid-template-columns: repeat(6, 1fr); } }
  
  .door{
    position:relative; height:120px; border-radius:16px; overflow:hidden; cursor:pointer; border:2px solid transparent; 
    background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.03)),
                radial-gradient(circle at 50% 0%, rgba(255,255,255,0.1), transparent 70%);
    display:flex; align-items:center; justify-content:center; 
    font-weight:900; font-size:26px; color:var(--text); text-shadow:0 2px 10px rgba(0,0,0,.35); 
    transition: transform 0.2s, box-shadow 0.2s;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
  }
  
  .door:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.3); }
  .door:active { transform: scale(0.98); }
  
  .door.locked{opacity:.6; cursor:not-allowed; border-color:rgba(255,255,255,.04); background: rgba(255,255,255,0.03);}
  
  .door.opened{
    border-color:rgba(93,216,255,.4); 
    background: rgba(0,0,0,0.3); 
    box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
  }
  
  .door .badge{position:absolute; top:8px; right:8px; background:rgba(255,215,106,.25); border:1px solid var(--border); padding:2px 8px; border-radius:10px; font-size:11px}
  .door .emoji{position:absolute; left:10px; top:8px; font-size: 18px; opacity: 0.8} 
  .door .num{position:relative; z-index:2; font-size: 32px;}
  
  .door.opened img.thumb{
    position:absolute; inset:0; width:100%; height:100%; object-fit:cover; 
    filter: none; 
    z-index: 0; opacity: 1;
    transition: transform 0.3s;
  }
  .door.opened:hover img.thumb { transform: scale(1.05); }
  .door.opened .num { opacity: 0.7; text-shadow: 0 2px 8px rgba(0,0,0,0.8); }

  .door.day-24 {
    border: 1px solid rgba(255, 215, 106, 0.6);
    background: linear-gradient(135deg, rgba(255, 215, 106, 0.15), rgba(255, 215, 106, 0.02));
  }
  .door.day-24 .num { color: var(--gold); }

  @keyframes shake { 0%, 100% {transform:translateX(0)} 25%{transform:translateX(-4px) rotate(-2deg)} 75%{transform:translateX(4px) rotate(2deg)} }
  .door.shake { animation: shake 0.4s ease-in-out; }

  .footer{padding:20px; text-align:center; color:var(--muted); border-top:1px solid var(--border); font-size: 14px;}
  
  /* Modal */
  .modal-backdrop{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(5,8,12,.85); z-index:50; backdrop-filter: blur(5px);}
  .modal{width:min(720px, 92vw); background:rgba(20,24,35,.95); border:1px solid var(--border); border-radius:24px; overflow:hidden; box-shadow:0 25px 80px rgba(0,0,0,.6); transform: scale(0.95); transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.2s; opacity: 0;}
  .modal.active { transform: scale(1); opacity: 1; }
  .modal .head{display:flex; align-items:center; gap:12px; padding:16px 20px; border-bottom:1px solid var(--border); background: rgba(255,255,255,0.03)} 
  .modal .body{padding:24px}
  
  .reward{display:flex; gap:20px; align-items:flex-start}
  .reward .icon{width:80px; height:80px; border-radius:20px; display:grid; place-items:center; font-size:40px; background:linear-gradient(135deg, rgba(93,216,255,.2), rgba(255,215,106,.2)); border:1px solid var(--border); flex-shrink: 0; box-shadow: 0 10px 30px rgba(0,0,0,0.2)}
  
  .voucher{margin-top:16px; padding:16px; border:1px dashed var(--gold); border-radius:16px; background:rgba(255,215,106,.08)}
  .voucher .line{display:flex; gap:10px; align-items:center; margin-top:8px} .voucher .label{width:120px; color:var(--muted); font-size: 14px;}
  
  .print-area{display:none}
  @media print{ header,.wrap,.footer{display:none} .print-area{display:block; padding:28px; font-family:Inter, Arial, sans-serif} .print-card{border:2px dashed #333; border-radius:12px; padding:20px} }
  
  .toast{position:fixed; bottom:24px; right:24px; background:rgba(25,32,48,.95); color:#fff; border:1px solid var(--border); padding:14px 18px; border-radius:14px; box-shadow:0 10px 40px rgba(0,0,0,.4); opacity:0; transform:translateY(10px); transition:.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 100; display: flex; align-items: center; gap: 10px;}
  .toast.show{opacity:1; transform:translateY(0)}
  
  #santa{ position:fixed; top:15%; left:-200px; font-size:60px; pointer-events:none; z-index:5; filter:drop-shadow(0 10px 20px rgba(0,0,0,0.5)); opacity: 0.9; transition: transform 0.2s; }
  @keyframes flySanta {
    0% { left: -200px; transform: translateY(0) rotate(5deg); }
    25% { transform: translateY(20px) rotate(0deg); }
    50% { transform: translateY(-20px) rotate(-5deg); }
    75% { transform: translateY(10px) rotate(2deg); }
    100% { left: 110vw; transform: translateY(0) rotate(5deg); }
  }

  /* Countdown & ASCII Cinema */
  #countdownOverlay{
    position:fixed; inset:0; display:none; z-index:40;
    background:rgba(5,8,12,.9); backdrop-filter: blur(12px);
    align-items:center; justify-content:center; flex-direction:column; text-align:center; padding:20px;
    overflow-y: auto; /* Falls Screen sehr klein ist */
  }
  #countdownOverlay .box{ max-width:700px; margin:20px auto; color:#fff; width:100%; }
  #countdownOverlay .timer{ font-weight:800; font-size:clamp(32px, 6vw, 64px); letter-spacing:-1px; background: linear-gradient(to bottom, #fff, #aaa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 10px; font-variant-numeric: tabular-nums; }
  
  /* ASCII Cinema Styles entfernt */

  table{width:100%; border-collapse:collapse} th,td{padding:12px; border-bottom:1px solid var(--border)} th{text-align:left; color:var(--gold)}
</style>
</head>
<body>
  <div class="bgimg" aria-hidden="true"></div>
  <canvas id="fx" aria-hidden="true" style="position:fixed; inset:0; width:100%; height:100%; pointer-events:none; z-index:1"></canvas>
  <div id="santa">üéÖüõ∑üí®</div>
  <canvas id="confetti" aria-hidden="true" style="position:fixed; inset:0; width:100%; height:100%; pointer-events:none; z-index:60"></canvas>

  <header>
    <div class="bar">
      <div class="logo" id="appLogo" aria-hidden="true"></div>
      <h1>GAB Adventskalender</h1>
      <div class="spacer"></div>
      <button class="btn btn-icon-only" id="btn-mute" title="Sound an/aus" style="margin-right:8px">üîä</button>
      <div id="userBox" class="muted" style="font-size:14px; margin-right:10px"></div>
      <button class="btn" id="btn-signout" style="display:none">Abmelden</button>
      <button class="btn" id="btn-how">Info</button>
    </div>
  </header>

  <div class="wrap">
    <div class="panel auth" id="authPanel">
      <h2 style="margin:4px 0 14px 0">Anmelden oder registrieren</h2>
      <div class="hint" id="authModeHint">Im DEMO-Modus bleiben Daten lokal.</div>
      <div class="row" style="margin-top:14px">
        <div style="flex:1; min-width:260px">
          <label for="name">Anzeigename</label>
          <input id="name" class="input" placeholder="Z. B. Max Mustermann" autocomplete="name"/>
          <label for="email">E-Mail</label>
          <input id="email" class="input" placeholder="name@firma.de" autocomplete="email"/>
          <label for="pw">Passwort</label>
          <input id="pw" class="input" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="new-password"/>
        </div>
      </div>
      <div class="row" style="margin-top:16px">
        <button type="button" class="btn gold" id="btn-register">Registrieren</button>
        <button type="button" class="btn" id="btn-login">Anmelden</button>
      </div>
      <div id="authMsg" class="hint" style="margin-top:10px; color:#ff6b6b"></div>
    </div>

    <div class="panel" id="kalPanel" style="display:none">
      <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:14px">
        <div>
          <h2 style="margin:0 0 4px 0; font-size:20px">Dein Kalender</h2>
          <div class="muted" style="font-size:14px">Willkommen, <strong id="who" style="color:#fff">‚Äì</strong></div>
        </div>
        <div id="devWarning" style="display:none; font-size:12px; color:var(--gold); border:1px solid var(--gold); padding:4px 8px; border-radius:6px">‚ö†Ô∏è Sim-Mode</div>
      </div>
      <div class="progress-container">
        <div class="progress-labels"><span>Fortschritt</span><span id="progressText">0 / 24</span></div>
        <div class="progress-track"><div class="progress-fill" id="progressFill"></div></div>
      </div>
      <div class="grid" id="grid"></div>
    </div>

    <div class="panel" id="boardPanel" style="display:none; margin-top:16px">
      <h3>√úbersicht Team</h3>
      <div id="board"></div>
      <div id="adminTools" style="margin-top:16px; display:none; border-top:1px solid var(--border); padding-top:16px">
        <h4 style="margin:0 0 10px 0">Voucher Terminal</h4>
        <div class="row" style="align-items:center">
          <input id="admCode" class="input" placeholder="Code eingeben..." style="min-width:260px"/>
          <button class="btn" id="btnVerify">Pr√ºfen</button>
          <button class="btn gold" id="btnRedeem">Einl√∂sen</button>
        </div>
        <div id="admMsg" class="hint" style="margin-top:8px"></div>
      </div>
    </div>
  </div>

  <div class="footer">¬© 2025 GAB Neumann GmbH | Interner Spa√ükalender</div>

  <div class="modal-backdrop" id="backdrop">
    <div class="modal" id="modalBox">
      <div class="head"><strong id="modalTitle">T√ºrchen</strong><div class="spacer"></div><button class="btn" id="closeModal">‚úï</button></div>
      <div class="body" id="modalBody"></div>
    </div>
  </div>

  <!-- UPDATED COUNTDOWN OVERLAY -->
  <div id="countdownOverlay" aria-hidden="true">
    <div class="box">
      <!-- ASCII Animation entfernt -->
      
      <!-- Titel -->
      <h2 style="color:var(--gold); margin:0 0 10px 0; font-size:clamp(18px, 4vw, 24px); text-shadow:0 0 20px rgba(255,215,106,.4)">
        üéÑ Dein pers√∂hnlicher GAB Online Adventskallender üéÑ
      </h2>

      <!-- Timer -->
      <div class="timer" id="cdTimer">--:--:--</div>
      <div class="msg" id="cdText" style="margin-bottom:30px; color:var(--muted)">Warten auf den Start...</div>

      <!-- Info Box "Was dich erwartet" -->
      <div style="padding:20px; border:1px dashed var(--border); border-radius:16px; background:rgba(255,255,255,0.03); text-align:left; margin:0 auto; width:100%">
        <h3 style="margin-top:0; color:var(--gold); font-size:16px; display:flex; align-items:center; gap:8px">
          <span>üéÅ</span> Was dich in diesem Kalender erwartet:
        </h3>
        <ul style="margin:0; padding-left:20px; color:var(--muted); line-height:1.6; font-size:14px">
          <li style="margin-bottom:6px">T√§gliche <strong>Motivation, Witze & Fakten</strong> f√ºr den B√ºro-Alltag</li>
          <li style="margin-bottom:6px">Chance auf exklusive <strong>Essensgutscheine f√ºr Freitage</strong> und <strong>Snack&Sweets Gutscheine</strong> f√ºr den kleinen Hunger nebenbei auf der Arbeit</li>
          <li><strong>Kleine √úberraschungen</strong> und interaktive Momente</li>
        </ul>
      </div>
    </div>
  </div>

  <div class="print-area" id="printArea"></div>
  <div class="toast" id="toast"></div>

  <script type="module">
  // Die Variable IS_DEMO wird nun auf Basis der Canvas Umgebungsvariablen gesetzt.
  // Wenn __firebase_config definiert ist, wird der Live-Modus verwendet.
  const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
  const IS_DEMO = !firebaseConfig; 
  const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
  
  // Zeige den Hinweis f√ºr den Demo-Modus an
  if(IS_DEMO) {
    document.getElementById('authModeHint').textContent = 'Live-Modus nicht verf√ºgbar. Daten bleiben lokal gespeichert.';
  } else {
    document.getElementById('authModeHint').textContent = 'Im Live-Modus werden deine Fortschritte in der Cloud gespeichert.';
  }


  const DOOR_IMAGES = true; 
  const urlParams = new URLSearchParams(window.location.search);
  const simDateParam = urlParams.get('sim_date');

  const CONFIG = {
    bgImage:'assets/bg.jpg',
    sfx:{ open:['assets/sfx/open.mp3'], win:['assets/sfx/win.mp3'], click:['assets/sfx/click.mp3'], hoho:['assets/sfx/hoho.mp3'] }, 
    probabilities:{ mealVoucher:0.0025, snackVoucher:0.15 }, 
    year:2025, startMonth:12, days:24
  };
  document.documentElement.style.setProperty('--bg', `url('${CONFIG.bgImage}')`);

  let isMuted = localStorage.getItem('gab_muted') === 'true';
  const btnMute = document.getElementById('btn-mute');
  function updateMuteUI(){
    btnMute.textContent = isMuted ? 'üîá' : 'üîä';
    btnMute.style.opacity = isMuted ? '0.5' : '1';
  }
  updateMuteUI();
  btnMute.onclick = () => { isMuted = !isMuted; localStorage.setItem('gab_muted', isMuted); updateMuteUI(); };
  function playSFX(k){ if(isMuted) return; const s=CONFIG.sfx[k]; if(s) new Audio(s[0]).play().catch(()=>{}); }

  function triggerSanta(){
    const el = document.getElementById('santa');
    if(el.style.animationName === 'flySanta') return; 
    el.style.animation = 'flySanta 6s linear forwards';
    if(Math.random() > 0.5) setTimeout(()=>playSFX('hoho'), 500);
    setTimeout(() => { el.style.animation = ''; }, 6500); 
  }
  setInterval(() => { if(Math.random() > 0.3) triggerSanta(); }, 1000 * (45 + Math.random()*75));

  function getCurrentDate() {
    if (simDateParam) {
      const sim = new Date(simDateParam);
      if (!isNaN(sim.getTime())) {
        const now = new Date();
        sim.setHours(now.getHours(), now.getMinutes());
        return sim;
      }
    }
    return new Date();
  }
  if(simDateParam) { document.getElementById('devWarning').style.display = 'block'; }

  document.getElementById('appLogo').onclick = () => { playSFX('win'); triggerSanta(); CONFETTI.burst(window.innerWidth/2, window.innerHeight/2); _toast('üéÑ Ho Ho Ho! üéÑ'); };

  /* ===== ASCII CINEMA ENTFERNT ===== */

  /* ===== GROSSER POOL ===== */
  const MESSAGES = [
    {type:'fact', text:'Oktopusse haben drei Herzen und blaues Blut ‚Äì zwei pumpen zu den Kiemen, eines durch den K√∂rper.'},
    {type:'fact', text:'Wenn du ein Blatt Papier 42-mal falten k√∂nntest, w√§re es theoretisch so dick, dass es bis zum Mond reicht.'},
    {type:'fact', text:'Bienen erkennen menschliche Gesichter ‚Äì sie nutzen √§hnliche Mustererkennung wie wir.'},
    {type:'fact', text:'Im Inneren eines Blitzes ist es f√ºnfmal hei√üer als an der Oberfl√§che der Sonne.'},
    {type:'fact', text:'Ein Teel√∂ffel Erde enth√§lt mehr Mikroorganismen als es Menschen auf der Erde gibt.'},
    {type:'fact', text:'Manche Tiefseefische nutzen Biolumineszenz als Tarnung ‚Äì sie leuchten ihr Bauchprofil, um von unten unsichtbar zu werden.'},
    {type:'fact', text:'Saturn hat eine geringere Dichte als Wasser ‚Äì in einem ausreichend gro√üen Becken w√ºrde er theoretisch schwimmen.'},
    {type:'fact', text:'In Island gibt es keine heimischen Moskitos ‚Äì die schnellen Temperaturwechsel st√∂ren ihren Lebenszyklus.'},
    {type:'fact', text:'Die ISS umkreist die Erde in ~90 Minuten ‚Äì Astronauten sehen etwa 16 Sonnenauf- und -unterg√§nge pro Tag.'},

    {type:'link', text:'https://thisissand.com/', label:'üèñÔ∏è This is Sand', desc:'Male digitale Sandbilder ‚Äì meditativ und entspannend.'},
    {type:'link', text:'https://weirdorconfusing.com/', label:'üõí Weird or Confusing', desc:'V√∂llig absurde Produkte aus dem Internet.'},
    {type:'link', text:'https://stars.chromeexperiments.com/', label:'üåå 100.000 Stars', desc:'Ein interaktiver Flug durch unsere Galaxie.'},
    {type:'link', text:'https://neal.fun/size-of-space/', label:'üöÄ Size of Space', desc:'Vergleiche interaktiv Gr√∂√üen ‚Äì vom Menschen bis zur Galaxie.'},
    {type:'link', text:'https://radio.garden/', label:'üåç Radio Garden', desc:'H√∂re Live-Radio aus jedem Winkel der Erde ‚Äì per Globus.'},
    {type:'link', text:'https://pointerpointer.com/', label:'üëÜ Pointer Pointer', desc:'Jemand zeigt immer genau auf deine Maus.'},
    {type:'link', text:'https://patatap.com/', label:'üéµ Patatap', desc:'Erstelle Musik mit der Tastatur ‚Äì jede Taste hat einen Sound.'},

    {type:'joke', text:'Warum war der Mathebuchautor ungl√ºcklich? Weil er zu viele Probleme hatte.'},
    {type:'joke', text:'Treffen sich zwei Schneeflocken ‚Äì sagt die eine: ‚ÄûIch hab das Gef√ºhl, wir treiben hier auseinander.‚Äú'},
    {type:'joke', text:'Was macht ein Pirat am Computer? ‚Äì Er dr√ºckt die Enter-Taste.'},
    {type:'joke', text:'Warum k√∂nnen Geister so schlecht l√ºgen? ‚Äì Weil man direkt durch sie hindurchsieht.'},
    {type:'joke', text:'Ein Photon checkt ins Hotel ein. Der Portier fragt: ‚ÄûHaben Sie Gep√§ck?‚Äú ‚Äì ‚ÄûNein, ich reise licht.‚Äú'},
    {type:'joke', text:'Wie nennt man einen Bumerang, der nicht zur√ºckkommt? ‚Äì Einen Stock.'},
    {type:'joke', text:'Warum war der Astronaut schlecht im Smalltalk? ‚Äì Ihm fehlte einfach die Atmosph√§re.'},
    {type:'joke', text:'Was ist das Lieblingsgetr√§nk von Programmierern? ‚Äì Java.'},
    {type:'joke', text:'Warum k√∂nnen Orangen nicht rennen? ‚Äì Weil sie ausgepresst sind.'},
    {type:'joke', text:'Was macht ein Keks unter einem Baum? ‚Äì Kr√ºmel!'},

    // PREMIUM EXTRAS
    {type:'quote', text:'Motivation des Tages: Auch diesen Arbeitstag darfst du mit deinen Kollegen hier verbringen!'},
    {type:'quote', text:'Mach es wie der Weihnachtsmann: Sei einfach mal nicht da.'},
    {type:'quote', text:'Das sch√∂nste am Job ist, dass sich der Stuhl dreht.'},
    {type:'quote', text:'Denke immer daran: Dein PC war auch mal ein Sandkorn.'},
    {type:'link', text:'https://quickdraw.withgoogle.com/', label:'üé® Quick Draw', desc:'Kann eine KI deine Kritzeleien erkennen?'},
    {type:'link', text:'https://zoomquilt.org/', label:'üåÄ ZoomQuilt', desc:'Ein hypnotisches, endloses Zoom-Gem√§lde.'},
    {type:'link', text:'https://paveldogreat.github.io/WebGL-Fluid-Simulation/', label:'üíß Fluid Sim', desc:'Wirble bunte Fl√ºssigkeiten √ºber den Bildschirm.'},
    {type:'link', text:'https://littlealchemy2.com/', label:'‚öóÔ∏è Little Alchemy', desc:'Kombiniere Elemente und erschaffe neue Dinge.'},
    {
      type: 'joke',
      text: `Die Familie Schmukler stellt seit Generationen N√§gel her. Papa sagt zu seinem Sohn: "Fima, ich war 30 Jahre nicht im Urlaub. Du bleibst als Gesch√§ftsf√ºhrer hier, ich fahr mit Mama einen Monat weg." ‚Äì "Papa, ich bin doch Marketing-Mensch, kein Produktioner!" ‚Äì "Unsere Lager sind voll, verkauf einfach die N√§gel."
  Zwei Wochen sp√§ter ein Telegramm: "Papa, komm sofort zur√ºck, die N√§gel sind alle!" ‚Äì "Wie das?" ‚Äì "Ich hab Werbung gemacht." ‚Äì Auf dem Plakat: Jesus am Kreuz und der Slogan: "Schmukler-N√§gel halten seit 2000 Jahren." ‚Äì Papa: "Fima! Kein Jesus in der Werbung! Sofort runter!"
  Papa f√§hrt wieder weg. Zwei Wochen sp√§ter wieder ein Telegramm: "Papa, flieg sofort her, die N√§gel sind schon wieder alle." ‚Äì "Schon wieder Werbung?!" ‚Äì "Ja, aber ohne Jesus, versprochen." ‚Äì Auf dem Plakat: ein leeres Kreuz, ohne Jesus, mit dem Slogan: "H√§tten sie nur Schmukler-N√§gel gehabt‚Ä¶"`
    }
  ];

  function getCountdownTarget(){
    if (urlParams.has('cd')) return new Date(Date.now() + parseInt(urlParams.get('cd')) * 1000);
    return new Date(CONFIG.year, CONFIG.startMonth - 1, 1, 0, 0, 0);
  }
  function startCountdownOverlay(){
    const overlay = document.getElementById('countdownOverlay');
    const cdTimer = document.getElementById('cdTimer');
    const cdText = document.getElementById('cdText');
    if(!overlay) return;
    const target = getCountdownTarget();
    function render(){
      const now = getCurrentDate();
      if (now >= target){ overlay.style.display = 'none'; return; }
      const diff = target - now;
      const d = Math.floor(diff/86400000);
      const h = Math.floor((diff%86400000)/3600000);
      const m = Math.floor((diff%3600000)/60000);
      const s = Math.floor((diff%60000)/1000);
      cdTimer.textContent = `${d} Tage ${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
      cdText.innerHTML = `Bis es los geht!`;
      overlay.style.display = 'flex';
    }
    render(); setInterval(render, 1000);
  }
  setTimeout(startCountdownOverlay, 0);

  const FX = (()=>{ const cvs=document.getElementById('fx'); const ctx=cvs.getContext('2d',{alpha:true});
    let w=0,h=0,flakes=[],run=true;
    function resize(){ w=cvs.width=window.innerWidth; h=cvs.height=window.innerHeight; flakes=new Array(100).fill(0).map(()=>({x:Math.random()*w,y:Math.random()*h,r:Math.random()*3+1,s:Math.random()*1+0.5})) }
    function loop(){ 
      if(!run) return;
      ctx.clearRect(0,0,w,h); ctx.fillStyle='#fff'; ctx.beginPath();
      for(const f of flakes){ f.y+=f.s; if(f.y>h)f.y=-5; ctx.moveTo(f.x,f.y); ctx.arc(f.x,f.y,f.r,0,Math.PI*2); }
      ctx.fill(); requestAnimationFrame(loop);
    }
    window.onresize=resize; resize(); loop();
    return { toggle:()=>{ run=!run; if(run) loop(); } };
  })();

  const CONFETTI = (()=>{
    const cvs = document.getElementById('confetti'); const ctx = cvs.getContext('2d');
    let p = []; let w,h;
    const resize = () => { w=cvs.width=window.innerWidth; h=cvs.height=window.innerHeight; };
    window.onresize=resize; resize();
    const colors = ['#f00','#0f0','#00f','#ff0','#0ff','#f0f'];
    function loop(){
      if(!p.length)return; ctx.clearRect(0,0,w,h);
      p=p.filter(x=>x.l>0);
      p.forEach(x=>{ x.x+=x.vx; x.y+=x.vy; x.vy+=0.5; x.l--; ctx.fillStyle=x.c; ctx.fillRect(x.x,x.y,6,6); });
      requestAnimationFrame(loop);
    }
    return { burst:(x,y)=>{ for(let i=0;i<40;i++) p.push({x,y,vx:(Math.random()-.5)*20,vy:(Math.random()-1)*20,c:colors[Math.floor(Math.random()*colors.length)],l:100}); loop(); } }
  })();

  // Dynamische Auswahl des Service (Demo oder Live/Firebase)
  const svc = IS_DEMO ? await makeDemoService() : await makeLiveService();
  let state = { opened:{}, rewards:{}, isAuthReady: false }; // isAuthReady hinzugef√ºgt

  const grid = document.getElementById('grid');
  
  svc.onAuth(async user => {
    if(user){
      document.getElementById('authPanel').style.display='none';
      document.getElementById('kalPanel').style.display='block';
      document.getElementById('userBox').textContent = user.name;
      document.getElementById('who').textContent = user.name;
      document.getElementById('btn-signout').style.display='block';
      
      // Nur wenn die Authentifizierung abgeschlossen ist (Live-Modus)
      if (user.isAuthReady) {
          await svc.onUserDoc(user.uid, data => {
              state = data || { opened:{}, rewards:{} };
              renderGrid(user);
          });
          if(await svc.isAdmin(user.uid)){
              document.getElementById('boardPanel').style.display='block';
              document.getElementById('adminTools').style.display='block';
              svc.onAllUsers(renderBoard);
              // Admin Tool Handler registrieren
              setupAdminTools(svc);
          } else {
              // Admin Tools ausblenden, falls User kein Admin ist
              document.getElementById('boardPanel').style.display='none';
          }
      } else if (IS_DEMO) {
         // F√ºr den Demo-Modus, wo onAuth sofort feuert und onUserDoc nicht auf Auth warten muss
         await svc.onUserDoc(user.uid, data => {
              state = data || { opened:{}, rewards:{} };
              renderGrid(user);
          });
         if(await svc.isAdmin(user.uid)){
              document.getElementById('boardPanel').style.display='block';
              document.getElementById('adminTools').style.display='block';
              svc.onAllUsers(renderBoard);
              // Admin Tool Handler registrieren
              setupAdminTools(svc);
          } else {
              // Admin Tools ausblenden, falls User kein Admin ist
              document.getElementById('boardPanel').style.display='none';
          }
      }


    } else {
      document.getElementById('authPanel').style.display='block';
      document.getElementById('kalPanel').style.display='none';
      document.getElementById('boardPanel').style.display='none';
      document.getElementById('btn-signout').style.display='none';
    }
  });

  document.getElementById('btn-signout').onclick = () => svc.logout();
  document.getElementById('btn-login').onclick = async () => {
    try { await svc.login(document.getElementById('email').value, document.getElementById('pw').value); }
    catch(e){ document.getElementById('authMsg').textContent = e.message; }
  };
  document.getElementById('btn-register').onclick = async () => {
    try { await svc.register(document.getElementById('name').value, document.getElementById('email').value, document.getElementById('pw').value); }
    catch(e){ document.getElementById('authMsg').textContent = e.message; }
  };

  let lastJSON = '';
  function renderGrid(user){
    const json = JSON.stringify(state.opened);
    if(json === lastJSON && grid.hasChildNodes()) return;
    lastJSON = json;
    grid.innerHTML = '';
    const today = getCurrentDate();
    const curDay = today.getDate();
    const curMonth = today.getMonth()+1;
    const order = getDoorOrder(CONFIG.year);
    const openedCount = Object.keys(state.opened).length;
    const pct = Math.min(100, (openedCount / CONFIG.days) * 100);
    document.getElementById('progressFill').style.width = `${pct}%`;
    document.getElementById('progressText').textContent = `${openedCount} / ${CONFIG.days}`;

    for(let i=0; i<CONFIG.days; i++){
      const n = order[i];
      const isOpened = !!state.opened[n];
      // T√ºrchen ist gesperrt, wenn es nicht Dezember ist ODER der Tag noch nicht erreicht ist
      const isLocked = (curMonth < CONFIG.startMonth) || (curMonth === CONFIG.startMonth && n > curDay);
      const btn = document.createElement('button');
      btn.className = `door ${isOpened ? 'opened' : ''} ${isLocked ? 'locked' : ''} ${n===24 ? 'day-24' : ''}`;
      const em = n===24 ? 'üåü' : (n%6===0?'üéÅ':n%5===0?'üç™':n%4===0?'üïØÔ∏è':n%3===0?'‚ùÑÔ∏è':'üéÑ');
      btn.innerHTML = `<div class="emoji">${em}</div><div class="num">${n}</div>`;
      if(isOpened){
         if(DOOR_IMAGES){
             const img = document.createElement('img');
             img.className = 'thumb';
             img.src = `assets/doors/${String(n).padStart(2,'0')}.jpg`;
             img.onerror = () => { img.style.display='none'; };
             btn.appendChild(img);
         }
         const badge = document.createElement('div'); badge.className='badge'; badge.textContent='offen';
         btn.appendChild(badge);
      }
      btn.onclick = (e) => {
        if(isOpened){ showReward(n, state.rewards[n], user); } else {
           if(isLocked){
             btn.classList.add('shake');
             setTimeout(()=>btn.classList.remove('shake'), 500);
             playSFX('click');
             _toast(`Tag ${n} ist noch nicht dran!`);
           } else {
             const rect = btn.getBoundingClientRect();
             openDoor(user, n, rect.left+rect.width/2, rect.top+rect.height/2);
           }
        }
      };
      grid.appendChild(btn);
    }
  }

  async function openDoor(user, day, x, y){
    if (!user || !user.uid) return _toast('Fehler: Benutzer nicht angemeldet.');

    CONFETTI.burst(x,y);
    const seed = hash(`${user.uid}|${CONFIG.year}|${day}`);
    const rng = mul32(seed);
    const roll = rng();
    
    let reward;
    
    // Logik f√ºr Voucher Roll
    if(roll < CONFIG.probabilities.mealVoucher){
        const nonce = randHex(8);
        try {
          const sig = await svc.signVoucher({day, type:'meal', nonce});
          reward = { kind:'voucher', payload:{title:'Gratis Mittag', type:'meal', desc:'Gutschein f√ºr die Kantine (bis 4‚Ç¨)', code:sig.code, ...sig} };
          playSFX('win');
        } catch(e) { return _toast('Fehler beim Laden des Vouchers'); }
        
    } else if (roll < CONFIG.probabilities.mealVoucher + CONFIG.probabilities.snackVoucher) {
        const nonce = randHex(8);
        try {
          const sig = await svc.signVoucher({day, type:'snack', nonce});
          reward = { kind:'voucher', payload:{title:'S√º√üigkeit', type:'snack', desc:'Ein Snack nach Wahl an der Theke', code:sig.code, ...sig} };
          playSFX('win');
        } catch(e) { return _toast('Fehler beim Laden des Vouchers'); }

    } else {
        const msg = getMessageFor(user, day); 
        reward = { kind:'message', payload:msg };
        playSFX('open');
    }

    // Speichern des neuen Zustands
    const opened = {...state.opened, [day]:true};
    const rewards = {...state.rewards, [day]:reward};
    await svc.setUserDoc(user.uid, { opened, rewards });
    showReward(day, reward, user);
  }

  function showReward(day, reward, user){
    if(!reward) return;
    document.getElementById('modalTitle').textContent = `Inhalt T√ºrchen ${day}`;
    let h = '';
    const hero = DOOR_IMAGES ? `<div style="position:relative; height:180px; border-radius:12px; overflow:hidden; margin-bottom:16px; border:1px solid var(--border); box-shadow:0 5px 15px rgba(0,0,0,0.3)"><img src="assets/doors/${String(day).padStart(2,'0')}.jpg" alt="Bild" style="position:absolute; inset:0; width:100%; height:100%; object-fit:cover" onerror="this.parentElement.style.display='none'"/></div>` : '';

    if(reward.kind === 'voucher'){
      const v = reward.payload;
      h = `${hero}<div class="reward">
            <div class="icon">üéüÔ∏è</div>
            <div style="flex:1">
              <h3 style="margin:0 0 4px 0">${v.title}</h3>
              <div class="muted">Herzlichen Gl√ºckwunsch!</div>
              <div class="voucher">
                <div class="line"><span class="label">Code:</span> <code>${v.code}</code></div>
                <div class="line"><span class="label">F√ºr:</span> <strong>${user.name}</strong></div>
              </div>
              <div style="margin-top:12px; display:flex; gap:8px">
                 <button class="btn" onclick="window.print()">Drucken</button>
                 <button class="btn" onclick="copyToClip('${v.code}', 'Code')">Code kopieren</button>
              </div>
            </div>
           </div>`;
    } else {
       const m = reward.payload;
       const icon = m.type==='joke'?'ü§£':(m.type==='fact'?'üí°':'‚ú®');
       const shareText = `${m.type==='joke'?'ü§£ Witz':(m.type==='fact'?'üí° Fakt':'‚ú® Spruch')} des Tages:\n\n${m.text}\n\n(Aus dem GAB Adventskalender)`;
       h = `${hero}<div class="reward">
             <div class="icon">${icon}</div>
             <div style="flex:1">
               <h3 style="margin:0 0 8px 0">Botschaft des Tages</h3>
               <div style="font-size:16px; line-height:1.5">${m.type==='link' ? `<a href="${m.text}" target="_blank" style="color:#6cf">${m.label}</a><br><small>${m.desc}</small>` : m.text}</div>
               ${m.type !== 'link' ? `<button class="btn" style="margin-top:12px" onclick="copyToClip(\`${shareText.replace(/"/g, '&quot;')}\`, 'Spruch')">üìã Kopieren f√ºr Chat</button>` : ''}
             </div>
            </div>`;
    }
    document.getElementById('modalBody').innerHTML = h;
    openModal();
  }

  window.copyToClip = (txt, label) => { 
    // Verwende document.execCommand f√ºr bessere iFrame-Kompatibilit√§t
    const textarea = document.createElement('textarea');
    textarea.value = txt;
    document.body.appendChild(textarea);
    textarea.select();
    try {
      document.execCommand('copy');
      _toast(`${label} kopiert!`);
    } catch (err) {
      console.error('Kopieren fehlgeschlagen', err);
      _toast(`Kopieren von ${label} fehlgeschlagen.`);
    }
    document.body.removeChild(textarea);
  };
  function openModal(){ const b=document.getElementById('backdrop'); const m=document.getElementById('modalBox'); b.style.display='flex'; setTimeout(()=>m.classList.add('active'),10); }
  document.getElementById('closeModal').onclick = () => { const b=document.getElementById('backdrop'); const m=document.getElementById('modalBox'); m.classList.remove('active'); setTimeout(()=>b.style.display='none',300); };
  window._toast = (msg) => { const t = document.getElementById('toast'); t.innerHTML = `<span>üîî</span> ${msg}`; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 2500); };

  function renderBoard(users){
    let h = '<table><thead><tr><th>Name</th><th>Fortschritt</th></tr></thead><tbody>';
    // Sortiere Benutzer nach Fortschritt absteigend
    const sortedUsers = users.sort((a, b) => (Object.keys(b.opened || {}).length) - (Object.keys(a.opened || {}).length));

    sortedUsers.forEach(u => {
      const c = Object.keys(u.opened||{}).length;
      h += `<tr><td>${u.name||'Unbekannt'}</td><td><div style="display:flex;align-items:center;gap:8px"><div style="flex:1;height:6px;background:#333;border-radius:3px;overflow:hidden"><div style="width:${(c/24)*100}%;background:#5de07a;height:100%"></div></div> ${c}</div></td></tr>`;
    });
    h += '</tbody></table>';
    document.getElementById('board').innerHTML = h;
  }

  // ============== ADMIN TOOLS LOGIC =================
  function setupAdminTools(svc) {
      const admCode = document.getElementById('admCode');
      const admMsg = document.getElementById('admMsg');
      const btnVerify = document.getElementById('btnVerify');
      const btnRedeem = document.getElementById('btnRedeem');

      if (btnVerify) {
          btnVerify.onclick = async () => {
              admMsg.textContent = '';
              const code = (admCode.value || '').trim();
              if (!code) {
                  admMsg.textContent = 'Bitte Code eingeben';
                  return;
              }
              try {
                  const res = await svc.verifyVoucher(code);
                  if (res.ok) {
                      admMsg.style.color = res.redeemed ? '#ff6b6b' : '#5de07a';
                      admMsg.textContent = `Voucher OK | Typ: ${res.type.toUpperCase()} | Tag: ${res.day} | Name: ${res.name || 'Unbekannt'} | Status: ${res.redeemed ? 'BEREITS EINGEL√ñST' : 'G√úLTIG & NICHT EINGEL√ñST'}`;
                  } else {
                      admMsg.style.color = '#ff6b6b';
                      admMsg.textContent = `Ung√ºltig oder Fehler: ${res.reason || 'Unbekannt'}`;
                  }
              } catch (e) {
                  admMsg.style.color = '#ff6b6b';
                  admMsg.textContent = 'Fehler beim Pr√ºfen: ' + (e.message || String(e));
              }
          };
      }

      if (btnRedeem) {
          btnRedeem.onclick = async () => {
              admMsg.textContent = '';
              const code = (admCode.value || '').trim();
              if (!code) {
                  admMsg.textContent = 'Bitte Code eingeben';
                  return;
              }
              try {
                  const res = await svc.redeemVoucher(code);
                  if (res.ok) {
                      admMsg.style.color = '#5de07a';
                      admMsg.textContent = `Voucher erfolgreich eingel√∂st!`;
                      // Nach dem Einl√∂sen erneut pr√ºfen, um den Status zu aktualisieren
                      if (btnVerify) btnVerify.onclick(); 
                  } else {
                      admMsg.style.color = '#ff6b6b';
                      admMsg.textContent = `Einl√∂sen fehlgeschlagen: ${res.reason || 'Unbekannt'}`;
                  }
              } catch (e) {
                  admMsg.style.color = '#ff6b6b';
                  admMsg.textContent = 'Einl√∂sen fehlgeschlagen: ' + (e.message || String(e));
              }
          };
      }
  }
  // ====================================================

  function getDoorOrder(y){
    const arr=Array.from({length:24},(_,i)=>i+1);
    let s=hash(String(y));
    for(let i=arr.length-1;i>0;i--){ s=(s*9301+49297)%233280; const j=(s%(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; }
    return arr;
  }
  
  function shuffledMessagesFor(user){
    const seed = hash(`${user.uid}|${CONFIG.year}|MSGPOOL`);
    const rng = mul32(seed);
    const arr = MESSAGES.slice(); 
    for(let i = arr.length - 1; i > 0; i--){
      const j = Math.floor(rng() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  function getMessageFor(user, dayIndex){
    const pool = shuffledMessagesFor(user);
    const idx = (dayIndex - 1) % pool.length;
    return pool[idx];
  }

  function randHex(n){ return Math.random().toString(16).slice(2, 2+n).toUpperCase(); }
  function hash(s){ let h=0; for(let i=0;i<s.length;i++) h=((h<<5)-h)+s.charCodeAt(i)|0; return h>>>0; }
  function mul32(a){ return function(){ let t=a+=0x6D2B79F5; t=Math.imul(t^t>>>15,t|1); t^=t+Math.imul(t^t>>>7,t|61); return ((t^t>>>14)>>>0)/4294967296 } }
  
  // =========================================================================
  // DEMO-SERVICE (LOKALER SPEICHER) - BLEIBT F√úR DEN FALL, DASS KEINE CONFIG VORHANDEN IST
  // =========================================================================
  async function makeDemoService(){
    const store = { get:(k)=>JSON.parse(localStorage.getItem('adv_v2_'+k)||'null'), set:(k,v)=>localStorage.setItem('adv_v2_'+k, JSON.stringify(v)) };
    let cbs = [];
    return {
      register: async(n,e,p)=>{ 
        const uid='u'+hash(e); 
        if(store.get('u_'+uid)) throw new Error('E-Mail bereits registriert.');
        store.set('u_'+uid, {name:n,email:e}); 
        store.set('sess', {uid,name:n, isAuthReady: true}); 
        cbs.forEach(f=>f({uid,name:n, isAuthReady: true})); 
        _toast('Registrierung erfolgreich. Willkommen!');
        return true; 
      },
      login: async(e,p)=>{ 
        const uid='u'+hash(e); 
        const userData = store.get('u_'+uid);
        if(!userData) throw new Error('Benutzer unbekannt oder falsche E-Mail/Passwort.');
        store.set('sess', {uid,name:userData.name, isAuthReady: true}); 
        cbs.forEach(f=>f({uid,name:userData.name, isAuthReady: true})); 
        _toast('Anmeldung erfolgreich.');
        return true; 
      },
      logout: async()=>{ store.set('sess', null); cbs.forEach(f=>f(null)); _toast('Abgemeldet.'); },
      onAuth: (fn)=>{ 
        cbs.push(fn); 
        // F√ºge isAuthReady: true f√ºr Demo-Modus hinzu, da Auth sofort fertig ist
        const user = store.get('sess');
        if (user) user.isAuthReady = true; 
        fn(user); 
      },
      // Simuliere onSnapshot f√ºr User-Daten
      onUserDoc: async(uid, fn)=>{ 
        const fire=()=>fn(store.get('data_'+uid)); 
        fire(); 
        setInterval(fire, 1000); 
      },
      setUserDoc: async(uid, d)=>{ 
        const old=store.get('data_'+uid)||{}; 
        store.set('data_'+uid, {...old, ...d}); 
      },
      // Simuliere isAdmin und onAllUsers f√ºr Demo
      isAdmin: async()=>true,
      onAllUsers: async(fn)=>{ 
        const userA = store.get('u_u'+hash('userA@demo.de')) || {name:'Demo User A', opened:{1:true,2:true}};
        const userB = store.get('u_u'+hash('userB@demo.de')) || {name:'Demo User B', opened:{1:true}};
        fn([
          {name:userA.name, opened:store.get('data_u'+hash('userA@demo.de'))?.opened || {1:true,2:true}}, 
          {name:userB.name, opened:store.get('data_u'+hash('userB@demo.de'))?.opened || {1:true}}
        ]); 
      },
      // Simuliere Voucher-Signierung
      signVoucher: async({day,type,nonce})=>{ 
          // Diese Logik wird auch im Demo-Service verwendet, um die Voucher-Pr√ºfung zu simulieren
          const code=`D-${type.toUpperCase().slice(0,1)}-${String(day).padStart(2,'0')}-${nonce.slice(0, 4)}`;
          const vouchers = store.get('vouchers') || {};
          const uid = store.get('sess').uid;
          vouchers[code] = { code, type, day, uid, name: store.get('u_'+uid).name, year: CONFIG.year, redeemed: false };
          store.set('vouchers', vouchers);
          return {code: code, token: 'xxx', uid: uid, name: store.get('u_'+uid).name, year: CONFIG.year}; 
      },
      // Admin Logik f√ºr Demo
      verifyVoucher: async(code) => {
          const vouchers = store.get('vouchers') || {};
          const v = vouchers[code];
          if (!v) return { ok: false, reason: 'not-found' };
          return { ok: true, redeemed: !!v.redeemed, type: v.type, day: v.day, year: v.year, uid: v.uid, name: v.name };
      },
      redeemVoucher: async(code) => {
          const vouchers = store.get('vouchers') || {};
          let v = vouchers[code];
          if (!v) throw new Error('Unbekannter Code');
          if (v.redeemed) throw new Error('Bereits eingel√∂st');
          
          v.redeemed = true;
          v.redeemedAt = new Date().toISOString();
          vouchers[code] = v;
          store.set('vouchers', vouchers);
          return { ok: true };
      }
    };
  }

  // =========================================================================
  // LIVE-SERVICE (FIREBASE / FIRESTORE)
  // =========================================================================

  async function makeLiveService(){
    
    // Importiere Firebase Module
    // Wichtig: Verwende die von Canvas bereitgestellten Versionen 
    const { initializeApp } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js");
    const { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, signInWithCustomToken } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js");
    const { getFirestore, doc, setDoc, onSnapshot, collection, query, getDocs, updateDoc, where, getDoc } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");
    const { setLogLevel } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");
    
    // Firebase Initialisierung
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    
    setLogLevel('error'); // Fehlerprotokollierung f√ºr Firestore

    // Pfade-Konstanten (Canvas-spezifisch)
    const USERS_COL = `artifacts/${appId}/users`;
    const PUBLIC_DATA_COL = `artifacts/${appId}/public/data/users`;
    const ADMIN_COL = `artifacts/${appId}/public/data/admins`;

    let authCb = () => {};
    let isAuthReady = false;
    let currentUserId = null;
    let currentUserName = null;

    // Canvas-Authentifizierung mit Initial-Token
    if (typeof __initial_auth_token !== 'undefined') { 
        try {
            await signInWithCustomToken(auth, __initial_auth_token);
        } catch(error) {
            console.error('Initial-Token-Anmeldung fehlgeschlagen:', error);
            // Wir warten hier auf die manuelle Anmeldung des Benutzers √ºber E-Mail/Passwort
        }
    } 

    // Auth State Listener
    onAuthStateChanged(auth, async (user) => {
        isAuthReady = true;
        if (user) {
            currentUserId = user.uid;
            
            // Lade den Anzeigenamen des Benutzers aus Firestore, falls vorhanden
            const userRef = doc(db, USERS_COL, currentUserId);
            const userSnap = await getDoc(userRef);
            if(userSnap.exists()) {
                // Name aus dem privaten Benutzerdokument nehmen
                currentUserName = userSnap.data().name;
            } else {
                // Fallback, wenn Dokument noch nicht existiert (z.B. nach CustomToken Sign-In ohne vorherige Registrierung)
                currentUserName = user.email ? user.email.split('@')[0] : 'Benutzer';
            }

            // Aufruf des Auth-Callbacks
            authCb({ 
                uid: currentUserId, 
                name: currentUserName, 
                isAuthReady: true // Best√§tigt, dass Auth abgeschlossen ist
            });
        } else {
            currentUserId = null;
            currentUserName = null;
            authCb(null);
        }
    });

    // Hilfsfunktion zur Abfrage von Benutzerdaten (Kalenderstatus)
    const onUserDoc = (uid, fn) => {
        if (!uid) return () => {}; 
        // Privater Pfad: /artifacts/{appId}/users/{userId}/calendar/state
        const userCalendarRef = doc(db, USERS_COL, uid, 'calendar', 'state');
        return onSnapshot(userCalendarRef, (docSnap) => {
            fn(docSnap.data());
        }, (error) => {
            console.error('Fehler beim Abh√∂ren der Benutzerdaten:', error);
            _toast('Fehler beim Laden der Kalenderdaten.');
        });
    };

    // Hilfsfunktion zum Speichern von Benutzerdaten (Kalenderstatus)
    const setUserDoc = async (uid, data) => {
        if (!uid) return;
        // Privater Pfad: /artifacts/{appId}/users/{userId}/calendar/state
        const userCalendarRef = doc(db, USERS_COL, uid, 'calendar', 'state');
        // √ñffentlicher Pfad: /artifacts/{appId}/public/data/users/{userId}
        const publicUserRef = doc(db, PUBLIC_DATA_COL, uid);

        try {
            // 1. Speichern der privaten Kalenderdaten
            await setDoc(userCalendarRef, data, { merge: true });

            // 2. Aktualisieren der √∂ffentlichen Fortschrittsdaten (f√ºr Leaderboard)
            const openedCount = Object.keys(data.opened || {}).length;
            await updateDoc(publicUserRef, { opened: data.opened || {}, openedCount: openedCount, lastUpdate: new Date() });

        } catch(error) {
            console.error('Fehler beim Speichern der Benutzerdaten:', error);
            _toast('Fehler beim Speichern des Fortschritts.');
        }
    };
    
    // Hilfsfunktion zur √úberpr√ºfung der Admin-Rolle
    const isAdmin = async (uid) => {
        if (!uid) return false;
        // √ñffentlicher Pfad: /artifacts/{appId}/public/data/admins/{userId}
        const adminRef = doc(db, ADMIN_COL, uid);
        try {
            const adminSnap = await getDoc(adminRef);
            return adminSnap.exists();
        } catch(error) {
            console.error('Fehler beim Pr√ºfen der Admin-Rolle:', error);
            return false;
        }
    };
    
    // Hilfsfunktion zur Abfrage aller Benutzer f√ºr die Rangliste
    const onAllUsers = (fn) => {
        // √ñffentlicher Pfad: /artifacts/{appId}/public/data/users
        const q = query(collection(db, PUBLIC_DATA_COL)); 
        return onSnapshot(q, (snapshot) => {
            const users = [];
            snapshot.forEach(doc => {
                const data = doc.data();
                if (data.name) {
                    users.push({
                        uid: doc.id,
                        name: data.name,
                        opened: data.opened || {} 
                    });
                }
            });
            fn(users);
        }, (error) => {
            console.error('Fehler beim Abh√∂ren der Benutzer-Rangliste:', error);
            _toast('Fehler beim Laden der Team-√úbersicht.');
        });
    };

    // Hilfsfunktion zur Signierung von Vouchern
    // ACHTUNG: Dies ist Dummy-Logik, da die serverseitige Logik (Cloud Functions) fehlt.
    // In einer echten Umgebung m√ºsste hier ein sicherer Aufruf erfolgen.
    const signVoucher = async ({day, type, nonce}) => {
         if (!currentUserId) throw new Error('Anmeldung erforderlich f√ºr Voucher');
         const token = `SIG-${randHex(10)}`; // Einfache Signatur
         const code = `${type.toUpperCase().slice(0,1)}-${String(day).padStart(2,'0')}-${randHex(4)}`;
         return { code, token, uid: currentUserId, name: currentUserName, year: CONFIG.year };
    };

    // Dummy-Implementierung f√ºr Admin-Tools: Pr√ºfen und Einl√∂sen
    // Diese Logik sollte serverseitig in Cloud Functions implementiert werden!
    // F√ºr den Prototyp verwenden wir eine einfache Speicherung im Admin-Dokument
    const VOUCHERS_DOC = doc(db, ADMIN_COL, 'voucher_ledger');
    
    const verifyVoucher = async (code) => {
        try {
            const snap = await getDoc(VOUCHERS_DOC);
            const ledger = snap.exists() ? snap.data() : {};
            const v = ledger[code];

            if (!v) return { ok: false, reason: 'not-found' };

            // Einfache Validierung des Dummy-Codes
            const parts = code.split('-');
            if (parts.length < 3 || (parts[0] !== 'M' && parts[0] !== 'S')) return { ok: false, reason: 'invalid-format' };

            return { 
                ok: true, 
                redeemed: !!v.redeemed, 
                type: v.type, 
                day: v.day, 
                year: v.year, 
                uid: v.uid, 
                name: v.name 
            };
        } catch(e) {
            console.error('Fehler beim Pr√ºfen des Vouchers:', e);
            throw new Error('Fehler beim Zugriff auf Voucher-Datenbank.');
        }
    };

    const redeemVoucher = async (code) => {
        const check = await verifyVoucher(code);
        if (!check.ok) throw new Error('Ung√ºltiger Code: ' + check.reason);
        if (check.redeemed) throw new Error('Code bereits eingel√∂st.');

        try {
            const redeemedAt = new Date().toISOString();
            // Aktualisiere das Ledger: setze redeemed auf true
            await updateDoc(VOUCHERS_DOC, { 
                [code + '.redeemed']: true,
                [code + '.redeemedAt']: redeemedAt
            });

            return { ok: true, redeemedAt: redeemedAt };
        } catch(e) {
            console.error('Fehler beim Einl√∂sen des Vouchers:', e);
            throw new Error('Fehler beim Speichern des Einl√∂sevorgangs.');
        }
    };

    // Registriert den generierten Voucher im Admin Ledger f√ºr die √úberpr√ºfung
    const registerVoucherInLedger = async (data) => {
        const code = data.code;
        const entry = {
            code: data.code,
            type: data.type,
            day: data.day,
            uid: data.uid,
            name: data.name,
            year: CONFIG.year,
            redeemed: false,
            generatedAt: new Date().toISOString()
        };
        // F√ºge das Voucher-Objekt unter seinem Code in das Ledger-Dokument ein (merge: true)
        await setDoc(VOUCHERS_DOC, { [code]: entry }, { merge: true });
    };


    return {
        register: async(name, email, password) => {
            // Firebase Auth Registrierung
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            const uid = userCredential.user.uid;

            // Privates Dokument (enth√§lt Name)
            await setDoc(doc(db, USERS_COL, uid), { name: name, email: email, createdAt: new Date() });

            // √ñffentliches Dokument (f√ºr Leaderboard)
            await setDoc(doc(db, PUBLIC_DATA_COL, uid), { name: name, opened: {}, openedCount: 0, lastLogin: new Date() }, { merge: true });

            _toast('Registrierung erfolgreich. Willkommen!');
        },
        login: async(email, password) => {
            // Firebase Auth Anmeldung
            const userCredential = await signInWithEmailAndPassword(auth, email, password);
            const uid = userCredential.user.uid;

            // Aktualisiere √∂ffentliche Daten (z.B. letzter Login)
            await updateDoc(doc(db, PUBLIC_DATA_COL, uid), { lastLogin: new Date() });
            _toast('Anmeldung erfolgreich.');
        },
        logout: async() => {
            await signOut(auth);
            _toast('Abgemeldet.');
        },
        onAuth: (fn) => {
            authCb = fn; // Setze den Callback, der im onAuthStateChanged verwendet wird
            // Wenn der Auth-Status bereits bekannt ist, rufe den Callback sofort auf
            if (isAuthReady) {
                authCb(auth.currentUser ? { uid: auth.currentUser.uid, name: currentUserName, isAuthReady: true } : null);
            }
        },
        onUserDoc,
        setUserDoc,
        isAdmin,
        onAllUsers,
        signVoucher: async (params) => {
            const result = await signVoucher({ ...params, uid: currentUserId, name: currentUserName });
            await registerVoucherInLedger(result); // Speichere den Dummy-Voucher im Ledger
            return result;
        },
        verifyVoucher,
        redeemVoucher,
    };
  }
  </script>
</body>
</html>
