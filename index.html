<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>GAB Adventskalender</title>
<meta name="theme-color" content="#0b0f17"/>
<style>
  :root{
    --bg:url('assets/bg.jpg');
    --glass: rgba(255,255,255,.10);
    --glass-strong: rgba(255,255,255,.22);
    --border: rgba(255,255,255,.18);
    --text:#fff; --muted:#e3e9f7; --gold:#ffd76a;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0; font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:var(--text); background:#0b0f17; display:flex; flex-direction:column; min-height:100vh; overflow-x:hidden}
  
  /* Verbesserter Hintergrund-Fallback, falls Bild nicht l√§dt */
  .bgimg{position:fixed; inset:0; background:#0b0f17 radial-gradient(circle at 50% 0%, #1a253a, #0b0f17); background-image:var(--bg); background-position:center; background-size:cover; filter:blur(2px)}
  
  header{backdrop-filter:blur(10px); background:linear-gradient(180deg, rgba(12,18,28,.75), rgba(12,18,28,.3)); border-bottom:1px solid var(--border); position:sticky; top:0; z-index:5}
  .bar{display:flex; align-items:center; gap:12px; padding:12px 20px}
  .logo{width:48px; height:48px; border-radius:14px; position:relative; background:conic-gradient(from 0deg, rgba(255,77,90,.45), rgba(255,215,106,.45), rgba(93,216,255,.45), rgba(53,224,122,.45), rgba(255,77,90,.45)); box-shadow:0 0 30px rgba(255,215,106,.25) inset, 0 0 40px rgba(93,216,255,.18) inset}
  .logo:after{content:"üéÑ"; position:absolute; inset:0; display:grid; place-items:center; font-size:22px}
  h1{font-size:22px; letter-spacing:.5px; margin:0} .spacer{flex:1}
  
  .btn{cursor:pointer; border:1px solid var(--border); background:var(--glass); color:var(--text); padding:10px 14px; border-radius:12px; transition:.2s; font-weight:700}
  .btn:hover{background:var(--glass-strong); transform:translateY(-1px)}
  .btn.gold{border-color:rgba(255,215,106,.5); box-shadow:0 0 20px rgba(255,215,106,.25) inset; color: var(--gold)}
  
  .wrap{width:100%; max-width:1200px; margin:0 auto; padding:20px; flex:1 0 auto; position:relative; z-index:3}
  .panel{background:var(--glass); border:1px solid var(--border); border-radius:18px; padding:16px; box-shadow:0 8px 32px rgba(0,0,0,.25)}
  
  .auth{max-width:680px; margin:28px auto; text-align:left} .row{display:flex; gap:10px; flex-wrap:wrap}
  .input{flex:1; min-width:220px; padding:12px 14px; border-radius:12px; border:1px solid var(--border); background:rgba(255,255,255,.05); color:#fff}
  label{display:block; margin:8px 0 6px 2px; color:var(--gold); font-weight:600}
  .hint{color:var(--muted); font-size:13px}
  
  /* Grid Layout: Optimiert f√ºr 24 T√ºrchen (keine L√ºcken am Ende) */
  .grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr); /* Handy: 2 Spalten */
    gap: 14px;
  }
  @media (min-width: 500px) {
    .grid { grid-template-columns: repeat(3, 1fr); } /* Klein: 3 Spalten */
  }
  @media (min-width: 768px) {
    .grid { grid-template-columns: repeat(4, 1fr); } /* Tablet: 4 Spalten */
  }
  @media (min-width: 1100px) {
    .grid { grid-template-columns: repeat(6, 1fr); } /* Desktop: Exakt 6 Spalten (6x4=24) */
  }
  
  .door{position:relative; height:110px; border-radius:16px; overflow:hidden; cursor:pointer; border:2px solid transparent; background:
    linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.03)),
    radial-gradient(circle at 20% -10%, rgba(255,77,90,.35), transparent 40%),
    radial-gradient(circle at 120% 20%, rgba(93,216,255,.25), transparent 40%),
    radial-gradient(circle at 80% 120%, rgba(255,215,106,.25), transparent 40%),
    radial-gradient(circle at -10% 80%, rgba(53,224,122,.25), transparent 40%);
    display:flex; align-items:center; justify-content:center; font-weight:900; font-size:26px; color:var(--text); text-shadow:0 2px 10px rgba(0,0,0,.35); transition: transform 0.2s}
  
  .door:hover { transform: scale(1.02); }
  .door.locked{opacity:.6; cursor:not-allowed; border-color:rgba(255,255,255,.06)}
  .door.opened{border-color:rgba(93,216,255,.7); box-shadow:0 0 0 6px rgba(93,216,255,.12) inset}
  .door .badge{position:absolute; top:8px; right:8px; background:rgba(255,215,106,.25); border:1px solid var(--border); padding:2px 8px; border-radius:10px; font-size:11px}
  .door .emoji{position:absolute; left:10px; top:8px} .door .num{position:relative; z-index:2}
  .door.opened .num{display:none}
  
  .door.opened::after{content:""; position:absolute; inset:0; pointer-events:none; background:linear-gradient(180deg, rgba(0,0,0,.0), rgba(0,0,0,.18))}
  .door.opened img.thumb{position:absolute; inset:0; width:100%; height:100%; object-fit:cover; filter:saturate(1.05) contrast(1.02)}

  /* Shake Animation f√ºr gesperrte T√ºren */
  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-4px) rotate(-2deg); }
    75% { transform: translateX(4px) rotate(2deg); }
  }
  .shake { animation: shake 0.4s ease-in-out; }

  .footer{padding:20px; text-align:center; color:var(--muted); border-top:1px solid var(--border)}
  .modal-backdrop{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(5,8,12,.75); z-index:50; backdrop-filter: blur(4px);}
  .modal{width:min(720px, 92vw); background:rgba(20,24,35,.95); border:1px solid var(--border); border-radius:18px; overflow:hidden; box-shadow:0 18px 60px rgba(0,0,0,.5); transform: scale(0.95); transition: transform 0.2s opacity 0.2s; opacity: 0;}
  .modal.active { transform: scale(1); opacity: 1; }

  .modal .head{display:flex; align-items:center; gap:12px; padding:14px 16px; border-bottom:1px solid var(--border)} .modal .body{padding:18px}
  
  .reward{display:flex; gap:16px; align-items:flex-start}
  .reward .icon{width:70px; height:70px; border-radius:16px; display:grid; place-items:center; font-size:34px; background:linear-gradient(135deg, rgba(93,216,255,.30), rgba(255,215,106,.30)); border:1px solid var(--border); flex-shrink: 0;}
  
  .muted{color:var(--muted)}
  .voucher{margin-top:14px; padding:14px; border:1px dashed var(--gold); border-radius:14px; background:rgba(255,215,106,.10)}
  .voucher .line{display:flex; gap:10px; align-items:center; margin-top:8px} .voucher .label{width:120px; color:var(--muted)}
  
  .print-area{display:none}
  @media print{ header,.wrap,.footer{display:none} .print-area{display:block; padding:28px; font-family:Inter, Arial, sans-serif} .print-card{border:2px dashed #333; border-radius:12px; padding:20px} .print-card h2{margin:0 0 10px 0} .print-card .small{color:#444} }
  
  .toast{position:fixed; bottom:20px; right:20px; background:rgba(25,32,48,.95); color:#fff; border:1px solid var(--border); padding:12px 16px; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.35); opacity:0; transform:translateY(10px); transition:.25s; z-index: 100}
  .toast.show{opacity:1; transform:translateY(0)}
  
  table{width:100%; border-collapse:collapse} th,td{padding:10px; border-bottom:1px solid var(--border)} th{text-align:left; color:var(--gold)}

  /* Countdown Overlay */
  #countdownOverlay{
    position:fixed; inset:0; display:none; z-index:40;
    background:rgba(5,8,12,.65); backdrop-filter: blur(2px);
    align-items:center; justify-content:center; text-align:center; padding:24px;
    pointer-events:auto;
  }
  #countdownOverlay .box{ max-width:820px; margin:auto; color:#fff }
  #countdownOverlay .timer{ font-weight:900; font-size:clamp(28px, 6vw, 56px); letter-spacing:1.5px }
  #countdownOverlay .msg{ margin-top:12px; font-size:clamp(14px, 2.4vw, 18px); color:var(--muted) }
  #countdownOverlay .msg strong{ color:var(--gold) }
</style>
</head>
<body>
  <div class="bgimg" aria-hidden="true"></div>
  <canvas id="fx" aria-hidden="true" style="position:fixed; inset:0; width:100%; height:100%; pointer-events:none; z-index:1"></canvas>
  <canvas id="confetti" aria-hidden="true" style="position:fixed; inset:0; width:100%; height:100%; pointer-events:none; z-index:60"></canvas>

  <header>
    <div class="bar">
      <div class="logo" aria-hidden="true"></div>
      <h1>GAB Adventskalender</h1>
      <div class="spacer"></div>
      <div id="userBox" class="muted"></div>
      <button class="btn" id="btn-signout" style="display:none">Abmelden</button>
      <button class="btn" id="btn-how">Info</button>
    </div>
  </header>

  <div class="wrap">
    <!-- Auth -->
    <div class="panel auth" id="authPanel">
      <h2 style="margin:4px 0 14px 0">Anmelden oder registrieren</h2>
      <div class="hint">Im DEMO-Modus bleiben Daten auf diesem Rechner; im Live-Modus werden sie in Firebase gespeichert</div>
      <div class="row" style="margin-top:14px">
        <div style="flex:1; min-width:260px">
          <label for="name">Anzeigename</label>
          <input id="name" class="input" placeholder="Z. B. Max Mustermann" autocomplete="name"/>
          <label for="email">E-Mail</label>
          <input id="email" class="input" placeholder="name@firma.de" autocomplete="email"/>
          <label for="pw">Passwort</label>
          <input id="pw" class="input" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="new-password"/>
        </div>
      </div>
      <div class="row" style="margin-top:12px">
        <button type="button" class="btn gold" id="btn-register">Registrieren</button>
        <button type="button" class="btn" id="btn-login">Anmelden</button>
      </div>
      <div id="authMsg" class="hint" style="margin-top:10px"></div>
    </div>

    <!-- Kalender -->
    <div class="panel" id="kalPanel" style="display:none">
      <div style="display:flex; align-items:center; gap:12px; flex-wrap:wrap; margin-bottom:10px">
        <div>Willkommen, <strong id="who">‚Äì</strong></div>
        <div class="muted">√ñffne t√§glich ein T√ºrchen. Vergangene Tage sind nachholbar.</div>
      </div>
      <div id="devWarning" style="display:none; color: var(--gold); margin-bottom: 10px; font-size: 13px;">‚ö†Ô∏è Simulations-Modus aktiv: Datum √ºberschrieben</div>
      <div class="grid" id="grid"></div>
    </div>

    <!-- Admin √úbersicht -->
    <div class="panel" id="boardPanel" style="display:none; margin-top:16px">
      <h3>√úbersicht Team / Ge√∂ffnete T√ºrchen</h3>
      <div class="muted" style="margin-bottom:8px">Nur Admins sehen diese √úbersicht</div>
      <div id="board"></div>
      <div id="adminTools" style="margin-top:16px; display:none">
        <h4>Voucher pr√ºfen / einl√∂sen</h4>
        <div class="row" style="align-items:center">
          <input id="admCode" class="input" placeholder="Code; z. B. M-07-ABCDEFGH..." style="min-width:260px"/>
          <button class="btn" id="btnVerify">Pr√ºfen</button>
          <button class="btn gold" id="btnRedeem">Einl√∂sen</button>
        </div>
        <div id="admMsg" class="hint" style="margin-top:8px"></div>
      </div>
      <div id="demoAdminHint" class="hint" style="margin-top:8px; display:none">DEMO: Du kannst dich als Admin markieren (Button erscheint oben rechts)</div>
    </div>
  </div>

  <div class="footer">¬© 2025 GAB Neumann GmbH | Interner Spa√ükalender</div>

  <!-- Modal -->
  <div class="modal-backdrop" id="backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" id="modalBox">
      <div class="head"><strong id="modalTitle">T√ºrchen</strong><div class="spacer"></div><button class="btn" id="closeModal">Schlie√üen</button></div>
      <div class="body" id="modalBody"></div>
    </div>
  </div>

  <!-- Countdown Overlay -->
  <div id="countdownOverlay" aria-hidden="true">
    <div class="box">
      <div class="timer" id="cdTimer">00 Tage; 00:00:00</div>
      <div class="msg" id="cdText">
        In <strong>XXX</strong> geht‚Äôs hier los in deinem pers√∂nlichen Kalender.
      </div>
    </div>
  </div>

  <div class="print-area" id="printArea"></div>
  <div class="toast" id="toast"></div>

  <script type="module">
  /* ===== Konfiguration ===== */
  const IS_DEMO = location.protocol === 'file:';
  const DOOR_IMAGES = true; // Bilder anzeigen oder nur Text

  // URL Parameter f√ºr Testing: ?sim_date=2025-12-05
  const urlParams = new URLSearchParams(window.location.search);
  const simDateParam = urlParams.get('sim_date');

  const CONFIG = {
    bgImage:'assets/bg.jpg',
    sfx:{ open:['assets/sfx/open.mp3'], win:['assets/sfx/win.mp3'], click:['assets/sfx/click.mp3'] },
    probabilities:{ mealVoucher:0.0025, snackVoucher:0.10 }, 
    year:2025, startMonth:12, days:24
  };
  document.documentElement.style.setProperty('--bg', `url('${CONFIG.bgImage}')`);

  /* ===== Zeitreise-Funktion (f√ºr Testing) ===== */
  function getCurrentDate() {
    if (simDateParam) {
      const sim = new Date(simDateParam);
      if (!isNaN(sim.getTime())) {
        // Uhrzeit auf aktuelle Zeit setzen, damit Countdown logisch bleibt, aber Datum fixieren
        const now = new Date();
        sim.setHours(now.getHours(), now.getMinutes(), now.getSeconds());
        return sim;
      }
    }
    return new Date();
  }

  if(simDateParam) {
     document.getElementById('devWarning').style.display = 'block';
     document.getElementById('devWarning').innerText = `‚ö†Ô∏è Simulations-Modus: Es ist heute virtuell der ${simDateParam}`;
  }

  /* ===== Messages ===== */
  const MESSAGES = [
    {type:'quote', text:'Motivation des Tages: Auch diesen Arbeitstag darfst du mit deinen Kollegen hier verbringen!'},
    {
      type: 'joke',
      text: `Die Familie Schmukler stellt seit Generationen N√§gel her. Papa sagt zu seinem Sohn: "Fima, ich war 30 Jahre nicht im Urlaub. Du bleibst als Gesch√§ftsf√ºhrer hier, ich fahr mit Mama einen Monat weg." ‚Äì "Papa, ich bin doch Marketing-Mensch, kein Produktioner!" ‚Äì "Unsere Lager sind voll, verkauf einfach die N√§gel."

  Zwei Wochen sp√§ter ein Telegramm: "Papa, komm sofort zur√ºck, die N√§gel sind alle!" ‚Äì "Wie das?" ‚Äì "Ich hab Werbung gemacht." ‚Äì Auf dem Plakat: Jesus am Kreuz und der Slogan: "Schmukler-N√§gel halten seit 2000 Jahren." ‚Äì Papa: "Fima! Kein Jesus in der Werbung! Sofort runter!"

  Papa f√§hrt wieder weg. Zwei Wochen sp√§ter wieder ein Telegramm: "Papa, flieg sofort her, die N√§gel sind schon wieder alle." ‚Äì "Schon wieder Werbung?!" ‚Äì "Ja, aber ohne Jesus, versprochen." ‚Äì Auf dem Plakat: ein leeres Kreuz, ohne Jesus, mit dem Slogan: "H√§tten sie nur Schmukler-N√§gel gehabt‚Ä¶"`
    }, 
    {type:'fact', text:'Es gibt auf der Erde mehr Sterne am Himmel als Sandk√∂rner auf allen Str√§nden ‚Äì aber im beobachtbaren Universum noch mehr Galaxien als Sterne in der Milchstra√üe.'},
    {type:'fact', text:'Oktopusse haben drei Herzen und blaues Blut ‚Äì zwei pumpen zu den Kiemen, eines durch den K√∂rper.'},
    {type:'fact', text:'Wenn du ein Blatt Papier 42-mal falten k√∂nntest, w√§re es theoretisch so dick, dass es bis zum Mond reicht.'},
    {type:'fact', text:'Bienen erkennen menschliche Gesichter ‚Äì sie nutzen √§hnliche Mustererkennung wie wir.'},
    {type:'fact', text:'Im Inneren eines Blitzes ist es f√ºnfmal hei√üer als an der Oberfl√§che der Sonne.'},
    {type:'fact', text:'Ein Teel√∂ffel Erde enth√§lt mehr Mikroorganismen als es Menschen auf der Erde gibt.'},
    {type:'fact', text:'Manche Tiefseefische nutzen Biolumineszenz als Tarnung ‚Äì sie leuchten ihr Bauchprofil, um von unten unsichtbar zu werden.'},
    {type:'fact', text:'Saturn hat eine geringere Dichte als Wasser ‚Äì in einem ausreichend gro√üen Becken w√ºrde er theoretisch schwimmen.'},
    {type:'fact', text:'In Island gibt es keine heimischen Moskitos ‚Äì die schnellen Temperaturwechsel st√∂ren ihren Lebenszyklus.'},
    {type:'fact', text:'Die ISS umkreist die Erde in ~90 Minuten ‚Äì Astronauten sehen etwa 16 Sonnenauf- und -unterg√§nge pro Tag.'},

    {type:'link', text:'https://thisissand.com/', label:'üèñÔ∏è This is Sand', desc:'Male digitale Sandbilder ‚Äì meditativ und entspannend.'},
    {type:'link', text:'https://weirdorconfusing.com/', label:'üõí Weird or Confusing', desc:'V√∂llig absurde Produkte aus dem Internet.'},
    {type:'link', text:'https://stars.chromeexperiments.com/', label:'üåå 100.000 Stars', desc:'Ein interaktiver Flug durch unsere Galaxie.'},
    {type:'link', text:'https://neal.fun/size-of-space/', label:'üöÄ Size of Space', desc:'Vergleiche interaktiv Gr√∂√üen ‚Äì vom Menschen bis zur Galaxie.'},
    {type:'link', text:'https://radio.garden/', label:'üåç Radio Garden', desc:'H√∂re Live-Radio aus jedem Winkel der Erde ‚Äì per Globus.'},
    {type:'link', text:'https://pointerpointer.com/', label:'üëÜ Pointer Pointer', desc:'Jemand zeigt immer genau auf deine Maus.'},
    {type:'link', text:'https://patatap.com/', label:'üéµ Patatap', desc:'Erstelle Musik mit der Tastatur ‚Äì jede Taste hat einen Sound.'},

    {type:'joke', text:'Warum war der Mathebuchautor ungl√ºcklich? Weil er zu viele Probleme hatte.'},
    {type:'joke', text:'Treffen sich zwei Schneeflocken ‚Äì sagt die eine: ‚ÄûIch hab das Gef√ºhl, wir treiben hier auseinander.‚Äú'},
    {type:'joke', text:'Was macht ein Pirat am Computer? ‚Äì Er dr√ºckt die Enter-Taste.'},
    {type:'joke', text:'Warum k√∂nnen Geister so schlecht l√ºgen? ‚Äì Weil man direkt durch sie hindurchsieht.'},
    {type:'joke', text:'Ein Photon checkt ins Hotel ein. Der Portier fragt: ‚ÄûHaben Sie Gep√§ck?‚Äú ‚Äì ‚ÄûNein, ich reise licht.‚Äú'},
    {type:'joke', text:'Wie nennt man einen Bumerang, der nicht zur√ºckkommt? ‚Äì Einen Stock.'},
    {type:'joke', text:'Warum war der Astronaut schlecht im Smalltalk? ‚Äì Ihm fehlte einfach die Atmosph√§re.'},
    {type:'joke', text:'Was ist das Lieblingsgetr√§nk von Programmierern? ‚Äì Java.'},
    {type:'joke', text:'Warum k√∂nnen Orangen nicht rennen? ‚Äì Weil sie ausgepresst sind.'},
    {type:'joke', text:'Was macht ein Keks unter einem Baum? ‚Äì Kr√ºmel!'},

    {type:'link',  text:'https://longdogechallenge.com/', label:'üêï Long Doge Challenge', desc:'Scrolle endlos und finde heraus, wie lang dein Doge wird.'},
    {type:'link',  text:'https://mondrianandme.com/',        label:'üé® Mondrian & Me',        desc:'Male interaktiv im Mondrian-Stil.'},
    {type:'link',  text:'https://zoomquilt.org/',            label:'üåÄ ZoomQuilt',             desc:'Ein hypnotisches, endloses Zoom-Gem√§lde.'}
  ];


  /* ===== Countdown Overlay ===== */
  function getCountdownTarget(){
    if (urlParams.has('cd')) { // ?cd=SEKUNDEN
      const sec = Math.max(1, parseInt(urlParams.get('cd'), 10) || 0);
      return new Date(Date.now() + sec * 1000);
    }
    return new Date(CONFIG.year, CONFIG.startMonth - 1, 1, 0, 0, 0);
  }

  function startCountdownOverlay(){
    const overlay = document.getElementById('countdownOverlay');
    const cdTimer  = document.getElementById('cdTimer');
    const cdText   = document.getElementById('cdText');
    if(!overlay || !cdTimer || !cdText) return;
    
    const target = getCountdownTarget();
    
    function fmt2(n){ return String(n).padStart(2,'0') }
    function parts(ms){
      const s = Math.max(0, Math.floor(ms/1000));
      const d = Math.floor(s/86400);
      const h = Math.floor((s%86400)/3600);
      const m = Math.floor((s%3600)/60);
      const c = s%60;
      return { d,h,m,c };
    }
    function render(){
      const now = getCurrentDate(); // Use sim date
      if (now >= target){
        overlay.style.display = 'none';
        overlay.setAttribute('aria-hidden','true');
        return;
      }
      const { d,h,m,c } = parts(target - now);
      cdTimer.textContent = `${d} Tage; ${fmt2(h)}:${fmt2(m)}:${fmt2(c)}`;
      cdText.innerHTML = `In <strong>${d} ${d===1?'Tag':'Tagen'}</strong> geht‚Äôs hier los in deinem pers√∂nlichen Adventskalender!`;
      overlay.style.display = 'flex';
      overlay.setAttribute('aria-hidden','false');
    }
    render();
    if (window.__cdInt) clearInterval(window.__cdInt);
    window.__cdInt = setInterval(render, 1000);
  }
  startCountdownOverlay();
  window.addEventListener('focus', startCountdownOverlay);

  /* ===== Partikel Canvas (Schnee) ===== */
  const FX = (()=>{ const cvs=document.getElementById('fx'); const ctx=cvs.getContext('2d',{alpha:true});
    const DPR=Math.min(window.devicePixelRatio||1,1.5); const MAX=200; let w=0,h=0,flakes=[],run=true,last=0;
    function resize(){ const r=cvs.getBoundingClientRect(); w=(r.width*DPR)|0; h=(r.height*DPR)|0; cvs.width=w; cvs.height=h; const n=Math.min(MAX,(w*h/45000)|0); flakes=new Array(n).fill(0).map(()=>({x:Math.random()*w,y:Math.random()*h,r:1+Math.random()*2.5*DPR,vx:(-0.12+Math.random()*0.24)*DPR,vy:(0.2+Math.random()*0.6)*DPR,a:0.3+Math.random()*0.6,tw:Math.random()*6.28})) }
    function step(ts){ if(!run) return; if(ts-last<33){ requestAnimationFrame(step); return } last=ts; ctx.clearRect(0,0,w,h);
      for(const f of flakes){ f.tw+=.01; const wob=Math.sin(f.tw)*.25*DPR; f.x+=f.vx+wob; f.y+=f.vy;
        if(f.y-f.r>h){ f.y=-f.r; f.x=Math.random()*w } if(f.x<-5*DPR){ f.x=w+5*DPR } if(f.x>w+5*DPR){ f.x=-5*DPR }
        ctx.beginPath(); ctx.globalAlpha=f.a; ctx.fillStyle='#fff'; ctx.arc(f.x,f.y,f.r,0,6.283); ctx.fill();
      } ctx.globalAlpha=1; requestAnimationFrame(step) }
    window.addEventListener('resize', ()=>{ clearTimeout(window.__t); window.__t=setTimeout(resize,150) });
    document.addEventListener('visibilitychange', ()=>{ run=!document.hidden; if(run) requestAnimationFrame(step) });
    resize(); requestAnimationFrame(step); return { stop(){run=false}, start(){run=true; requestAnimationFrame(step)} };
  })();

  /* ===== Konfetti Canvas ===== */
  const CONFETTI = (()=>{
    const cvs = document.getElementById('confetti');
    const ctx = cvs.getContext('2d');
    let particles = [];
    let w=0, h=0;
    function resize(){ w=cvs.width=window.innerWidth; h=cvs.height=window.innerHeight; }
    window.addEventListener('resize', resize); resize();
    
    function create(x,y){
      for(let i=0; i<60; i++){
        particles.push({
          x:x, y:y,
          vx:(Math.random()-0.5)*15, vy:(Math.random()-1)*15,
          c: `hsl(${Math.random()*360}, 100%, 50%)`,
          s: Math.random()*6+4,
          g: 0.4, // gravity
          l: 100 // life
        });
      }
      if(particles.length > 0 && !running) loop();
    }
    let running = false;
    function loop(){
      ctx.clearRect(0,0,w,h);
      particles.forEach(p => { p.x+=p.vx; p.y+=p.vy; p.vy+=p.g; p.l--; });
      particles = particles.filter(p => p.l > 0);
      particles.forEach(p => { ctx.fillStyle=p.c; ctx.fillRect(p.x, p.y, p.s, p.s); });
      if(particles.length > 0) requestAnimationFrame(loop);
      else running = false;
    }
    return { burst: (x,y) => { create(x,y); if(!running){ running=true; loop(); } } }
  })();


  /* ===== UI Refs ===== */
  const whoEl=document.getElementById('who'); const userBox=document.getElementById('userBox');
  const btnSignout=document.getElementById('btn-signout'); const btnHow=document.getElementById('btn-how');
  const grid=document.getElementById('grid'); const kalPanel=document.getElementById('kalPanel');
  const authPanel=document.getElementById('authPanel'); const boardPanel=document.getElementById('boardPanel'); const board=document.getElementById('board');
  const nameInp=document.getElementById('name'); const emailInp=document.getElementById('email'); const pwInp=document.getElementById('pw');
  const btnReg=document.getElementById('btn-register'); const btnLogin=document.getElementById('btn-login'); const authMsg=document.getElementById('authMsg');
  const admCode=document.getElementById('admCode'); const admMsg=document.getElementById('admMsg'); const btnVerify=document.getElementById('btnVerify'); const btnRedeem=document.getElementById('btnRedeem');
  const demoAdminHint=document.getElementById('demoAdminHint');

  /* ===== State ===== */
  let state = { opened:{}, rewards:{} };
  let unsubUser=null, unsubBoard=null, lastOpenedJSON='';

  /* ===== Service Init ===== */
  const svc = IS_DEMO ? await makeDemoService() : await makeLiveService();

  /* ===== Auth UI ===== */
  btnReg.onclick = async ()=>{
    authMsg.textContent='';
    const name=nameInp.value.trim(); const email=emailInp.value.trim(); const pw=pwInp.value;
    if(!name || !email || pw.length<6){ authMsg.textContent='Bitte Name, E-Mail, Passwort (‚â•6 Zeichen)'; return }
    try{ await svc.register(name,email,pw); authMsg.textContent='Registrierung ok'; }
    catch(e){ authMsg.textContent=e.message||String(e) }
  };
  btnLogin.onclick = async ()=>{
    authMsg.textContent='';
    const email=emailInp.value.trim(); const pw=pwInp.value;
    if(!email || !pw){ authMsg.textContent='Bitte E-Mail und Passwort eingeben'; return }
    try{ await svc.login(email,pw) } catch(e){ authMsg.textContent=e.message||String(e) }
  };
  btnSignout.onclick = ()=> svc.logout();

  /* ===== Auth Listener ===== */
  svc.onAuth(async user=>{
    if(user){
      authPanel.style.display='none'; kalPanel.style.display=''; btnSignout.style.display='';
      userBox.textContent=user.name||user.email; whoEl.textContent=user.name||'Nutzer';

      if(unsubUser) unsubUser(); if(unsubBoard) unsubBoard();

      unsubUser = await svc.onUserDoc(user.uid, data=>{
        state = data || { opened:{}, rewards:{} };
        renderGrid(user);
      });

      const admin = await svc.isAdmin(user.uid);
      const adminTools = document.getElementById('adminTools');
      if(admin){
        boardPanel.style.display=''; if(adminTools) adminTools.style.display='';
        unsubBoard = await svc.onAllUsers(qs=> renderBoard(qs));
      } else { boardPanel.style.display='none'; if(adminTools) adminTools.style.display='none' }

      const now = getCurrentDate(); 
      const isStart=(now.getMonth()+1)===CONFIG.startMonth && now.getFullYear()>=CONFIG.year;
      if(!isStart && !simDateParam) _toast('Hinweis: T√ºren sind bis zum Startmonat gesperrt');
      startCountdownOverlay();
      if(IS_DEMO){ showDemoAdminToggle(user) }
    } else {
      if(unsubUser) unsubUser(); if(unsubBoard) unsubBoard(); unsubUser=unsubBoard=null;
      authPanel.style.display=''; kalPanel.style.display='none'; boardPanel.style.display='none'; btnSignout.style.display='none'; userBox.textContent='';
      startCountdownOverlay();
    }
  });

  /* ===== Render Grid ===== */
  function today(){ const d=getCurrentDate(); return {y:d.getFullYear(), m:d.getMonth()+1, day:d.getDate()} }
  
  function renderGrid(user){
    const snapJSON = JSON.stringify(state.opened);
    if(snapJSON===lastOpenedJSON && !document.getElementById('grid').innerHTML === '') return; 
    lastOpenedJSON=snapJSON;
    
    grid.innerHTML='';
    const {y,m,day}=today(); const order=getDoorOrder(CONFIG.year);
    
    for(let i=0;i<CONFIG.days;i++){
      const n=order[i]; const btn=document.createElement('button');
      btn.className='door';
      btn.innerHTML=`<div class="emoji">${n%6===0?'üéÅ':n%5===0?'‚≠ê':n%4===0?'üïØÔ∏è':n%3===0?'‚ùÑÔ∏è':n%2===0?'üç™':'üéÑ'}</div><span class="num">${n}</span>`;
      
      const isStart=m===CONFIG.startMonth && y>=CONFIG.year;
      const lock = (!isStart ? true : n > day);
      
      if(lock) btn.classList.add('locked');
      
      const opened=!!state.opened[n];
      if(opened){
        btn.classList.add('opened');
        if(DOOR_IMAGES){ const img=document.createElement('img'); img.className='thumb'; img.alt=`T√ºrchen ${n}`; img.src=doorImagePath(n); btn.appendChild(img) }
      }
      
      const badge=document.createElement('div'); badge.className='badge'; badge.textContent=opened?'ge√∂ffnet':'geschlossen'; btn.appendChild(badge);
      
      btn.onclick=(e)=>{ 
        if(lock){ 
          playSFX('click'); 
          shakeDoor(btn); // Visuelles Feedback
          _toast('Geduld! Dieses T√ºrchen ist noch gesperrt.'); 
          return; 
        } 
        // Konfetti Position
        const rect = btn.getBoundingClientRect();
        openDoor(user,n, rect.left + rect.width/2, rect.top + rect.height/2); 
      };
      grid.appendChild(btn);
    }
  }

  function shakeDoor(el){
    el.classList.add('shake');
    setTimeout(()=>el.classList.remove('shake'), 500);
  }

  /* ===== T√ºr √∂ffnen ===== */
  async function openDoor(user, dayIndex, cx, cy){
    if(state.opened[dayIndex]){ showReward(dayIndex, state.rewards[dayIndex], user); return }
    
    // Konfetti Burst beim ersten √ñffnen
    CONFETTI.burst(cx || window.innerWidth/2, cy || window.innerHeight/2);

    const seed = hash(`${user.uid}|${CONFIG.year}|${dayIndex}`); const rng=mul32(seed); const roll=rng();
    let reward;
    if(roll < CONFIG.probabilities.mealVoucher || roll < CONFIG.probabilities.mealVoucher + CONFIG.probabilities.snackVoucher){
      const type = roll < CONFIG.probabilities.mealVoucher ? 'meal' : 'snack';
      const meta = type==='meal'
        ? { title:'Freies Mittagessen', desc:'Gutschein √ºber ein freies Essen in der Kantine; bis 4 ‚Ç¨' }
        : { title:'S√º√üigkeiten Gutschein', desc:'Leckerer Snack nach Wahl; an der Theke einl√∂sbar' };
      try{
        const nonce = randHex(12);
        const { code, token } = await svc.signVoucher({ day:dayIndex, type, nonce });
        reward = { kind:'voucher', payload:{ type, ...meta, code, token, nonce } };
        const opened = {...state.opened, [dayIndex]:true};
        const rewards = {...state.rewards, [dayIndex]: reward};
        await svc.setUserDoc(user.uid, { opened, rewards, lastUpdated:new Date().toISOString() });
        playSFX('win'); showReward(dayIndex, reward, user);
      }catch(e){
        console.error('signVoucher failed', e);
        _toast('Konnte Gutschein nicht laden; bitte sp√§ter erneut versuchen');
        return;
      }
    } else {
      const msg=getMessageFor(user, dayIndex)||{type:'quote', text:'Sch√∂nen Advent ‚Äì du machst das super!'};
      reward = { kind:'message', payload: msg };
      const opened = {...state.opened, [dayIndex]:true};
      const rewards = {...state.rewards, [dayIndex]: reward};
      await svc.setUserDoc(user.uid, { opened, rewards, lastUpdated:new Date().toISOString() });
      playSFX('open'); showReward(dayIndex, reward, user);
    }
  }

  /* ===== Reward Modal ===== */
  function showReward(dayIndex, reward, user){
    document.getElementById('modalTitle').textContent=`T√ºrchen ${dayIndex}`;
    let html='';
    const hero = DOOR_IMAGES ? `<div style="position:relative; height:180px; border-radius:12px; overflow:hidden; margin-bottom:12px; border:1px solid var(--border)"><img src="${doorImagePath(dayIndex)}" alt="T√ºrchen Bild" style="position:absolute; inset:0; width:100%; height:100%; object-fit:cover"/></div>` : '';

    if(reward.kind==='voucher'){
      const v=reward.payload;
      html += hero + `<div class="reward"><div class="icon">üéüÔ∏è</div><div><h3>${v.title}</h3><div class="muted">${v.desc}</div>
        <div class="voucher">
          <div class="line"><div class="label">Name</div><div><strong>${esc(user.name||'Nutzer')}</strong></div></div>
          <div class="line"><div class="label">Code</div><div><code>${v.code}</code></div></div>
          <div class="line"><div class="label">Typ</div><div>${v.type}</div></div>
          <div class="line"><div class="label">G√ºltig</div><div>Einmalig; intern; bis 31.12.${CONFIG.year}</div></div>
          <div class="line"><div class="label">Signatur</div><div>${signatureFor(user.uid)}</div></div>
        </div>
        <div style="display:flex; gap:10px; margin-top:12px">
          <button class="btn" onclick="window._printVoucher('${esc(v.title)}','${esc(v.desc)}','${v.code}','${v.type}','${esc(user.name||'Nutzer')}','${signatureFor(user.uid)}')">Drucken</button>
          <button class="btn" onclick="navigator.clipboard.writeText('${v.code}').then(()=>window._toast('Code kopiert'))">Code kopieren</button>
        </div></div></div>`;
    } else {
      const m = reward.payload;
      let emoji = '‚ú®', title = 'Botschaft des Tages', content = esc(m.text);
      if (m.type === 'joke') { emoji = 'üéÖ'; title = 'Witz des Tages' }
      else if (m.type === 'fact') { emoji = 'üí°'; title = 'Fakt des Tages' }
      else if (m.type === 'link') {
        emoji = 'üåê'; title = 'Zuf√§llige Website';
        const safeLabel = esc(m.label || m.text);
        const safeDesc = m.desc ? `<div style="color:var(--muted);font-size:14px;margin-top:4px">${esc(m.desc)}</div>` : '';
        content = `<a href="${m.text}" target="_blank" style="color:#6cf;font-weight:600;text-decoration:none">${safeLabel}</a>${safeDesc}`;
      }
      html += hero + `<div class="reward"><div class="icon">${emoji}</div><div><h3>${title}</h3><div>${content}</div></div></div>`;
    }
    document.getElementById('modalBody').innerHTML=html; openModal();
  }

  /* ===== Board ===== */
  function renderBoard(users){
    const rows = users.map(u=>({ name:u.name||'Nutzer', count:Object.values(u.opened||{}).filter(Boolean).length })).sort((a,b)=> b.count-a.count || a.name.localeCompare(b.name));
    let html='<table><thead><tr><th>Name</th><th>Ge√∂ffnet</th></tr></thead><tbody>';
    for(const r of rows){ html += `<tr><td>${esc(r.name)}</td><td>${r.count} / ${CONFIG.days}</td></tr>` }
    html+='</tbody></table>'; board.innerHTML=html;
  }

  /* ===== Admin Tools ===== */
  if(btnVerify) btnVerify.onclick=async ()=>{ admMsg.textContent=''; const code=(admCode.value||'').trim(); if(!code){ admMsg.textContent='Bitte Code eingeben'; return }
    try{ const res = await svc.verifyVoucher(code); if(!res.ok){ admMsg.textContent='Ung√ºltig oder unbekannt'; return } admMsg.textContent=`G√ºltig; Typ ${res.type}; Tag ${res.day}; Jahr ${res.year}; ${res.redeemed ? 'bereits eingel√∂st' : 'noch nicht eingel√∂st'}` }catch(e){ admMsg.textContent=e.message||String(e) }
  };
  if(btnRedeem) btnRedeem.onclick=async ()=>{ admMsg.textContent=''; const code=(admCode.value||'').trim(); if(!code){ admMsg.textContent='Bitte Code eingeben'; return }
    try{ const res = await svc.redeemVoucher(code); if(res.ok){ admMsg.textContent='Erfolgreich eingel√∂st' } }catch(e){ admMsg.textContent=e.message||String(e) }
  };

  function showDemoAdminToggle(user){
    if(!IS_DEMO) return;
    demoAdminHint.style.display='';
    const id='btn-demo-admin'; if(document.getElementById(id)) return;
    const b=document.createElement('button'); b.id=id; b.className='btn'; b.textContent='Mich als Admin markieren';
    b.onclick=()=>{ svc.addAdmin(user.uid); _toast('Du bist jetzt Admin') };
    document.querySelector('.bar').appendChild(b);
  }

  /* ===== Utilities ===== */
  window._printVoucher=function(title,desc,code,type,holder,sign){
    const area=document.getElementById('printArea');
    area.innerHTML=`<div class="print-card"><h2>${title}</h2><div>${desc}</div><p><strong>Inhaber: </strong>${holder}</p><p><strong>Code: </strong>${code}</p><p><strong>Typ: </strong>${type}</p><p class="small">G√ºltig bis 31.12.${CONFIG.year}; einmalig; nicht √ºbertragbar; nur intern</p><p class="small">Signatur: ${sign}</p></div>`;
    window.print();
  };
  window._toast = function(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 1600) };

  function openModal(){ 
    const b=document.getElementById('backdrop'); 
    const m=document.getElementById('modalBox');
    b.style.display='flex'; b.setAttribute('aria-hidden','false');
    setTimeout(()=>m.classList.add('active'), 10);
  }
  document.getElementById('closeModal').onclick=()=>{ 
    const b=document.getElementById('backdrop'); 
    const m=document.getElementById('modalBox');
    m.classList.remove('active');
    setTimeout(()=>{ b.style.display='none'; b.setAttribute('aria-hidden','true') }, 200);
  };

  function randHex(n){ const a=new Uint8Array(n); crypto.getRandomValues(a); return Array.from(a,x=>x.toString(16).padStart(2,'0')).join('') }
  function mul32(a){ return function(){ let t=a+=0x6D2B79F5; t=Math.imul(t^t>>>15,t|1); t^=t+Math.imul(t^t>>>7,t|61); return ((t^t>>>14)>>>0)/4294967296 } }
  function hash(s){ let h=0; for(let i=0;i<s.length;i++){ h=((h<<5)-h)+s.charCodeAt(i); h|=0 } return h>>>0 }

  function shuffledMessagesFor(user){
    const seed = hash(`${user.uid}|${CONFIG.year}|MSGPOOL`);
    const rng = mul32(seed);
    const arr = MESSAGES.slice(); 
    for(let i = arr.length - 1; i > 0; i--){
      const j = Math.floor(rng() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  function getMessageFor(user, dayIndex){
    const pool = shuffledMessagesFor(user);
    const idx = (dayIndex - 1) % pool.length;
    return pool[idx];
  }

  function esc(s){ return String(s).replace(/[&<>"']/g, m => ({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])) }
  function signatureFor(uid){ const id = Math.abs((uid.split('').reduce((a,c)=>((a<<5)-a+c.charCodeAt(0))|0,0)))%10000; return `SIG-${id.toString().padStart(4,'0')}` }
  function playSFX(kind){ const list=CONFIG.sfx[kind]||[]; if(!list.length) return; const url=list[(Math.random()*list.length)|0]; const a=new Audio(url); a.volume=.9; a.play().catch(()=>{}) }
  function doorImagePath(day){ const n=String(day).padStart(2,'0'); return `assets/doors/${n}.jpg` }
  function getDoorOrder(seedYear){ const arr=Array.from({length:CONFIG.days},(_,i)=>i+1); let s=hash(String(seedYear)); for(let i=arr.length-1;i>0;i--){ s=(s*9301+49297)%233280; const r=s/233280; const j=(r*(i+1))|0; [arr[i],arr[j]]=[arr[j],arr[i]] } return arr }

  btnHow.onclick=()=>{ const body=`<div class="muted">Hinweise</div><ul>
    <li>DEMO-Modus speichert lokal; LIVE nutzt Firebase</li>
    <li>${(CONFIG.probabilities.mealVoucher*100).toFixed(2)} % Essen; ${(CONFIG.probabilities.snackVoucher*100).toFixed(2)} % Snack</li>
    <li>Admin kann Codes pr√ºfen & einl√∂sen</li>
    <li><strong>Debugging:</strong> H√§nge <code>?sim_date=2025-12-10</code> an die URL, um ein Datum zu simulieren.</li>
    </ul>`;
    document.getElementById('modalBody').innerHTML=body; document.getElementById('modalTitle').textContent='Info'; openModal();
  };

  /* ===== DEMO Service ===== */
  async function makeDemoService(){
    const NS='adv_demo_v1';
    const store = { get(k){ return JSON.parse(localStorage.getItem(NS+':'+k)||'null') }, set(k,v){ localStorage.setItem(NS+':'+k, JSON.stringify(v)) } };
    const secret='DEMO_SECRET_please_change_locally';
    async function hmac(payload){
      const enc=new TextEncoder();
      const key=await crypto.subtle.importKey('raw', enc.encode(secret), {name:'HMAC', hash:'SHA-256'}, false, ['sign']);
      const sig=await crypto.subtle.sign('HMAC', key, enc.encode(payload));
      const b= btoa(String.fromCharCode(...new Uint8Array(sig))).replace(/=+/g,'').replace(/\+/g,'A').replace(/\//g,'B');
      return b.slice(0,12);
    }
    const listeners = { auth:[] }; function emitAuth(u){ listeners.auth.forEach(fn=>fn(u)) }

    return {
      async register(name,email,pw){
        const users=store.get('users')||{}; if(users[email]) throw new Error('E-Mail bereits registriert');
        const uid='u_'+hash(email); users[email]={ uid, email, pw, name }; store.set('users', users); store.set('session', { uid });
        const doc=store.get('doc:'+uid) || { name, opened:{}, rewards:{} }; store.set('doc:'+uid, doc); emitAuth({ uid, email, name }); return true;
      },
      async login(email,pw){
        const users=store.get('users')||{}; const u=users[email]; if(!u) throw new Error('Kein Konto gefunden'); if(u.pw!==pw) throw new Error('Passwort falsch');
        store.set('session', { uid:u.uid }); emitAuth({ uid:u.uid, email:u.email, name:u.name }); return true;
      },
      async logout(){ store.set('session', null); emitAuth(null) },
      onAuth(cb){ listeners.auth.push(cb); const s=store.get('session'); if(s){ const users=store.get('users')||{}; const U=Object.values(users).find(x=>x.uid===s.uid); if(U) cb({ uid:U.uid, email:U.email, name:U.name }) } else cb(null) },
      async onUserDoc(uid, cb){ const fire=()=> cb(store.get('doc:'+uid) || { opened:{}, rewards:{} }); fire(); const t=setInterval(fire, 500); return ()=> clearInterval(t) },
      async setUserDoc(uid, data){ const old=store.get('doc:'+uid)||{}; const merged={...old, ...data}; store.set('doc:'+uid, merged) },
      async onAllUsers(cb){ const tick=()=>{ const users=store.get('users')||{}; const list=Object.values(users).map(u=>{ const d=store.get('doc:'+u.uid)||{}; return { name:d.name||u.name||u.email, opened:d.opened||{}, uid:u.uid } }); cb(list) }; tick(); const t=setInterval(tick, 1000); return ()=> clearInterval(t) },
      async isAdmin(uid){ const admins=store.get('admins')||{}; return !!admins[uid] },
      addAdmin(uid){ const admins=store.get('admins')||{}; admins[uid]=true; store.set('admins', admins) },
      async signVoucher({ day, type, nonce }){ const sess=store.get('session'); if(!sess) throw new Error('Login erforderlich');
        const payload=`${sess.uid}|${CONFIG.year}|${day}|${type}|${nonce}`; const token=await hmac(payload);
        const code=`${type.toUpperCase().slice(0,1)}-${String(day).padStart(2,'0')}-${token}-DEMO`;
        const vouchers=store.get('vouchers')||{}; vouchers[code]={ uid:sess.uid, day, type, token, nonce, year:CONFIG.year, redeemed:false }; store.set('vouchers', vouchers);
        return { code, token };
      },
      async verifyVoucher(code){ const vouchers=store.get('vouchers')||{}; const v=vouchers[code]; if(!v) return { ok:false, reason:'not-found' };
        const token=await (async()=>{ const payload=`${v.uid}|${v.year}|${v.day}|${v.type}|${v.nonce}`; return await hmac(payload) })(); return { ok: token===v.token, redeemed: !!v.redeemed, uid:v.uid, day:v.day, type:v.type, year:v.year };
      },
      async redeemVoucher(code){ const vouchers=store.get('vouchers')||{}; const v=vouchers[code]; if(!v) throw new Error('Unbekannter Code');
        const chk=await this.verifyVoucher(code); if(!chk.ok) throw new Error('Ung√ºltige Signatur'); if(v.redeemed) throw new Error('Bereits eingel√∂st');
        v.redeemed=true; v.redeemedAt=Date.now(); vouchers[code]=v; store.set('vouchers', vouchers);
        const doc=store.get('doc:'+v.uid)||{opened:{},rewards:{}}; if(doc.rewards && doc.rewards[v.day] && doc.rewards[v.day].payload){ doc.rewards[v.day].payload.redeemed=true; doc.rewards[v.day].payload.redeemedAt=new Date().toISOString(); store.set('doc:'+v.uid, doc) }
        return { ok:true };
      }
    };
  }

  /* ===== LIVE Service (Firebase) ===== */
  async function makeLiveService(){
    const firebaseConfig = {
      apiKey: "AIzaSyCB9fyO8mS1pgSZFYJVjcTXGHk9hGQmpU4",
      authDomain: "geburt-ded5c.firebaseapp.com",
      projectId: "geburt-ded5c",
      storageBucket: "geburt-ded5c.firebasestorage.app",
      messagingSenderId: "528584992005",
      appId: "1:528584992005:web:14dea3f914a432e317c36c",
      measurementId: "G-SX8G2KPVL8"
    };

    const { initializeApp } = await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js');
    const authMod = await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js');
    const fsMod   = await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js');
    const fnMod   = await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-functions.js');

    const app = initializeApp(firebaseConfig);
    const AUTH = authMod.getAuth(app);
    const DB   = fsMod.getFirestore(app);
    const FUN  = fnMod.getFunctions(app, 'europe-west1');

    try{ await authMod.setPersistence(AUTH, authMod.browserLocalPersistence) }catch(e){}

    const signCallable    = fnMod.httpsCallable(FUN, 'signVoucher');
    const verifyCallable = fnMod.httpsCallable(FUN, 'verifyVoucher');
    const redeemCallable = fnMod.httpsCallable(FUN, 'redeemVoucher');

    const FALLBACK_SECRET = 'LOCAL_FALLBACK_ONLY_FOR_TESTS';
    async function localHmac(payload){
      const enc=new TextEncoder();
      const key=await crypto.subtle.importKey('raw', enc.encode(FALLBACK_SECRET), {name:'HMAC', hash:'SHA-256'}, false, ['sign']);
      const sig=await crypto.subtle.sign('HMAC', key, enc.encode(payload));
      const b= btoa(String.fromCharCode(...new Uint8Array(sig))).replace(/=+/g,'').replace(/\+/g,'A').replace(/\//g,'B');
      return b.slice(0,12);
    }
    function isCorsOrInternal(err){
      const msg = (err && (err.message||err.code||String(err))) || '';
      return msg.includes('internal') || msg.includes('CORS') || msg.includes('Failed to fetch') || msg.includes('net::ERR');
    }

    return {
      async register(name,email,pw){
        const cred = await authMod.createUserWithEmailAndPassword(AUTH, email, pw);
        await authMod.updateProfile(cred.user, { displayName:name });
        const uref = fsMod.doc(DB, 'adv_users', cred.user.uid);
        await fsMod.setDoc(uref, { name, opened:{}, rewards:{}, lastUpdated:new Date().toISOString() });
        return true;
      },
      async login(email,pw){ await authMod.signInWithEmailAndPassword(AUTH, email, pw); return true },
      async logout(){ await authMod.signOut(AUTH) },
      onAuth(cb){ return authMod.onAuthStateChanged(AUTH, u=> cb(u?{ uid:u.uid, email:u.email, name:u.displayName }:null)) },
      async onUserDoc(uid, cb){ const ref=fsMod.doc(DB,'adv_users',uid); return fsMod.onSnapshot(ref, s=> cb(s.data()||{opened:{},rewards:{}})) },
      async setUserDoc(uid, data){ const ref=fsMod.doc(DB,'adv_users',uid); await fsMod.updateDoc(ref, data) },
      async onAllUsers(cb){ const q=fsMod.query(fsMod.collection(DB,'adv_users')); return fsMod.onSnapshot(q, qs=> cb(qs.docs.map(d=> ({ uid:d.id, ...(d.data()||{}) })))) },
      async isAdmin(uid){ const s=await fsMod.getDoc(fsMod.doc(DB,'adv_admins',uid)); return s.exists() },
      addAdmin(){},

      async signVoucher({ day, type, nonce }){
        try{
          const res = await signCallable({ day, type, nonce });
          return res.data; 
        }catch(e){
          if(!isCorsOrInternal(e)) throw e;
          const user = AUTH.currentUser;
          if(!user) throw new Error('Login erforderlich');
          const payload = `${user.uid}|${CONFIG.year}|${day}|${type}|${nonce}`;
          const token = await localHmac(payload);
          const code  = `${type.toUpperCase().slice(0,1)}-${String(day).padStart(2,'0')}-${token}-TEST`;
          console.warn('[Voucher] Cloud Function nicht erreichbar ‚Äì lokaler TEST-Code erzeugt:', code);
          return { code, token, _fallback:true };
        }
      },
      async verifyVoucher(code){
        try{
          const res = await verifyCallable({ code });
          return res.data;
        }catch(e){
          if(isCorsOrInternal(e)) return { ok:false, reason:'unavailable', note:'Server nicht erreichbar (CORS). TEST-Codes k√∂nnen lokal nicht serverseitig gepr√ºft werden.' };
          throw e;
        }
      },
      async redeemVoucher(code){
        try{
          const res = await redeemCallable({ code });
          return res.data;
        }catch(e){
          if(isCorsOrInternal(e)) return { ok:false, reason:'unavailable', note:'Server nicht erreichbar (CORS). Einl√∂sen im TEST-Modus nicht m√∂glich.' };
          throw e;
        }
      }
    };
  }
  </script>
</body>
</html>
